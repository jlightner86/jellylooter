<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>JellyLooter</title>
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/jlightner86/jellylooter/main/icon.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --jf-primary: #00a4dc;
            --jf-primary-dark: #0086b3;
            --jf-primary-light: #33b5e5;
            --jf-success: #4caf50;
            --jf-warning: #ff9800;
            --jf-error: #f44336;
            --jf-purple: #aa5cc3;
            --jf-gradient: linear-gradient(135deg, #00a4dc 0%, #aa5cc3 100%);
            --radius: 8px;
            --radius-lg: 12px;
            --shadow: 0 4px 24px rgba(0, 0, 0, 0.4);
            --transition: all 0.2s ease;
        }
        [data-theme="dark"] {
            --jf-bg-dark: #101010;
            --jf-bg-card: #1a1a1a;
            --jf-bg-card-hover: #242424;
            --jf-bg-input: #2a2a2a;
            --jf-text: #ffffff;
            --jf-text-muted: #888888;
            --jf-text-dim: #666666;
            --jf-border: #333333;
            --jf-header-bg: rgba(0,164,220,0.15);
        }
        [data-theme="light"] {
            --jf-bg-dark: #f5f5f5;
            --jf-bg-card: #ffffff;
            --jf-bg-card-hover: #f0f0f0;
            --jf-bg-input: #e8e8e8;
            --jf-text: #1a1a1a;
            --jf-text-muted: #666666;
            --jf-text-dim: #888888;
            --jf-border: #dddddd;
            --jf-header-bg: rgba(0,164,220,0.1);
            --shadow: 0 4px 24px rgba(0, 0, 0, 0.1);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Quicksand', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--jf-bg-dark);
            color: var(--jf-text);
            min-height: 100vh;
            line-height: 1.5;
        }
        /* Header - Mobile First */
        .header {
            background: linear-gradient(180deg, var(--jf-header-bg) 0%, transparent 100%);
            border-bottom: 1px solid var(--jf-border);
            padding: 0.75rem 1rem;
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(20px);
        }
        @media (min-width: 768px) { .header { padding: 1rem 2rem; } }
        .header-content {
            max-width: 1600px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.5rem;
        }
        .logo { display: flex; align-items: center; gap: 0.5rem; }
        .logo-icon { width: 32px; height: 32px; border-radius: var(--radius); }
        @media (min-width: 768px) { .logo-icon { width: 40px; height: 40px; } }
        .logo-text {
            font-size: 1.25rem;
            font-weight: 700;
            background: var(--jf-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        @media (min-width: 768px) { .logo-text { font-size: 1.5rem; } }
        .header-actions { display: flex; align-items: center; gap: 0.5rem; }
        /* Tabs */
        .tabs {
            display: flex;
            gap: 0.25rem;
            padding: 0.5rem 1rem;
            border-bottom: 1px solid var(--jf-border);
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }
        .tabs::-webkit-scrollbar { display: none; }
        @media (min-width: 768px) { .tabs { padding: 0.5rem 2rem; gap: 0.5rem; } }
        .tab {
            padding: 0.625rem 1rem;
            background: transparent;
            border: none;
            border-radius: var(--radius);
            color: var(--jf-text-muted);
            font-family: inherit;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            white-space: nowrap;
            flex-shrink: 0;
        }
        .tab:hover { color: var(--jf-text); background: var(--jf-bg-card); }
        .tab.active { color: var(--jf-primary); background: rgba(0, 164, 220, 0.1); }
        /* Main */
        .main { max-width: 1600px; margin: 0 auto; padding: 1rem; }
        @media (min-width: 768px) { .main { padding: 1.5rem 2rem; } }
        /* Cards */
        .card {
            background: var(--jf-bg-card);
            border: 1px solid var(--jf-border);
            border-radius: var(--radius-lg);
            padding: 1rem;
            margin-bottom: 1rem;
        }
        @media (min-width: 768px) { .card { padding: 1.5rem; margin-bottom: 1.5rem; } }
        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        .card-title { font-size: 1rem; font-weight: 700; }
        @media (min-width: 768px) { .card-title { font-size: 1.125rem; } }
        /* Buttons */
        .btn {
            padding: 0.5rem 1rem;
            background: var(--jf-bg-input);
            border: 1px solid var(--jf-border);
            border-radius: var(--radius);
            color: var(--jf-text);
            font-family: inherit;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.375rem;
            white-space: nowrap;
        }
        .btn:hover { background: var(--jf-bg-card-hover); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background: var(--jf-gradient); border: none; color: white; }
        .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,164,220,0.4); }
        .btn-success { background: var(--jf-success); border-color: var(--jf-success); color: white; }
        .btn-danger { background: var(--jf-error); border-color: var(--jf-error); color: white; }
        .btn-warning { background: var(--jf-warning); border-color: var(--jf-warning); color: white; }
        .btn-icon { padding: 0.5rem; min-width: 36px; min-height: 36px; }
        .btn-sm { padding: 0.375rem 0.75rem; font-size: 0.8125rem; }
        /* Browser Controls */
        .browser-controls { display: flex; flex-direction: column; gap: 0.75rem; margin-bottom: 1rem; }
        @media (min-width: 768px) { .browser-controls { flex-direction: row; align-items: center; } }
        .server-select-group { display: flex; gap: 0.5rem; flex: 1; min-width: 0; }
        .view-controls { display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap; }
        .view-toggle { display: flex; background: var(--jf-bg-input); border-radius: var(--radius); overflow: hidden; }
        .view-toggle-btn {
            padding: 0.5rem 0.75rem;
            background: transparent;
            border: none;
            color: var(--jf-text-muted);
            cursor: pointer;
            transition: var(--transition);
        }
        .view-toggle-btn.active { background: var(--jf-primary); color: white; }
        /* Select */
        select {
            padding: 0.625rem 2rem 0.625rem 0.875rem;
            background: var(--jf-bg-input);
            border: 1px solid var(--jf-border);
            border-radius: var(--radius);
            color: var(--jf-text);
            font-family: inherit;
            font-size: 0.875rem;
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%23888' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10l-5 5z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            flex: 1;
            min-width: 0;
        }
        /* Media Grid */
        .media-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 0.75rem;
        }
        @media (min-width: 768px) {
            .media-grid { grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 1rem; }
        }
        .media-item {
            background: var(--jf-bg-input);
            border-radius: var(--radius);
            overflow: hidden;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
        }
        .media-item:hover { transform: translateY(-2px); box-shadow: var(--shadow); }
        .media-item.selected { outline: 3px solid var(--jf-primary); outline-offset: -3px; }
        .media-item.exists { opacity: 0.6; }
        .media-poster {
            aspect-ratio: 2/3;
            background: var(--jf-bg-card);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: var(--jf-text-dim);
        }
        .media-poster img { width: 100%; height: 100%; object-fit: cover; }
        .media-info { padding: 0.5rem; }
        .media-title {
            font-size: 0.75rem;
            font-weight: 600;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        @media (min-width: 768px) { .media-title { font-size: 0.8125rem; } }
        .media-type { font-size: 0.6875rem; color: var(--jf-text-muted); }
        .media-badge {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            padding: 0.25rem 0.5rem;
            background: var(--jf-success);
            border-radius: 4px;
            font-size: 0.625rem;
            font-weight: 700;
            color: white;
        }
        /* List View */
        .media-list { display: flex; flex-direction: column; gap: 0.5rem; }
        .media-list-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            background: var(--jf-bg-input);
            border-radius: var(--radius);
            cursor: pointer;
            transition: var(--transition);
        }
        .media-list-item:hover { background: var(--jf-bg-card-hover); }
        .media-list-item.selected { outline: 2px solid var(--jf-primary); }
        .media-list-item.exists { opacity: 0.6; }
        .media-list-thumb {
            width: 40px;
            height: 60px;
            background: var(--jf-bg-card);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            overflow: hidden;
        }
        .media-list-thumb img { width: 100%; height: 100%; object-fit: cover; }
        .media-list-info { flex: 1; min-width: 0; }
        .media-list-title { font-weight: 600; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .media-list-meta { font-size: 0.75rem; color: var(--jf-text-muted); }
        .media-list-badge {
            padding: 0.25rem 0.5rem;
            background: var(--jf-success);
            border-radius: 4px;
            font-size: 0.625rem;
            font-weight: 700;
            color: white;
            flex-shrink: 0;
        }
        /* Pagination */
        .pagination {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 1rem 0;
            flex-wrap: wrap;
        }
        .pagination-info {
            font-size: 0.875rem;
            color: var(--jf-text-muted);
            text-align: center;
            width: 100%;
            margin-bottom: 0.5rem;
        }
        @media (min-width: 768px) { .pagination-info { width: auto; margin-bottom: 0; margin-right: 1rem; } }
        .page-btn {
            padding: 0.5rem 0.75rem;
            background: var(--jf-bg-input);
            border: 1px solid var(--jf-border);
            border-radius: var(--radius);
            color: var(--jf-text);
            font-family: inherit;
            font-size: 0.875rem;
            cursor: pointer;
            transition: var(--transition);
            min-width: 40px;
        }
        .page-btn:hover:not(:disabled) { background: var(--jf-bg-card-hover); }
        .page-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .page-btn.active { background: var(--jf-primary); border-color: var(--jf-primary); color: white; }
        /* Selection Bar */
        .selection-bar {
            display: none;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 1rem;
            background: var(--jf-primary);
            border-radius: var(--radius);
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        .selection-bar.active { display: flex; }
        .selection-bar-text { font-weight: 600; color: white; }
        .selection-bar-actions { display: flex; gap: 0.5rem; }
        /* Downloads */
        .download-item {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            padding: 0.75rem;
            background: var(--jf-bg-input);
            border-radius: var(--radius);
            margin-bottom: 0.5rem;
        }
        @media (min-width: 768px) { .download-item { flex-direction: row; align-items: center; } }
        .download-info { flex: 1; min-width: 0; }
        .download-name {
            font-weight: 600;
            font-size: 0.875rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .download-status { font-size: 0.75rem; color: var(--jf-text-muted); }
        .download-progress {
            height: 4px;
            background: var(--jf-border);
            border-radius: 2px;
            overflow: hidden;
            width: 100%;
        }
        @media (min-width: 768px) { .download-progress { width: 200px; flex-shrink: 0; } }
        .download-progress-fill { height: 100%; background: var(--jf-gradient); transition: width 0.3s; }
        .download-actions { display: flex; gap: 0.5rem; flex-shrink: 0; }
        /* Log */
        .log-container {
            background: var(--jf-bg-input);
            border-radius: var(--radius);
            padding: 0.75rem;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.6875rem;
            max-height: 200px;
            overflow-y: auto;
        }
        @media (min-width: 768px) { .log-container { font-size: 0.75rem; max-height: 300px; } }
        .log-line { padding: 0.125rem 0; color: var(--jf-text-muted); word-break: break-all; }
        /* Form */
        .form-group { margin-bottom: 1rem; }
        .form-label {
            display: block;
            font-size: 0.8125rem;
            font-weight: 600;
            color: var(--jf-text-muted);
            margin-bottom: 0.375rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .form-input {
            width: 100%;
            padding: 0.625rem 0.875rem;
            background: var(--jf-bg-input);
            border: 1px solid var(--jf-border);
            border-radius: var(--radius);
            color: var(--jf-text);
            font-family: inherit;
            font-size: 0.875rem;
        }
        .form-input:focus { outline: none; border-color: var(--jf-primary); box-shadow: 0 0 0 3px rgba(0,164,220,0.15); }
        /* Toggle */
        .toggle-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--jf-border);
            gap: 1rem;
        }
        .toggle-info { flex: 1; min-width: 0; }
        .toggle-title { font-weight: 600; font-size: 0.875rem; }
        .toggle-desc { font-size: 0.75rem; color: var(--jf-text-muted); }
        .toggle-switch { position: relative; width: 48px; height: 26px; flex-shrink: 0; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background: var(--jf-border);
            border-radius: 26px;
            transition: var(--transition);
        }
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background: white;
            border-radius: 50%;
            transition: var(--transition);
        }
        .toggle-switch input:checked + .toggle-slider { background: var(--jf-primary); }
        .toggle-switch input:checked + .toggle-slider:before { transform: translateX(22px); }
        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        .modal-overlay.active { display: flex; }
        .modal {
            background: var(--jf-bg-card);
            border: 1px solid var(--jf-border);
            border-radius: var(--radius-lg);
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            border-bottom: 1px solid var(--jf-border);
        }
        .modal-title { font-size: 1.125rem; font-weight: 700; }
        .modal-close {
            background: none;
            border: none;
            color: var(--jf-text-muted);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }
        .modal-close:hover { color: var(--jf-text); }
        .modal-body { padding: 1rem; overflow-y: auto; flex: 1; }
        .modal-footer {
            padding: 1rem;
            border-top: 1px solid var(--jf-border);
            display: flex;
            gap: 0.75rem;
            justify-content: flex-end;
        }
        /* Tooltip - Fixed z-index */
        [data-tooltip] { position: relative; }
        [data-tooltip]::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: calc(100% + 8px);
            left: 50%;
            transform: translateX(-50%);
            padding: 0.375rem 0.75rem;
            background: var(--jf-text);
            color: var(--jf-bg-dark);
            font-size: 0.75rem;
            font-weight: 500;
            border-radius: 4px;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition);
            pointer-events: none;
            z-index: 200;
        }
        [data-tooltip]:hover::after { opacity: 1; visibility: visible; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        /* Settings */
        .settings-grid { display: grid; gap: 1rem; }
        @media (min-width: 768px) { .settings-grid { grid-template-columns: repeat(2, 1fr); } }
        .settings-section { margin-bottom: 1.5rem; }
        .settings-section-title { font-size: 1rem; font-weight: 700; margin-bottom: 0.75rem; color: var(--jf-primary); }
        /* Server List */
        .server-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            background: var(--jf-bg-input);
            border-radius: var(--radius);
            margin-bottom: 0.5rem;
        }
        .server-icon {
            width: 36px;
            height: 36px;
            background: var(--jf-gradient);
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .server-info { flex: 1; min-width: 0; }
        .server-name { font-weight: 600; font-size: 0.875rem; }
        .server-url { font-size: 0.75rem; color: var(--jf-text-muted); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        /* Breadcrumb */
        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
            font-size: 0.875rem;
            flex-wrap: wrap;
        }
        .breadcrumb-item { color: var(--jf-text-muted); cursor: pointer; }
        .breadcrumb-item:hover { color: var(--jf-primary); }
        .breadcrumb-sep { color: var(--jf-text-dim); }
        .breadcrumb-current { color: var(--jf-text); font-weight: 600; }
        /* Toast */
        .toast-container {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            max-width: calc(100vw - 2rem);
        }
        .toast {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1rem;
            background: var(--jf-bg-card);
            border: 1px solid var(--jf-border);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            font-size: 0.875rem;
            animation: slideIn 0.3s ease;
        }
        .toast.success { border-left: 3px solid var(--jf-success); }
        .toast.error { border-left: 3px solid var(--jf-error); }
        .toast.warning { border-left: 3px solid var(--jf-warning); }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        /* Empty State */
        .empty-state { text-align: center; padding: 2rem; color: var(--jf-text-muted); }
        .empty-state-icon { font-size: 3rem; margin-bottom: 1rem; opacity: 0.3; }
        .empty-state-title { font-size: 1rem; font-weight: 600; margin-bottom: 0.5rem; color: var(--jf-text); }
        /* Folder Browser */
        .folder-list { max-height: 300px; overflow-y: auto; }
        .folder-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.625rem 0.75rem;
            cursor: pointer;
            border-radius: var(--radius);
            transition: var(--transition);
        }
        .folder-item:hover { background: var(--jf-bg-input); }
        .folder-item.selected { background: rgba(0,164,220,0.2); }
        .space-info {
            padding: 0.75rem;
            background: var(--jf-bg-input);
            border-radius: var(--radius);
            margin-top: 1rem;
            font-size: 0.875rem;
        }
        /* Scan Progress */
        .scan-progress { padding: 1rem; background: var(--jf-bg-input); border-radius: var(--radius); margin-bottom: 1rem; }
        .scan-progress-header { display: flex; justify-content: space-between; margin-bottom: 0.5rem; font-size: 0.875rem; }
        .scan-progress-bar { height: 6px; background: var(--jf-border); border-radius: 3px; overflow: hidden; }
        .scan-progress-fill { height: 100%; background: var(--jf-gradient); transition: width 0.3s; }
        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--jf-border); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--jf-text-dim); }
        /* Hide on mobile */
        .hide-mobile { display: none; }
        @media (min-width: 768px) { .hide-mobile { display: flex; } }
        .show-mobile { display: flex; }
        @media (min-width: 768px) { .show-mobile { display: none; } }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <img src="https://raw.githubusercontent.com/jlightner86/jellylooter/main/icon.png" alt="JellyLooter" class="logo-icon">
                <span class="logo-text">JellyLooter</span>
            </div>
            <div class="header-actions">
                <button class="btn btn-icon" onclick="toggleTheme()" data-tooltip="Toggle Theme">üåô</button>
                <a href="/help" class="btn btn-sm hide-mobile">Help</a>
                <a href="/logout" class="btn btn-sm">Logout</a>
            </div>
        </div>
    </header>

    <nav class="tabs">
        <button class="tab active" data-tab="browse">üìÅ Browse</button>
        <button class="tab" data-tab="downloads">‚¨áÔ∏è Downloads</button>
        <button class="tab" data-tab="settings">‚öôÔ∏è Settings</button>
    </nav>

    <main class="main">
        <!-- Browse Tab -->
        <div id="tab-browse" class="tab-content active">
            <div class="card">
                <div class="browser-controls">
                    <div class="server-select-group">
                        <select id="server-select" onchange="onServerChange()">
                            <option value="">Select Server...</option>
                        </select>
                        <button class="btn btn-icon" onclick="refreshLibrary()" data-tooltip="Refresh">üîÑ</button>
                    </div>
                    <div class="view-controls">
                        <div class="view-toggle">
                            <button class="view-toggle-btn active" data-view="grid" onclick="setViewMode('grid')">‚ñ¶</button>
                            <button class="view-toggle-btn" data-view="list" onclick="setViewMode('list')">‚ò∞</button>
                        </div>
                        <select id="items-per-page" onchange="onItemsPerPageChange()">
                            <option value="25">25</option>
                            <option value="50" selected>50</option>
                            <option value="100">100</option>
                        </select>
                    </div>
                </div>

                <div class="breadcrumb" id="breadcrumb"></div>

                <div class="selection-bar" id="selection-bar">
                    <span class="selection-bar-text"><span id="selection-count">0</span> items selected</span>
                    <div class="selection-bar-actions">
                        <button class="btn btn-sm" onclick="clearSelection()">Clear</button>
                        <button class="btn btn-sm btn-primary" onclick="downloadSelected()">Download</button>
                    </div>
                </div>

                <div id="media-container"></div>

                <div class="pagination" id="pagination"></div>
            </div>
        </div>

        <!-- Downloads Tab -->
        <div id="tab-downloads" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Active Downloads</h2>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-sm" id="pause-btn" onclick="togglePause()">‚è∏Ô∏è Pause</button>
                        <button class="btn btn-sm btn-danger" onclick="cancelAll()">‚úó Cancel All</button>
                    </div>
                </div>
                <div id="active-downloads"></div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Queue</h2>
                    <span class="badge" id="queue-count">0 pending</span>
                </div>
                <div id="pending-downloads"></div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Activity Log</h2>
                </div>
                <div class="log-container" id="log-container"></div>
            </div>
        </div>

        <!-- Settings Tab -->
        <div id="tab-settings" class="tab-content">
            <div class="settings-grid">
                <div class="card">
                    <h3 class="settings-section-title">Remote Servers</h3>
                    <div id="settings-server-list"></div>
                    <button class="btn btn-primary" style="margin-top: 1rem;" onclick="openModal('server-modal')">+ Add Server</button>
                </div>

                <div class="card">
                    <h3 class="settings-section-title">Local Server (Duplicate Detection)</h3>
                    <div id="local-server-info"></div>
                    <div id="cache-info" style="margin-top: 1rem;"></div>
                </div>

                <div class="card">
                    <h3 class="settings-section-title">General</h3>
                    <div class="toggle-row">
                        <div class="toggle-info">
                            <div class="toggle-title">Enable Authentication</div>
                            <div class="toggle-desc">Require login to access JellyLooter</div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="auth-enabled" onchange="saveSettings()">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="form-group" style="margin-top: 1rem;">
                        <label class="form-label">Language</label>
                        <select id="language-select" class="form-input" onchange="saveSettings()">
                            <option value="en">English</option>
                            <option value="es">Espa√±ol</option>
                            <option value="de">Deutsch</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Items Per Page</label>
                        <select id="settings-items-per-page" class="form-input" onchange="saveSettings()">
                            <option value="25">25</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Default View Mode</label>
                        <select id="settings-view-mode" class="form-input" onchange="saveSettings()">
                            <option value="grid">Grid</option>
                            <option value="list">List</option>
                        </select>
                    </div>
                </div>

                <div class="card">
                    <h3 class="settings-section-title">Downloads</h3>
                    <div class="form-group">
                        <label class="form-label">Speed Limit (KB/s, 0 = unlimited)</label>
                        <input type="number" id="speed-limit" class="form-input" value="0" min="0" onchange="saveSettings()">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Max Concurrent Downloads</label>
                        <select id="max-downloads" class="form-input" onchange="saveSettings()">
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="5">5</option>
                            <option value="10">10</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Download Order</label>
                        <select id="download-order" class="form-input" onchange="saveSettings()">
                            <option value="library">Library Order</option>
                            <option value="show_complete">Complete Shows First</option>
                            <option value="season_round">Season Round Robin</option>
                            <option value="episode_round">Episode Round Robin</option>
                            <option value="alphabetical">Alphabetical</option>
                            <option value="random">Random</option>
                        </select>
                    </div>
                    <div class="toggle-row">
                        <div class="toggle-info">
                            <div class="toggle-title">Dark Theme</div>
                            <div class="toggle-desc">Use dark color scheme</div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="theme-toggle-settings" checked onchange="toggleTheme()">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modals -->
    <div class="modal-overlay" id="server-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Add Remote Server</h3>
                <button class="modal-close" onclick="closeModal('server-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Server Name</label>
                    <input type="text" id="new-server-name" class="form-input" placeholder="My Jellyfin Server">
                </div>
                <div class="form-group">
                    <label class="form-label">Server URL</label>
                    <input type="text" id="new-server-url" class="form-input" placeholder="http://192.168.1.100:8096">
                </div>
                <div class="form-group">
                    <label class="form-label">API Key (or leave blank for username/password)</label>
                    <input type="text" id="new-server-key" class="form-input" placeholder="API Key">
                </div>
                <div class="form-group">
                    <label class="form-label">Username (optional)</label>
                    <input type="text" id="new-server-user" class="form-input" placeholder="Username">
                </div>
                <div class="form-group">
                    <label class="form-label">Password (optional)</label>
                    <input type="password" id="new-server-pass" class="form-input" placeholder="Password">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('server-modal')">Cancel</button>
                <button class="btn btn-primary" onclick="testAndAddServer()">Test & Add</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="local-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Configure Local Server</h3>
                <button class="modal-close" onclick="closeModal('local-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 1rem; color: var(--jf-text-muted); font-size: 0.875rem;">
                    Configure your local Jellyfin/Emby server to enable duplicate detection.
                </p>
                <div class="form-group">
                    <label class="form-label">Server URL</label>
                    <input type="text" id="local-server-url" class="form-input" placeholder="http://192.168.1.100:8096">
                </div>
                <div class="form-group">
                    <label class="form-label">API Key</label>
                    <input type="text" id="local-server-key" class="form-input" placeholder="API Key">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('local-modal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveLocalServer()">Save & Scan</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="download-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Select Download Location</h3>
                <button class="modal-close" onclick="closeModal('download-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div id="current-path" style="margin-bottom: 0.75rem; font-weight: 600;"></div>
                <div class="folder-list" id="folder-list"></div>
                <div class="space-info" id="space-info"></div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('download-modal')">Cancel</button>
                <button class="btn btn-primary" onclick="confirmDownload()">Download Here</button>
            </div>
        </div>
    </div>

    <div class="toast-container" id="toast-container"></div>

    <script>
        // State
        let config = {};
        let currentServer = null;
        let currentParent = 'root';
        let currentPage = 1;
        let totalPages = 1;
        let selectedItems = new Set();
        let breadcrumbPath = [];
        let viewMode = 'grid';
        let itemsPerPage = 50;
        let isPaused = false;
        let downloadPath = '/storage';

        // Init
        document.addEventListener('DOMContentLoaded', async () => {
            await loadConfig();
            initTheme();
            setupTabs();
            startStatusPolling();
            startLogPolling();
        });

        // Theme
        function initTheme() {
            const theme = localStorage.getItem('theme') || config.theme || 'dark';
            setTheme(theme);
            viewMode = config.view_mode || 'grid';
            itemsPerPage = config.items_per_page || 50;
            updateViewToggle();
            document.getElementById('items-per-page').value = itemsPerPage;
        }

        function setTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
            document.getElementById('theme-toggle-settings').checked = theme === 'dark';
        }

        function toggleTheme() {
            const current = document.documentElement.getAttribute('data-theme');
            const newTheme = current === 'dark' ? 'light' : 'dark';
            setTheme(newTheme);
            config.theme = newTheme;
            api('config', 'POST', config);
        }

        // API
        async function api(endpoint, method = 'GET', body = null) {
            const options = { method, headers: { 'Content-Type': 'application/json' } };
            if (body) options.body = JSON.stringify(body);
            const res = await fetch(`/api/${endpoint}`, options);
            if (res.status === 401) { window.location.href = '/login'; return; }
            const ct = res.headers.get('content-type');
            return ct && ct.includes('application/json') ? res.json() : res.text();
        }

        // Tabs
        function setupTabs() {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    tab.classList.add('active');
                    document.getElementById(`tab-${tab.dataset.tab}`).classList.add('active');
                });
            });
        }

        // Config
        async function loadConfig() {
            config = await api('config');
            updateServerSelect();
            updateSettingsForm();
            updateServerList();
            updateLocalServerInfo();
        }

        function updateServerSelect() {
            const select = document.getElementById('server-select');
            select.innerHTML = '<option value="">Select Server...</option>';
            (config.servers || []).forEach(s => {
                const opt = document.createElement('option');
                opt.value = s.id;
                opt.textContent = s.name;
                select.appendChild(opt);
            });
        }

        function updateSettingsForm() {
            document.getElementById('auth-enabled').checked = config.auth_enabled || false;
            document.getElementById('language-select').value = config.language || 'en';
            document.getElementById('settings-items-per-page').value = config.items_per_page || 50;
            document.getElementById('settings-view-mode').value = config.view_mode || 'grid';
            document.getElementById('speed-limit').value = config.speed_limit_kbs || 0;
            document.getElementById('max-downloads').value = config.max_concurrent_downloads || 2;
            document.getElementById('download-order').value = config.download_order || 'library';
        }

        function updateServerList() {
            const container = document.getElementById('settings-server-list');
            if (!config.servers || config.servers.length === 0) {
                container.innerHTML = '<div class="empty-state" style="padding:1rem;"><p>No remote servers configured.</p></div>';
                return;
            }
            container.innerHTML = config.servers.map(s => `
                <div class="server-item">
                    <div class="server-icon">üì°</div>
                    <div class="server-info">
                        <div class="server-name">${escapeHtml(s.name)}</div>
                        <div class="server-url">${escapeHtml(s.url)}</div>
                    </div>
                    <button class="btn btn-icon btn-sm btn-danger" onclick="removeServer('${s.id}')" data-tooltip="Remove">üóëÔ∏è</button>
                </div>
            `).join('');
        }

        function updateLocalServerInfo() {
            const container = document.getElementById('local-server-info');
            if (config.local_server_url) {
                container.innerHTML = `
                    <div class="server-item">
                        <div class="server-icon" style="background:var(--jf-success);">‚úì</div>
                        <div class="server-info">
                            <div class="server-name">Local Server</div>
                            <div class="server-url">${escapeHtml(config.local_server_url)}</div>
                        </div>
                        <button class="btn btn-icon btn-sm btn-danger" onclick="removeLocalServer()" data-tooltip="Remove">üóëÔ∏è</button>
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <div class="empty-state" style="padding:1rem;">
                        <p>No local server configured.</p>
                        <button class="btn btn-sm" style="margin-top:0.5rem;" onclick="openModal('local-modal')">Configure</button>
                    </div>
                `;
            }
        }

        async function saveSettings() {
            config.auth_enabled = document.getElementById('auth-enabled').checked;
            config.language = document.getElementById('language-select').value;
            config.items_per_page = parseInt(document.getElementById('settings-items-per-page').value);
            config.view_mode = document.getElementById('settings-view-mode').value;
            config.speed_limit_kbs = parseInt(document.getElementById('speed-limit').value) || 0;
            config.max_concurrent_downloads = parseInt(document.getElementById('max-downloads').value);
            config.download_order = document.getElementById('download-order').value;
            await api('config', 'POST', config);
            showToast('Settings saved');
        }

        // Servers
        async function testAndAddServer() {
            const name = document.getElementById('new-server-name').value.trim();
            const url = document.getElementById('new-server-url').value.trim().replace(/\/$/, '');
            const key = document.getElementById('new-server-key').value.trim();
            const user = document.getElementById('new-server-user').value.trim();
            const pass = document.getElementById('new-server-pass').value;

            if (!name || !url) { showToast('Name and URL required', 'error'); return; }

            const testData = { url };
            if (key) testData.key = key;
            else if (user) { testData.username = user; testData.password = pass; }
            else { showToast('API key or credentials required', 'error'); return; }

            const result = await api('test_connection', 'POST', testData);
            if (result.status !== 'ok') { showToast(result.error || 'Connection failed', 'error'); return; }

            config.servers = config.servers || [];
            config.servers.push({ id: Date.now().toString(), name, url, key: result.key });
            await api('config', 'POST', config);
            closeModal('server-modal');
            loadConfig();
            showToast('Server added');
        }

        async function removeServer(id) {
            if (!confirm('Remove this server?')) return;
            config.servers = config.servers.filter(s => s.id !== id);
            await api('config', 'POST', config);
            loadConfig();
            showToast('Server removed');
        }

        async function saveLocalServer() {
            const url = document.getElementById('local-server-url').value.trim().replace(/\/$/, '');
            const key = document.getElementById('local-server-key').value.trim();
            if (!url || !key) { showToast('URL and API key required', 'error'); return; }
            config.local_server_url = url;
            config.local_server_key = key;
            await api('config', 'POST', config);
            await api('rebuild_cache', 'POST');
            closeModal('local-modal');
            loadConfig();
            showToast('Local server saved, scanning...');
        }

        async function removeLocalServer() {
            if (!confirm('Remove local server?')) return;
            await api('remove_local', 'POST');
            loadConfig();
            showToast('Local server removed');
        }

        // Browse
        function onServerChange() {
            const serverId = document.getElementById('server-select').value;
            if (!serverId) return;
            currentServer = config.servers.find(s => s.id === serverId);
            currentParent = 'root';
            currentPage = 1;
            breadcrumbPath = [{ id: 'root', name: 'Home' }];
            selectedItems.clear();
            updateSelectionBar();
            browseRemote();
        }

        async function browseRemote() {
            if (!currentServer) return;
            const container = document.getElementById('media-container');
            container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚è≥</div><p>Loading...</p></div>';

            const data = await api('browse_remote', 'POST', {
                server_id: currentServer.id,
                parent_id: currentParent,
                page: currentPage,
                items_per_page: itemsPerPage
            });

            totalPages = data.total_pages || 1;
            renderMedia(data.items, data.base_url);
            renderBreadcrumb();
            renderPagination();
        }

        function renderMedia(items, baseUrl) {
            const container = document.getElementById('media-container');
            if (!items || items.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìÇ</div><p>No items found</p></div>';
                return;
            }

            if (viewMode === 'grid') {
                container.innerHTML = `<div class="media-grid">${items.map(item => renderGridItem(item, baseUrl)).join('')}</div>`;
            } else {
                container.innerHTML = `<div class="media-list">${items.map(item => renderListItem(item, baseUrl)).join('')}</div>`;
            }
        }

        function renderGridItem(item, baseUrl) {
            const imgUrl = item.HasImage ? `${baseUrl}/Items/${item.Id}/Images/Primary?maxWidth=200` : '';
            const selected = selectedItems.has(item.Id) ? 'selected' : '';
            const exists = item.ExistsLocally ? 'exists' : '';
            return `
                <div class="media-item ${selected} ${exists}" data-id="${item.Id}" data-folder="${item.IsFolder}" onclick="onItemClick(event, '${item.Id}', ${item.IsFolder}, '${escapeHtml(item.Name)}')">
                    ${item.ExistsLocally ? '<div class="media-badge">‚úì Owned</div>' : ''}
                    <div class="media-poster">
                        ${imgUrl ? `<img src="${imgUrl}" loading="lazy" alt="">` : 'üìÅ'}
                    </div>
                    <div class="media-info">
                        <div class="media-title" title="${escapeHtml(item.Name)}">${escapeHtml(item.Name)}</div>
                        <div class="media-type">${item.Type || 'Folder'}</div>
                    </div>
                </div>
            `;
        }

        function renderListItem(item, baseUrl) {
            const imgUrl = item.HasImage ? `${baseUrl}/Items/${item.Id}/Images/Primary?maxWidth=80` : '';
            const selected = selectedItems.has(item.Id) ? 'selected' : '';
            const exists = item.ExistsLocally ? 'exists' : '';
            return `
                <div class="media-list-item ${selected} ${exists}" data-id="${item.Id}" data-folder="${item.IsFolder}" onclick="onItemClick(event, '${item.Id}', ${item.IsFolder}, '${escapeHtml(item.Name)}')">
                    <div class="media-list-thumb">
                        ${imgUrl ? `<img src="${imgUrl}" loading="lazy" alt="">` : 'üìÅ'}
                    </div>
                    <div class="media-list-info">
                        <div class="media-list-title">${escapeHtml(item.Name)}</div>
                        <div class="media-list-meta">${item.Type || 'Folder'}</div>
                    </div>
                    ${item.ExistsLocally ? '<div class="media-list-badge">‚úì Owned</div>' : ''}
                </div>
            `;
        }

        function onItemClick(event, id, isFolder, name) {
            if (event.ctrlKey || event.metaKey) {
                toggleSelection(id);
            } else if (isFolder) {
                navigateTo(id, name);
            } else {
                toggleSelection(id);
            }
        }

        function toggleSelection(id) {
            if (selectedItems.has(id)) {
                selectedItems.delete(id);
            } else {
                selectedItems.add(id);
            }
            updateSelectionUI();
        }

        function updateSelectionUI() {
            document.querySelectorAll('.media-item, .media-list-item').forEach(el => {
                el.classList.toggle('selected', selectedItems.has(el.dataset.id));
            });
            updateSelectionBar();
        }

        function updateSelectionBar() {
            const bar = document.getElementById('selection-bar');
            const count = document.getElementById('selection-count');
            count.textContent = selectedItems.size;
            bar.classList.toggle('active', selectedItems.size > 0);
        }

        function clearSelection() {
            selectedItems.clear();
            updateSelectionUI();
        }

        function navigateTo(id, name) {
            breadcrumbPath.push({ id, name });
            currentParent = id;
            currentPage = 1;
            selectedItems.clear();
            updateSelectionBar();
            browseRemote();
        }

        function navigateToBreadcrumb(index) {
            breadcrumbPath = breadcrumbPath.slice(0, index + 1);
            currentParent = breadcrumbPath[index].id;
            currentPage = 1;
            selectedItems.clear();
            updateSelectionBar();
            browseRemote();
        }

        function renderBreadcrumb() {
            const container = document.getElementById('breadcrumb');
            container.innerHTML = breadcrumbPath.map((item, i) => {
                if (i === breadcrumbPath.length - 1) {
                    return `<span class="breadcrumb-current">${escapeHtml(item.name)}</span>`;
                }
                return `<span class="breadcrumb-item" onclick="navigateToBreadcrumb(${i})">${escapeHtml(item.name)}</span><span class="breadcrumb-sep">‚Ä∫</span>`;
            }).join('');
        }

        function renderPagination() {
            const container = document.getElementById('pagination');
            if (totalPages <= 1) { container.innerHTML = ''; return; }

            let html = `<div class="pagination-info">Page ${currentPage} of ${totalPages}</div>`;
            html += `<button class="page-btn" onclick="goToPage(1)" ${currentPage === 1 ? 'disabled' : ''}>¬´</button>`;
            html += `<button class="page-btn" onclick="goToPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>‚Äπ</button>`;

            const start = Math.max(1, currentPage - 2);
            const end = Math.min(totalPages, currentPage + 2);
            for (let i = start; i <= end; i++) {
                html += `<button class="page-btn ${i === currentPage ? 'active' : ''}" onclick="goToPage(${i})">${i}</button>`;
            }

            html += `<button class="page-btn" onclick="goToPage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>‚Ä∫</button>`;
            html += `<button class="page-btn" onclick="goToPage(${totalPages})" ${currentPage === totalPages ? 'disabled' : ''}>¬ª</button>`;
            container.innerHTML = html;
        }

        function goToPage(page) {
            if (page < 1 || page > totalPages) return;
            currentPage = page;
            browseRemote();
        }

        function refreshLibrary() {
            if (currentServer) browseRemote();
        }

        // View Mode
        function setViewMode(mode) {
            viewMode = mode;
            updateViewToggle();
            if (currentServer) browseRemote();
        }

        function updateViewToggle() {
            document.querySelectorAll('.view-toggle-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.view === viewMode);
            });
        }

        function onItemsPerPageChange() {
            itemsPerPage = parseInt(document.getElementById('items-per-page').value);
            currentPage = 1;
            if (currentServer) browseRemote();
        }

        // Downloads
        function downloadSelected() {
            if (selectedItems.size === 0) return;
            downloadPath = '/storage';
            browseFolders();
            openModal('download-modal');
        }

        async function browseFolders() {
            const data = await api('browse_local', 'POST', { path: downloadPath });
            document.getElementById('current-path').textContent = data.current;
            downloadPath = data.current;

            let html = '';
            if (data.parent) {
                html += `<div class="folder-item" onclick="goToFolder('${data.parent}')">üìÅ ..</div>`;
            }
            html += data.folders.map(f => `<div class="folder-item" onclick="goToFolder('${downloadPath}/${f}')">üìÅ ${escapeHtml(f)}</div>`).join('');
            document.getElementById('folder-list').innerHTML = html || '<p style="padding:1rem;color:var(--jf-text-muted);">No subfolders</p>';

            if (data.space) {
                document.getElementById('space-info').innerHTML = `
                    <strong>Free:</strong> ${data.space.free} / ${data.space.total} (${data.space.percent_used}% used)
                `;
            }
        }

        function goToFolder(path) {
            downloadPath = path;
            browseFolders();
        }

        async function confirmDownload() {
            if (selectedItems.size === 0) return;
            closeModal('download-modal');

            const result = await api('batch_download', 'POST', {
                server_id: currentServer.id,
                item_ids: Array.from(selectedItems),
                path: downloadPath
            });

            if (result.status === 'queued') {
                showToast(`Queued ${result.count} item(s)`);
                selectedItems.clear();
                updateSelectionUI();
                document.querySelector('[data-tab="downloads"]').click();
            } else {
                showToast(result.message || 'Error', 'error');
            }
        }

        // Status Polling
        async function startStatusPolling() {
            setInterval(async () => {
                const status = await api('status');
                if (!status) return;

                isPaused = status.paused;
                document.getElementById('pause-btn').innerHTML = isPaused ? '‚ñ∂Ô∏è Resume' : '‚è∏Ô∏è Pause';

                // Active downloads
                const activeContainer = document.getElementById('active-downloads');
                const activeItems = Object.values(status.active);
                if (activeItems.length === 0) {
                    activeContainer.innerHTML = '<div class="empty-state" style="padding:1rem;"><p>No active downloads</p></div>';
                } else {
                    activeContainer.innerHTML = activeItems.map(d => `
                        <div class="download-item">
                            <div class="download-info">
                                <div class="download-name">${escapeHtml(d.filename)}</div>
                                <div class="download-status">${d.status} ‚Ä¢ ${d.speed} ‚Ä¢ ${d.percent}%</div>
                            </div>
                            <div class="download-progress">
                                <div class="download-progress-fill" style="width:${d.percent}%"></div>
                            </div>
                            <div class="download-actions">
                                <button class="btn btn-icon btn-sm btn-danger" onclick="cancelDownload('${d.id}')">‚úó</button>
                            </div>
                        </div>
                    `).join('');
                }

                // Pending
                const pendingContainer = document.getElementById('pending-downloads');
                document.getElementById('queue-count').textContent = `${status.pending.length} pending`;
                if (status.pending.length === 0) {
                    pendingContainer.innerHTML = '<div class="empty-state" style="padding:1rem;"><p>Queue empty</p></div>';
                } else {
                    pendingContainer.innerHTML = status.pending.slice(0, 20).map(p => `
                        <div class="download-item">
                            <div class="download-info">
                                <div class="download-name">${escapeHtml(p.name)}</div>
                                <div class="download-status">Queued</div>
                            </div>
                            <button class="btn btn-icon btn-sm" onclick="cancelDownload('${p.id}')">‚úó</button>
                        </div>
                    `).join('');
                }

                // Cache info
                document.getElementById('cache-info').innerHTML = `
                    <div style="font-size:0.875rem;color:var(--jf-text-muted);">
                        <strong>Cache:</strong> ${status.cache_count} items ‚Ä¢ Last scan: ${status.cache_time}
                        <button class="btn btn-sm" style="margin-left:0.5rem;" onclick="rebuildCache()">Rebuild</button>
                    </div>
                `;

            }, 2000);
        }

        async function togglePause() {
            await api(isPaused ? 'resume' : 'pause', 'POST');
        }

        async function cancelDownload(id) {
            await api('cancel', 'POST', { task_id: id });
        }

        async function cancelAll() {
            if (!confirm('Cancel all downloads?')) return;
            await api('cancel', 'POST', { all: true });
        }

        async function rebuildCache() {
            await api('rebuild_cache', 'POST');
            showToast('Cache rebuild started');
        }

        // Log Polling
        async function startLogPolling() {
            setInterval(async () => {
                const logs = await api('logs');
                if (!logs) return;
                const container = document.getElementById('log-container');
                container.innerHTML = logs.split('\n').slice(0, 50).map(line => `<div class="log-line">${escapeHtml(line)}</div>`).join('');
            }, 3000);
        }

        // Modals
        function openModal(id) {
            document.getElementById(id).classList.add('active');
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }

        // Toast
        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<span>${type === 'success' ? '‚úì' : type === 'error' ? '‚úó' : '‚ö†'}</span><span>${escapeHtml(message)}</span>`;
            container.appendChild(toast);
            setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 300); }, 4000);
        }

        // Utils
        function escapeHtml(str) {
            if (!str) return '';
            return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
        }

        // Close modals on overlay click
        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', e => { if (e.target === overlay) overlay.classList.remove('active'); });
        });
    </script>
</body>
</html>
