<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JellyLooter</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Theme Variables */
        :root {
            --jf-primary: #00a4dc;
            --jf-primary-dark: #0086b3;
            --jf-primary-light: #33b5e5;
            --jf-success: #4caf50;
            --jf-warning: #ff9800;
            --jf-error: #f44336;
            --jf-purple: #aa5cc3;
            --jf-gradient: linear-gradient(135deg, #00a4dc 0%, #aa5cc3 100%);
            --radius: 8px;
            --radius-lg: 12px;
            --shadow: 0 4px 24px rgba(0, 0, 0, 0.4);
            --transition: all 0.2s ease;
        }

        /* Dark Theme (Default) */
        [data-theme="dark"] {
            --jf-bg-dark: #101010;
            --jf-bg-card: #1a1a1a;
            --jf-bg-card-hover: #242424;
            --jf-bg-input: #2a2a2a;
            --jf-text: #ffffff;
            --jf-text-muted: #888888;
            --jf-text-dim: #666666;
            --jf-border: #333333;
            --jf-header-bg: rgba(0,164,220,0.15);
        }

        /* Light Theme */
        [data-theme="light"] {
            --jf-bg-dark: #f5f5f5;
            --jf-bg-card: #ffffff;
            --jf-bg-card-hover: #f0f0f0;
            --jf-bg-input: #e8e8e8;
            --jf-text: #1a1a1a;
            --jf-text-muted: #666666;
            --jf-text-dim: #888888;
            --jf-border: #dddddd;
            --jf-header-bg: rgba(0,164,220,0.1);
            --shadow: 0 4px 24px rgba(0, 0, 0, 0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Quicksand', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--jf-bg-dark);
            color: var(--jf-text);
            min-height: 100vh;
            line-height: 1.5;
            transition: background-color 0.3s, color 0.3s;
        }

        /* Header */
        .header {
            background: linear-gradient(180deg, var(--jf-header-bg) 0%, transparent 100%);
            border-bottom: 1px solid var(--jf-border);
            padding: 1rem 2rem;
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(20px);
        }

        .header-content {
            max-width: 1600px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: var(--jf-gradient);
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }

        .logo-text {
            font-size: 1.5rem;
            font-weight: 700;
            background: var(--jf-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .pro-badge {
            background: linear-gradient(135deg, #ffd700 0%, #ff8c00 100%);
            color: #000;
            font-size: 0.65rem;
            font-weight: 700;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            margin-left: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            cursor: pointer;
            display: none;
            vertical-align: middle;
        }
        
        .pro-badge-small {
            background: linear-gradient(135deg, #ffd700 0%, #ff8c00 100%);
            color: #000;
            font-size: 0.6rem;
            font-weight: 700;
            padding: 0.15rem 0.4rem;
            border-radius: 3px;
            margin-left: 0.35rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            vertical-align: middle;
        }

        .header-actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        /* Theme Toggle */
        .theme-toggle {
            width: 40px;
            height: 40px;
            border: 1px solid var(--jf-border);
            background: var(--jf-bg-card);
            border-radius: var(--radius);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.125rem;
            transition: var(--transition);
        }

        .theme-toggle:hover {
            background: var(--jf-bg-card-hover);
            border-color: var(--jf-primary);
        }

        .theme-icon-light, .theme-icon-dark { display: none; }
        [data-theme="dark"] .theme-icon-light { display: block; }
        [data-theme="light"] .theme-icon-dark { display: block; }

        /* User Menu */
        .user-menu {
            position: relative;
        }

        .user-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--jf-bg-card);
            border: 1px solid var(--jf-border);
            border-radius: var(--radius);
            color: var(--jf-text);
            cursor: pointer;
            font-family: inherit;
            font-size: 0.875rem;
            font-weight: 600;
            transition: var(--transition);
        }

        .user-btn:hover {
            background: var(--jf-bg-card-hover);
        }

        .user-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 0.5rem;
            background: var(--jf-bg-card);
            border: 1px solid var(--jf-border);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            min-width: 180px;
            display: none;
            z-index: 1000;
        }

        .user-dropdown.active { display: block; }

        .user-dropdown-item {
            display: block;
            width: 100%;
            padding: 0.75rem 1rem;
            background: none;
            border: none;
            color: var(--jf-text);
            font-family: inherit;
            font-size: 0.875rem;
            text-align: left;
            cursor: pointer;
            transition: var(--transition);
        }

        .user-dropdown-item:hover {
            background: var(--jf-bg-input);
        }

        .user-dropdown-item.danger { color: var(--jf-error); }

        /* Navigation Tabs */
        .nav-tabs {
            display: flex;
            gap: 0.25rem;
            background: var(--jf-bg-card);
            padding: 0.25rem;
            border-radius: var(--radius);
        }

        .nav-tab {
            padding: 0.5rem 1rem;
            border: none;
            background: transparent;
            color: var(--jf-text-muted);
            cursor: pointer;
            border-radius: calc(var(--radius) - 2px);
            font-family: inherit;
            font-size: 0.875rem;
            font-weight: 500;
            transition: var(--transition);
        }

        .nav-tab:hover {
            color: var(--jf-text);
            background: var(--jf-bg-input);
        }

        .nav-tab.active {
            background: var(--jf-primary);
            color: white;
        }

        /* Main Layout */
        .main-container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 1.5rem 2rem 5rem 2rem; /* Extra bottom padding for license banner */
            display: grid;
            grid-template-columns: 1fr 380px;
            gap: 1.5rem;
        }

        @media (max-width: 1200px) {
            .main-container { grid-template-columns: 1fr; }
        }
        
        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            .header { padding: 0.5rem 1rem; }
            .header-content { 
                flex-wrap: wrap; 
                gap: 0.5rem;
                position: relative;
            }
            .logo { flex: 1; }
            .logo-icon { width: 28px; height: 28px; }
            .logo-text { font-size: 1.1rem; }
            
            /* Hide desktop header items on mobile */
            .header-actions > .btn,
            .header-actions > a.btn,
            .header-actions > .theme-toggle {
                display: none;
            }
            
            .header-actions { 
                width: auto;
                gap: 0.5rem;
            }
            
            /* Mobile hamburger menu button */
            .mobile-menu-btn {
                display: flex !important;
                background: var(--jf-bg-input);
                border: 1px solid var(--jf-border);
                border-radius: var(--radius);
                padding: 0.5rem;
                font-size: 1.25rem;
                cursor: pointer;
            }
            
            /* Nav tabs on mobile */
            .nav-tabs { 
                order: 10;
                width: 100%;
                display: flex;
                justify-content: center;
                background: var(--jf-bg-card);
                border-radius: var(--radius);
                padding: 0.25rem;
                margin-top: 0.5rem;
            }
            .nav-tab { 
                flex: 1;
                padding: 0.5rem 0.5rem; 
                font-size: 0.75rem;
                text-align: center;
            }
            
            /* User menu on mobile */
            .user-menu { order: 5; }
            .user-btn span:nth-child(2) { display: none; } /* Hide username */
            
            /* Mobile slide-out menu */
            .mobile-menu {
                display: block !important;
                position: fixed;
                top: 0;
                right: -280px;
                width: 280px;
                height: 100vh;
                background: var(--jf-bg-card);
                border-left: 1px solid var(--jf-border);
                z-index: 2000;
                transition: right 0.3s ease;
                padding: 1rem;
                overflow-y: auto;
            }
            .mobile-menu.open { right: 0; }
            .mobile-menu-overlay {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.5);
                z-index: 1999;
            }
            .mobile-menu-overlay.open { display: block; }
            .mobile-menu-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 1rem;
                padding-bottom: 1rem;
                border-bottom: 1px solid var(--jf-border);
            }
            .mobile-menu-close {
                background: none;
                border: none;
                font-size: 1.5rem;
                cursor: pointer;
                color: var(--jf-text);
            }
            .mobile-menu-items {
                display: flex;
                flex-direction: column;
                gap: 0.5rem;
            }
            .mobile-menu-items a,
            .mobile-menu-items button {
                display: block;
                width: 100%;
                padding: 0.75rem 1rem;
                text-align: left;
                background: var(--jf-bg-input);
                border: 1px solid var(--jf-border);
                border-radius: var(--radius);
                color: var(--jf-text);
                text-decoration: none;
                cursor: pointer;
                touch-action: manipulation;
                -webkit-tap-highlight-color: transparent;
            }
            .mobile-menu-items a:hover,
            .mobile-menu-items button:hover {
                background: var(--jf-bg-card-hover);
            }
            
            /* Main content mobile */
            .main-container { 
                padding: 0.75rem;
                gap: 0.75rem;
            }
            
            .panel-header { 
                padding: 0.75rem; 
                flex-wrap: wrap; 
                gap: 0.5rem; 
            }
            .panel-header h2 { font-size: 0.9rem; }
            .panel-header .form-input { min-width: 120px !important; }
            .panel-body { padding: 0.75rem; }
            
            .browser-grid {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
                gap: 0.5rem;
            }
            
            .browser-item-title { font-size: 0.6875rem; padding: 0.375rem; }
            
            .selection-bar { 
                flex-direction: column; 
                text-align: center;
                padding: 0.5rem;
                gap: 0.5rem;
            }
            .selection-bar-actions { width: 100%; justify-content: center; }
            
            .pagination-controls { 
                flex-direction: column; 
                text-align: center;
                gap: 0.5rem;
                padding: 0.75rem 0;
            }
            .pagination-info { 
                flex-wrap: wrap; 
                justify-content: center;
                font-size: 0.8rem;
            }
            .pagination-buttons { flex-wrap: wrap; justify-content: center; }
            
            /* Sidebar becomes bottom sheet on mobile */
            .right-column {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                max-height: 50vh;
                overflow-y: auto;
                background: var(--jf-bg);
                border-top: 1px solid var(--jf-border);
                z-index: 100;
                transform: translateY(calc(100% - 60px));
                transition: transform 0.3s ease;
            }
            .right-column.expanded { transform: translateY(0); }
            .right-column-toggle {
                display: flex !important;
                justify-content: center;
                padding: 0.5rem;
                background: var(--jf-bg-card);
                border-bottom: 1px solid var(--jf-border);
                cursor: pointer;
            }
            .right-column-toggle::before {
                content: '‚¨ÜÔ∏è Downloads & Stats';
                font-size: 0.875rem;
            }
            .right-column.expanded .right-column-toggle::before {
                content: '‚¨áÔ∏è Collapse';
            }
            
            /* Add padding to main content for bottom bar */
            .left-column { padding-bottom: 70px; }
            
            .download-item { flex-direction: column; align-items: flex-start; }
            .download-item-actions { width: 100%; justify-content: flex-end; margin-top: 0.5rem; }
            
            .modal-content { 
                width: 95%; 
                max-width: none; 
                max-height: 85vh;
                overflow-y: auto;
            }
            .form-input { font-size: 16px; } /* Prevent zoom on iOS */
            
            .btn { padding: 0.625rem 1rem; }
            .btn-sm { padding: 0.5rem 0.75rem; }
            
            /* Stats grid mobile */
            .stats-grid { grid-template-columns: repeat(2, 1fr); gap: 0.5rem; }
            .stat-item { padding: 0.75rem; }
            .stat-value { font-size: 1.25rem; }
            
            /* Hide right column on mobile - use hamburger menu instead */
            .right-column { display: none !important; }
            .left-column { padding-bottom: 80px; } /* Space for banner */
        }
        
        @media (max-width: 480px) {
            .browser-grid {
                grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
                gap: 0.375rem;
            }
            .browser-item-title { font-size: 0.625rem; }
            .nav-tab { font-size: 0.7rem; padding: 0.5rem 0.25rem; }
        }
        
        /* Hide mobile elements on desktop */
        .mobile-menu-btn { display: none; }
        .mobile-menu { display: none; }
        .mobile-menu-overlay { display: none; }
        .right-column-toggle { display: none; }
        
        /* Mobile menu enhancements */
        .mobile-menu-section {
            padding: 0.75rem 1rem;
            background: var(--jf-bg-card);
            border-radius: var(--radius);
            margin-bottom: 0.5rem;
        }
        .mobile-menu-section-title {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--jf-text-muted);
            margin-bottom: 0.5rem;
        }
        .mobile-stats-grid {
            display: flex;
            gap: 1rem;
        }
        .mobile-stat {
            font-size: 0.875rem;
        }
        .mobile-stat span {
            font-weight: 700;
            color: var(--jf-primary);
        }
        .mobile-badge {
            display: inline-block;
            background: var(--jf-primary);
            color: white;
            font-size: 0.7rem;
            padding: 0.125rem 0.375rem;
            border-radius: 10px;
            margin-left: 0.5rem;
        }
        
        /* License Banner */
        .license-banner {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 0.75rem 1rem;
            text-align: center;
            z-index: 99;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            flex-wrap: wrap;
        }
        .license-banner-free {
            background: linear-gradient(135deg, var(--jf-primary) 0%, var(--jf-purple) 100%);
            color: white;
        }
        .license-banner-trial {
            background: linear-gradient(135deg, #ff9800 0%, #f44336 100%);
            color: white;
        }
        .license-banner-text {
            font-size: 0.875rem;
        }
        .license-banner-btn {
            background: white;
            color: var(--jf-primary);
            border: none;
            padding: 0.375rem 1rem;
            border-radius: var(--radius);
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            font-size: 0.875rem;
        }
        .license-banner-btn:hover {
            opacity: 0.9;
        }
        .license-banner-close {
            background: transparent;
            border: none;
            color: white;
            font-size: 1.25rem;
            cursor: pointer;
            padding: 0;
            line-height: 1;
            opacity: 0.7;
        }
        .license-banner-close:hover {
            opacity: 1;
        }
        
        /* Interaction hints */
        .interaction-hint {
            font-size: 0.75rem;
            color: var(--jf-text-muted);
            padding: 0.5rem 0;
            text-align: center;
        }
        .interaction-hint span {
            margin: 0 0.5rem;
        }
        
        /* Pro settings styles */
        .pro-badge {
            background: linear-gradient(135deg, #ffd700 0%, #ffaa00 100%);
            color: #000;
            font-size: 0.65rem;
            font-weight: 700;
            padding: 0.125rem 0.5rem;
            border-radius: 4px;
            margin-left: auto;
        }
        
        .license-status-box {
            background: var(--jf-bg-input);
            border-radius: var(--radius);
            padding: 1rem;
            margin-bottom: 1rem;
            text-align: center;
        }
        
        .license-status-box.pro {
            background: linear-gradient(135deg, rgba(255,215,0,0.1) 0%, rgba(255,170,0,0.1) 100%);
            border: 1px solid rgba(255,215,0,0.3);
        }
        
        .license-status-box.trial {
            background: linear-gradient(135deg, rgba(255,152,0,0.1) 0%, rgba(244,67,54,0.1) 100%);
            border: 1px solid rgba(255,152,0,0.3);
        }
        
        .license-status-box.free {
            background: var(--jf-bg-input);
            border: 1px solid var(--jf-border);
        }
        
        .pro-section {
            border-top: 1px solid var(--jf-border);
            padding-top: 0.5rem;
        }
        
        .pro-section.disabled {
            opacity: 0.5;
            pointer-events: none;
        }
        
        .pro-lock-overlay {
            position: relative;
        }
        
        .pro-lock-overlay::after {
            content: 'üîí Pro Feature';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--jf-bg-card);
            padding: 0.5rem 1rem;
            border-radius: var(--radius);
            font-size: 0.875rem;
            color: var(--jf-text-muted);
        }

        /* Panels */
        .panel {
            background: var(--jf-bg-card);
            border-radius: var(--radius-lg);
            border: 1px solid var(--jf-border);
            overflow: hidden;
        }

        .panel-header {
            padding: 1rem 1.25rem;
            border-bottom: 1px solid var(--jf-border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: linear-gradient(180deg, rgba(255,255,255,0.02) 0%, transparent 100%);
        }

        [data-theme="light"] .panel-header {
            background: linear-gradient(180deg, rgba(0,0,0,0.02) 0%, transparent 100%);
        }

        .panel-title {
            font-size: 1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .panel-title-icon { color: var(--jf-primary); }

        .panel-body { padding: 1.25rem; }

        /* Collapsible & Movable Panels (Pro) */
        .panel.collapsible .panel-header {
            cursor: pointer;
            user-select: none;
        }

        .panel.collapsible .panel-header:hover {
            background: linear-gradient(180deg, rgba(255,255,255,0.05) 0%, transparent 100%);
        }

        .panel.collapsed .panel-body {
            display: none;
        }

        .panel.collapsed .panel-header {
            border-bottom: none;
        }

        .panel-controls {
            display: flex;
            gap: 0.25rem;
            margin-left: auto;
            padding-left: 0.5rem;
        }

        .panel-collapse-icon {
            transition: transform 0.2s;
        }

        .panel.collapsed .panel-collapse-icon {
            transform: rotate(-90deg);
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.625rem 1.25rem;
            border: none;
            border-radius: var(--radius);
            font-family: inherit;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            white-space: nowrap;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        .btn-primary {
            background: var(--jf-primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--jf-primary-dark);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: var(--jf-bg-input);
            color: var(--jf-text);
            border: 1px solid var(--jf-border);
        }

        .btn-secondary:hover {
            background: var(--jf-bg-card-hover);
            border-color: var(--jf-text-dim);
        }

        .btn-danger {
            background: var(--jf-error);
            color: white;
        }

        .btn-danger:hover { background: #d32f2f; }

        .btn-success {
            background: var(--jf-success);
            color: white;
        }

        .btn-warning {
            background: var(--jf-warning);
            color: #1a1a1a;
        }

        .btn-sm {
            padding: 0.375rem 0.75rem;
            font-size: 0.8125rem;
        }

        .btn-icon {
            width: 36px;
            height: 36px;
            padding: 0;
            border-radius: var(--radius);
        }

        .btn-icon.btn-sm {
            width: 28px;
            height: 28px;
        }

        /* Form Elements */
        .form-group { margin-bottom: 1rem; }

        .form-label {
            display: block;
            font-size: 0.8125rem;
            font-weight: 600;
            color: var(--jf-text-muted);
            margin-bottom: 0.375rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-input {
            width: 100%;
            padding: 0.75rem 1rem;
            background: var(--jf-bg-input);
            border: 1px solid var(--jf-border);
            border-radius: var(--radius);
            color: var(--jf-text);
            font-family: inherit;
            font-size: 0.9375rem;
            transition: var(--transition);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--jf-primary);
            box-shadow: 0 0 0 3px rgba(0, 164, 220, 0.15);
        }

        .form-input::placeholder { color: var(--jf-text-dim); }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .form-hint {
            font-size: 0.75rem;
            color: var(--jf-text-muted);
            margin-top: 0.375rem;
        }

        /* Toggle Switch */
        .toggle-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 0;
        }

        .toggle-label { font-size: 0.9375rem; }

        .toggle {
            position: relative;
            width: 48px;
            height: 26px;
        }

        .toggle input { opacity: 0; width: 0; height: 0; }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            inset: 0;
            background: var(--jf-bg-input);
            border-radius: 26px;
            transition: var(--transition);
            border: 1px solid var(--jf-border);
        }

        .toggle-slider::before {
            content: '';
            position: absolute;
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background: var(--jf-text-muted);
            border-radius: 50%;
            transition: var(--transition);
        }

        .toggle input:checked + .toggle-slider {
            background: var(--jf-primary);
            border-color: var(--jf-primary);
        }

        .toggle input:checked + .toggle-slider::before {
            transform: translateX(22px);
            background: white;
        }

        /* Server List */
        .server-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .server-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.875rem 1rem;
            background: var(--jf-bg-input);
            border-radius: var(--radius);
            cursor: pointer;
            transition: var(--transition);
            border: 1px solid transparent;
        }

        .server-item:hover {
            background: var(--jf-bg-card-hover);
            border-color: var(--jf-border);
        }

        .server-item.active {
            border-color: var(--jf-primary);
            background: rgba(0, 164, 220, 0.1);
        }

        .server-icon {
            width: 40px;
            height: 40px;
            background: var(--jf-gradient);
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.125rem;
            flex-shrink: 0;
        }

        .server-info {
            flex: 1;
            min-width: 0;
        }

        .server-name {
            font-weight: 600;
            font-size: 0.9375rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .server-url {
            font-size: 0.8125rem;
            color: var(--jf-text-muted);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Browser Grid */
        .browser-container {
            max-height: 70vh;
            overflow-y: auto;
        }

        .browser-path {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1rem;
            background: var(--jf-bg-input);
            border-radius: var(--radius);
            margin-bottom: 1rem;
            font-size: 0.875rem;
            color: var(--jf-text-muted);
            overflow-x: auto;
        }

        .browser-path-item {
            color: var(--jf-primary);
            cursor: pointer;
            white-space: nowrap;
        }

        .browser-path-item:hover { text-decoration: underline; }

        .browser-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 1rem;
            padding: 0.25rem;
            align-content: start;
        }

        .pagination-controls {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 0;
            border-top: 1px solid var(--jf-border);
            margin-top: 1rem;
            flex-wrap: wrap;
            gap: 0.75rem;
        }

        .pagination-info {
            display: flex;
            align-items: center;
            color: var(--jf-text-muted);
            font-size: 0.875rem;
        }

        .pagination-buttons {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .pagination-buttons .btn {
            min-width: 36px;
        }

        .page-number {
            padding: 0.375rem 0.75rem;
            background: var(--jf-bg-input);
            border: 1px solid var(--jf-border);
            border-radius: var(--radius);
            color: var(--jf-text);
            cursor: pointer;
            font-size: 0.875rem;
            margin: 0 0.125rem;
        }

        .page-number:hover {
            background: var(--jf-bg-card-hover);
        }

        .page-number.active {
            background: var(--jf-primary);
            border-color: var(--jf-primary);
            color: white;
        }

        .browser-item {
            position: relative;
            aspect-ratio: 2/3;
            background: var(--jf-bg-input);
            border-radius: var(--radius);
            overflow: hidden;
            cursor: pointer;
            transition: var(--transition);
            border: 2px solid transparent;
        }

        .browser-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .browser-item.selected { border-color: var(--jf-primary); }

        .browser-item.exists { opacity: 0.6; }

        .browser-item.exists::after {
            content: '‚úì';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 40px;
            height: 40px;
            background: var(--jf-success);
            border-radius: 50%;
            font-size: 1.25rem;
            font-weight: bold;
            color: white;
            z-index: 10;
            box-shadow: 0 2px 8px rgba(0,0,0,0.5);
            line-height: 40px;
            text-align: center;
        }
        
        /* Partial download - yellow checkmark */
        .browser-item.partial { opacity: 0.75; }
        
        .browser-item.partial::after {
            content: '‚óê';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 40px;
            height: 40px;
            background: var(--jf-warning);
            border-radius: 50%;
            font-size: 1.25rem;
            font-weight: bold;
            color: white;
            z-index: 10;
            box-shadow: 0 2px 8px rgba(0,0,0,0.5);
            line-height: 40px;
            text-align: center;
        }
        
        /* Episode count badge for partial series */
        .episode-count-badge {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            color: var(--jf-warning);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 600;
            z-index: 11;
            white-space: nowrap;
        }

        .browser-item-poster {
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: center center;
        }

        /* Rating Badge Overlay */
        .rating-badge {
            position: absolute;
            top: 6px;
            left: 6px;
            display: flex;
            align-items: center;
            gap: 3px;
            padding: 3px 6px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 700;
            z-index: 5;
            backdrop-filter: blur(4px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .rating-badge.imdb {
            background: linear-gradient(135deg, rgba(245,197,24,0.95) 0%, rgba(200,160,20,0.95) 100%);
            color: #000;
        }
        
        .rating-badge.tmdb {
            background: linear-gradient(135deg, rgba(1,180,228,0.95) 0%, rgba(144,206,161,0.95) 100%);
            color: #000;
        }
        
        .rating-badge.rt-fresh {
            background: linear-gradient(135deg, rgba(250,50,10,0.95) 0%, rgba(200,40,10,0.95) 100%);
            color: #fff;
        }
        
        .rating-badge.rt-rotten {
            background: linear-gradient(135deg, rgba(80,160,80,0.95) 0%, rgba(60,130,60,0.95) 100%);
            color: #fff;
        }
        
        .rating-badge-icon {
            font-size: 0.8rem;
        }
        
        /* Content Rating Badge (PG-13, R, TV-MA etc) */
        .content-rating-badge {
            position: absolute;
            top: 6px;
            right: 6px;
            padding: 2px 5px;
            border-radius: 3px;
            font-size: 0.6rem;
            font-weight: 700;
            background: rgba(0,0,0,0.75);
            color: #fff;
            z-index: 5;
            border: 1px solid rgba(255,255,255,0.3);
        }
        
        /* Quality Badges Container (bottom of poster) */
        .quality-badges {
            position: absolute;
            bottom: 6px;
            left: 6px;
            right: 6px;
            display: flex;
            flex-wrap: wrap;
            gap: 3px;
            z-index: 5;
        }
        
        .quality-badge {
            padding: 2px 5px;
            border-radius: 3px;
            font-size: 0.6rem;
            font-weight: 700;
            backdrop-filter: blur(4px);
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        
        /* Resolution badges */
        .quality-badge.res-4k {
            background: linear-gradient(135deg, rgba(0,0,0,0.85) 0%, rgba(40,40,40,0.85) 100%);
            color: #ffd700;
            border: 1px solid #ffd700;
        }
        
        .quality-badge.res-1080p {
            background: linear-gradient(135deg, rgba(0,100,200,0.85) 0%, rgba(0,70,150,0.85) 100%);
            color: #fff;
        }
        
        .quality-badge.res-720p {
            background: linear-gradient(135deg, rgba(100,100,100,0.85) 0%, rgba(70,70,70,0.85) 100%);
            color: #fff;
        }
        
        .quality-badge.res-sd {
            background: rgba(80,80,80,0.85);
            color: #aaa;
        }
        
        /* HDR badges */
        .quality-badge.hdr {
            background: linear-gradient(135deg, rgba(255,140,0,0.9) 0%, rgba(200,100,0,0.9) 100%);
            color: #000;
            font-weight: 800;
        }
        
        .quality-badge.dolby-vision {
            background: linear-gradient(135deg, rgba(0,0,0,0.9) 0%, rgba(30,30,30,0.9) 100%);
            color: #00d4ff;
            border: 1px solid #00d4ff;
        }
        
        .quality-badge.atmos {
            background: linear-gradient(135deg, rgba(20,20,40,0.9) 0%, rgba(40,40,80,0.9) 100%);
            color: #a0a0ff;
            border: 1px solid #6060c0;
        }

        /* Collection/Playlist Download Button */
        .collection-download-btn {
            position: absolute;
            bottom: 50%;
            left: 50%;
            transform: translate(-50%, 50%);
            padding: 0.5rem 0.75rem;
            background: linear-gradient(135deg, var(--jf-primary) 0%, var(--jf-accent) 100%);
            color: white;
            border: none;
            border-radius: var(--radius);
            font-size: 0.7rem;
            font-weight: 600;
            cursor: pointer;
            z-index: 10;
            opacity: 0;
            transition: opacity 0.2s, transform 0.2s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.4);
            white-space: nowrap;
        }

        .browser-item:hover .collection-download-btn {
            opacity: 1;
        }

        .collection-download-btn:hover {
            transform: translate(-50%, 50%) scale(1.05);
        }

        .collection-download-btn span {
            margin-right: 0.25rem;
        }

        /* Skip Button */
        .skip-btn {
            position: absolute;
            top: 8px;
            left: 8px;
            width: 28px;
            height: 28px;
            padding: 0;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 0.9rem;
            cursor: pointer;
            z-index: 10;
            opacity: 0;
            transition: opacity 0.2s, transform 0.2s, background 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .browser-item:hover .skip-btn {
            opacity: 1;
        }
        
        .skip-btn.skipped {
            opacity: 1;
            background: var(--jf-danger);
            width: 32px;
            height: 32px;
            font-size: 1.1rem;
        }

        .skip-btn:hover {
            transform: scale(1.1);
            background: var(--jf-warning);
        }
        
        .skip-btn.skipped:hover {
            background: var(--jf-success);
        }
        
        /* Skipped item overlay */
        .browser-item.is-skipped {
            position: relative;
        }
        
        .browser-item.is-skipped::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(244, 67, 54, 0.25);
            pointer-events: none;
            border-radius: var(--radius);
            z-index: 5;
        }
        
        .browser-item.is-skipped .browser-item-poster {
            filter: grayscale(50%) brightness(0.7);
        }
        
        .browser-item.is-skipped .browser-item-title {
            text-decoration: line-through;
            opacity: 0.7;
        }
        
        /* Skipped badge */
        .skipped-badge {
            position: absolute;
            bottom: 35px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--jf-danger);
            color: white;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.65rem;
            font-weight: 700;
            text-transform: uppercase;
            z-index: 11;
            white-space: nowrap;
        }

        /* Skip List in Settings */
        /* Path Mapping Rows */
        .path-mapping-row {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            background: var(--jf-bg-card);
            border-radius: var(--radius);
            margin-bottom: 0.5rem;
            border: 1px solid var(--jf-border);
            position: relative;
        }
        
        .path-mapping-row input {
            flex: 1;
            min-width: 0;
            font-size: 0.8rem;
            padding: 0.4rem 0.5rem;
        }
        
        .path-mapping-row input[readonly] {
            opacity: 0.7;
            cursor: default;
        }
        
        .path-mapping-row .mapping-arrow {
            color: var(--jf-text-muted);
            font-size: 0.9rem;
            flex-shrink: 0;
        }
        
        .path-mapping-row .btn-remove {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            flex-shrink: 0;
        }
        
        .path-mapping-label {
            font-size: 0.7rem;
            color: var(--jf-text-muted);
            margin-bottom: 0.25rem;
        }
        
        .path-mapping-source {
            position: absolute;
            top: 2px;
            right: 35px;
            font-size: 0.65rem;
            padding: 0.1rem 0.3rem;
            border-radius: 3px;
            background: var(--jf-primary);
            color: white;
        }

        .skip-list-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            background: var(--jf-bg-input);
            border-radius: var(--radius);
            margin-bottom: 0.5rem;
        }
        
        .skip-item-type {
            font-size: 1.2rem;
        }
        
        .skip-item-name {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .browser-item-placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            color: var(--jf-text-dim);
            background: linear-gradient(135deg, var(--jf-bg-card) 0%, var(--jf-bg-input) 100%);
        }

        .browser-item-title {
            display: none;
        }

        /* Show title for pure folders (not Series which have posters) */
        .browser-item.folder:not(.series) .browser-item-title {
            display: block;
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 1.5rem 0.5rem 0.5rem;
            background: linear-gradient(transparent, rgba(0,0,0,0.9));
            font-size: 0.75rem;
            font-weight: 600;
            line-height: 1.3;
            text-align: center;
            color: white;
        }

        .browser-item.folder:not(.series) .browser-item-placeholder {
            background: linear-gradient(135deg, rgba(0,164,220,0.2) 0%, rgba(170,92,195,0.2) 100%);
        }

        /* Download Queue */
        .queue-container {
            max-height: 400px;
            overflow-y: auto;
        }

        .queue-empty {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--jf-text-muted);
        }

        .queue-empty-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        /* Resumable Downloads (Pro) */
        .resumable-section {
            border-top: 1px solid var(--jf-border);
            padding: 1rem;
            margin-top: 0.5rem;
        }

        .resumable-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--jf-text-muted);
            margin-bottom: 0.75rem;
        }

        .resumable-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem;
            background: var(--jf-bg-input);
            border-radius: var(--radius);
            margin-bottom: 0.5rem;
        }

        .resumable-info {
            flex: 1;
            min-width: 0;
        }

        .resumable-name {
            font-size: 0.85rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .resumable-meta {
            font-size: 0.7rem;
            color: var(--jf-text-muted);
            margin-top: 0.25rem;
        }

        .resumable-actions {
            display: flex;
            gap: 0.25rem;
            margin-left: 0.5rem;
        }

        .download-item {
            padding: 1rem;
            background: var(--jf-bg-input);
            border-radius: var(--radius);
            margin-bottom: 0.5rem;
        }

        .download-item:last-child { margin-bottom: 0; }

        .download-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .download-name {
            font-size: 0.875rem;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex: 1;
            margin-right: 0.5rem;
        }

        .download-status {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            background: var(--jf-primary);
            color: white;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .download-status.paused {
            background: var(--jf-warning);
            color: #1a1a1a;
        }

        .download-status.pending {
            background: var(--jf-text-dim);
        }

        .download-status.transcoding {
            background: linear-gradient(90deg, #f59e0b, #ea580c);
        }

        .download-status.transcoding-pending {
            background: #92400e;
        }

        .download-progress {
            height: 6px;
            background: var(--jf-border);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 0.5rem;
        }

        .download-progress-bar {
            height: 100%;
            background: var(--jf-gradient);
            transition: width 0.3s;
        }

        .download-progress-bar.transcode {
            background: linear-gradient(90deg, #f59e0b, #ea580c);
        }

        .download-header-right {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-xs {
            padding: 0.15rem 0.4rem;
            font-size: 0.7rem;
            border-radius: 4px;
            line-height: 1;
        }

        .download-meta {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            color: var(--jf-text-muted);
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .stat-card {
            background: var(--jf-bg-card);
            border: 1px solid var(--jf-border);
            border-radius: var(--radius);
            padding: 1rem;
            text-align: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--jf-primary);
        }

        .stat-label {
            font-size: 0.75rem;
            color: var(--jf-text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Stats Widget */
        .stats-widget {
            background: var(--jf-bg-card);
            border: 1px solid var(--jf-border);
            border-radius: var(--radius);
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .stats-widget .stats-grid {
            grid-template-columns: repeat(4, 1fr);
            gap: 0.5rem;
            margin-bottom: 0;
        }

        .stats-widget .stat-item {
            text-align: center;
            padding: 0.5rem;
        }

        .stats-widget .stat-value {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--jf-primary);
        }

        .stats-widget .stat-label {
            font-size: 0.65rem;
            color: var(--jf-text-muted);
            text-transform: uppercase;
            margin-top: 0.25rem;
        }

        @media (max-width: 768px) {
            .stats-widget .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Control Bar */
        .control-bar {
            display: flex;
            gap: 0.5rem;
            padding-top: 1rem;
            border-top: 1px solid var(--jf-border);
            margin-top: 1rem;
        }

        /* Log Container */
        .log-container, .history-container {
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 0.8125rem;
            background: var(--jf-bg-input);
            border-radius: var(--radius);
            padding: 1rem;
            max-height: 300px;
            overflow-y: auto;
            line-height: 1.6;
        }

        .log-line { padding: 0.125rem 0; }
        .log-line .success { color: var(--jf-success); }
        .log-line .error { color: var(--jf-error); }
        
        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem;
            border-bottom: 1px solid var(--jf-border);
        }
        .history-item:last-child { border-bottom: none; }
        .history-item-name {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .history-item-meta {
            font-size: 0.75rem;
            color: var(--jf-text-muted);
            text-align: right;
        }

        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .modal.active { display: flex; }

        .modal-content {
            background: var(--jf-bg-card);
            border-radius: var(--radius-lg);
            border: 1px solid var(--jf-border);
            width: 90%;
            max-width: 480px;
            max-height: 90vh;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--jf-border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-title {
            font-size: 1.125rem;
            font-weight: 700;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--jf-text-muted);
            cursor: pointer;
            line-height: 1;
        }

        .modal-close:hover { color: var(--jf-text); }

        .modal-body {
            padding: 1.5rem;
            overflow-y: auto;
        }

        .modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--jf-border);
            display: flex;
            gap: 0.75rem;
            justify-content: flex-end;
        }

        /* Advanced Settings Toggle */
        .advanced-toggle {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 0;
            color: var(--jf-text-muted);
            cursor: pointer;
            font-size: 0.875rem;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            font-family: inherit;
        }

        .advanced-toggle:hover { color: var(--jf-text); }

        .advanced-toggle-icon { transition: transform 0.2s; }
        .advanced-toggle.open .advanced-toggle-icon { transform: rotate(180deg); }

        .advanced-content {
            display: none;
            padding-top: 0.5rem;
        }

        .advanced-content.open { display: block; }

        /* Tab Content */
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Mapping List */
        .mapping-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.875rem 1rem;
            background: var(--jf-bg-input);
            border-radius: var(--radius);
            margin-bottom: 0.5rem;
        }

        .mapping-info {
            flex: 1;
            min-width: 0;
        }

        .mapping-path {
            font-size: 0.875rem;
            font-weight: 600;
        }

        .mapping-source {
            font-size: 0.75rem;
            color: var(--jf-text-muted);
        }

        /* Scan Progress */
        .scan-progress {
            padding: 1rem;
            background: var(--jf-bg-input);
            border-radius: var(--radius);
            margin-bottom: 1rem;
        }

        .scan-progress-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }

        .scan-progress-bar {
            height: 6px;
            background: var(--jf-border);
            border-radius: 3px;
            overflow: hidden;
        }

        .scan-progress-fill {
            height: 100%;
            background: var(--jf-gradient);
            transition: width 0.3s;
        }

        /* Selection Bar */
        .selection-bar {
            display: none;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 1rem;
            background: var(--jf-primary);
            border-radius: var(--radius);
            margin-bottom: 1rem;
        }

        .selection-bar.active { display: flex; }

        .selection-bar-text {
            font-weight: 600;
            color: white;
        }

        .selection-bar-actions { display: flex; gap: 0.5rem; }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--jf-text-muted);
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.3;
        }

        .empty-state-title {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--jf-text);
        }

        /* Tooltip */
        [data-tooltip] { position: relative; }

        [data-tooltip]::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            padding: 0.375rem 0.75rem;
            background: var(--jf-text);
            color: var(--jf-bg-dark);
            font-size: 0.75rem;
            font-weight: 500;
            border-radius: 4px;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition);
            pointer-events: none;
            margin-bottom: 0.5rem;
            z-index: 1000;
        }

        [data-tooltip]:hover::after {
            opacity: 1;
            visibility: visible;
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb {
            background: var(--jf-border);
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover { background: var(--jf-text-dim); }

        /* Animations */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .pulse { animation: pulse 2s infinite; }

        @keyframes spin { to { transform: rotate(360deg); } }
        .spin { animation: spin 1s linear infinite; }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            bottom: 5rem;
            right: 2rem;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .toast {
            background: var(--jf-bg-card);
            border: 1px solid var(--jf-border);
            border-radius: var(--radius);
            padding: 1rem 1.25rem;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            animation: slideIn 0.3s ease;
        }

        .toast.success { border-left: 4px solid var(--jf-success); }
        .toast.error { border-left: 4px solid var(--jf-error); }
        .toast.warning { border-left: 4px solid var(--jf-warning); }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Settings Section */
        .settings-section {
            margin-bottom: 1.5rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid var(--jf-border);
        }

        .settings-section:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }

        .settings-section-title {
            font-size: 0.9375rem;
            font-weight: 600;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .settings-section-title span { color: var(--jf-primary); }

        /* ========== Seasonal Theme Effects ========== */
        #theme-effects {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
            overflow: hidden;
        }

        /* Base decoration styles */
        .theme-decor {
            position: absolute;
            opacity: 0.15;
        }

        /* Falling items container */
        .falling-items {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .fall-item {
            position: absolute;
            top: -30px;
            animation: fall-down linear infinite;
        }

        /* Generic falling animation */
        @keyframes fall-down {
            0% { transform: translateY(-30px) rotate(0deg); opacity: 0; }
            10% { opacity: 0.6; }
            90% { opacity: 0.6; }
            100% { transform: translateY(100vh) rotate(360deg); opacity: 0; }
        }

        /* Falling item positions */
        .fall-item:nth-child(1) { left: 5%; animation-duration: 15s; font-size: 1.2rem; animation-delay: 0s; }
        .fall-item:nth-child(2) { left: 15%; animation-duration: 12s; font-size: 0.8rem; animation-delay: 2s; }
        .fall-item:nth-child(3) { left: 30%; animation-duration: 18s; font-size: 1rem; animation-delay: 4s; }
        .fall-item:nth-child(4) { left: 50%; animation-duration: 14s; font-size: 1.1rem; animation-delay: 1s; }
        .fall-item:nth-child(5) { left: 65%; animation-duration: 16s; font-size: 0.9rem; animation-delay: 3s; }
        .fall-item:nth-child(6) { left: 80%; animation-duration: 13s; font-size: 1.3rem; animation-delay: 5s; }
        .fall-item:nth-child(7) { left: 90%; animation-duration: 17s; font-size: 0.7rem; animation-delay: 2.5s; }
        .fall-item:nth-child(8) { left: 42%; animation-duration: 11s; font-size: 1rem; animation-delay: 4.5s; }
        .fall-item:nth-child(9) { left: 72%; animation-duration: 19s; font-size: 0.9rem; animation-delay: 1.5s; }
        .fall-item:nth-child(10) { left: 22%; animation-duration: 13s; font-size: 1.1rem; animation-delay: 3.5s; }

        /* ===== CHRISTMAS ===== */
        .tree { font-size: 4rem; filter: drop-shadow(0 0 10px rgba(34, 139, 34, 0.5)); animation: tree-glow 3s ease-in-out infinite; }
        .tree-1 { bottom: 5%; left: 3%; font-size: 5rem; animation-delay: 0s; }
        .tree-2 { bottom: 8%; right: 5%; font-size: 4rem; animation-delay: 1s; }
        .tree-3 { bottom: 3%; left: 25%; font-size: 3rem; opacity: 0.1; animation-delay: 0.5s; }
        .tree-4 { bottom: 6%; right: 25%; font-size: 3.5rem; opacity: 0.12; animation-delay: 1.5s; }

        @keyframes tree-glow {
            0%, 100% { filter: drop-shadow(0 0 10px rgba(34, 139, 34, 0.5)); }
            50% { filter: drop-shadow(0 0 20px rgba(196, 30, 58, 0.6)) drop-shadow(0 0 30px rgba(255, 215, 0, 0.4)); }
        }

        .snowflake { color: rgba(255, 255, 255, 0.6); text-shadow: 0 0 5px rgba(255, 255, 255, 0.5); }

        body.christmas-theme { background: radial-gradient(ellipse at bottom, #1a2f1a 0%, #0d1a0d 100%); }
        body.christmas-theme .header { background: linear-gradient(180deg, rgba(196,30,58,0.2) 0%, transparent 100%); border-bottom-color: rgba(34, 139, 34, 0.3); }
        body.christmas-theme .browser-item:hover { border-color: #c41e3a; box-shadow: 0 0 15px rgba(196, 30, 58, 0.3); }

        /* ===== WINTER ===== */
        .snowman { font-size: 3.5rem; filter: drop-shadow(0 0 15px rgba(200, 220, 255, 0.4)); animation: snowman-wiggle 4s ease-in-out infinite; }
        .snowman-1 { bottom: 5%; left: 5%; font-size: 4rem; }
        .snowman-2 { bottom: 8%; right: 8%; font-size: 3.5rem; animation-delay: 1s; }
        .snowman-3 { bottom: 4%; left: 40%; font-size: 3rem; opacity: 0.1; animation-delay: 2s; }

        @keyframes snowman-wiggle {
            0%, 100% { transform: rotate(-2deg); }
            50% { transform: rotate(2deg); }
        }

        body.winter-theme { background: radial-gradient(ellipse at bottom, #1a2940 0%, #0a1929 100%); }
        body.winter-theme .header { background: linear-gradient(180deg, rgba(91,155,213,0.2) 0%, transparent 100%); }
        body.winter-theme .browser-item:hover { box-shadow: 0 0 15px rgba(91, 155, 213, 0.3); }

        /* ===== HALLOWEEN ===== */
        .pumpkin { font-size: 4rem; filter: drop-shadow(0 0 20px rgba(255, 111, 0, 0.5)); animation: pumpkin-glow 2s ease-in-out infinite; }
        .pumpkin-1 { bottom: 5%; left: 5%; font-size: 4.5rem; }
        .pumpkin-2 { bottom: 8%; right: 8%; font-size: 3.5rem; animation-delay: 0.5s; }

        .ghost { font-size: 2.5rem; animation: ghost-float 3s ease-in-out infinite; }
        .ghost-1 { top: 20%; right: 10%; animation-delay: 0s; }
        .ghost-2 { top: 35%; left: 8%; animation-delay: 1.5s; opacity: 0.12; }

        .bat { font-size: 1.5rem; animation: bat-fly 4s ease-in-out infinite; }
        .bat-1 { top: 15%; left: 20%; }
        .bat-2 { top: 25%; right: 25%; animation-delay: 1s; }
        .bat-3 { top: 10%; left: 60%; animation-delay: 2s; opacity: 0.1; }

        @keyframes pumpkin-glow {
            0%, 100% { filter: drop-shadow(0 0 20px rgba(255, 111, 0, 0.5)); }
            50% { filter: drop-shadow(0 0 35px rgba(255, 111, 0, 0.8)); }
        }

        @keyframes ghost-float {
            0%, 100% { transform: translateY(0) translateX(0); }
            25% { transform: translateY(-15px) translateX(10px); }
            75% { transform: translateY(10px) translateX(-10px); }
        }

        @keyframes bat-fly {
            0%, 100% { transform: translateY(0) translateX(0) rotate(0deg); }
            25% { transform: translateY(-20px) translateX(30px) rotate(10deg); }
            50% { transform: translateY(10px) translateX(50px) rotate(-5deg); }
            75% { transform: translateY(-10px) translateX(20px) rotate(5deg); }
        }

        body.halloween-theme { background: radial-gradient(ellipse at bottom, #1a1a1a 0%, #0d0d0d 100%); }
        body.halloween-theme .header { background: linear-gradient(180deg, rgba(255,111,0,0.15) 0%, transparent 100%); }
        body.halloween-theme .browser-item:hover { box-shadow: 0 0 15px rgba(255, 111, 0, 0.3); }

        /* ===== VALENTINE'S ===== */
        .heart { color: rgba(233, 30, 99, 0.7); text-shadow: 0 0 10px rgba(233, 30, 99, 0.5); animation: heart-float linear infinite; }

        @keyframes heart-float {
            0% { transform: translateY(-30px) scale(0.8); opacity: 0; }
            10% { opacity: 0.7; }
            50% { transform: translateY(50vh) scale(1.1); }
            90% { opacity: 0.7; }
            100% { transform: translateY(100vh) scale(0.9); opacity: 0; }
        }

        body.valentines-theme { background: radial-gradient(ellipse at bottom, #2d1520 0%, #1a0a10 100%); }
        body.valentines-theme .header { background: linear-gradient(180deg, rgba(233,30,99,0.2) 0%, transparent 100%); }
        body.valentines-theme .browser-item:hover { box-shadow: 0 0 15px rgba(233, 30, 99, 0.3); }

        /* ===== SPRING ===== */
        .flower { font-size: 3rem; animation: flower-sway 4s ease-in-out infinite; }
        .flower-1 { bottom: 5%; left: 5%; font-size: 3.5rem; }
        .flower-2 { bottom: 8%; right: 10%; font-size: 2.5rem; animation-delay: 1s; }
        .flower-3 { bottom: 3%; left: 35%; font-size: 2rem; opacity: 0.12; animation-delay: 2s; }

        .petal { color: rgba(255, 182, 193, 0.7); }

        @keyframes flower-sway {
            0%, 100% { transform: rotate(-5deg); }
            50% { transform: rotate(5deg); }
        }

        body.spring-theme { background: radial-gradient(ellipse at bottom, #2d1a25 0%, #1a0f15 100%); }
        body.spring-theme .header { background: linear-gradient(180deg, rgba(233,30,140,0.15) 0%, transparent 100%); }
        body.spring-theme .browser-item:hover { box-shadow: 0 0 15px rgba(233, 30, 140, 0.3); }

        /* ===== SUMMER ===== */
        .sun { font-size: 5rem; top: 5%; right: 10%; animation: sun-pulse 4s ease-in-out infinite; filter: drop-shadow(0 0 30px rgba(255, 200, 0, 0.5)); }
        .palm { font-size: 4rem; }
        .palm-1 { bottom: 3%; left: 3%; font-size: 4.5rem; }
        .palm-2 { bottom: 5%; right: 5%; font-size: 3.5rem; }
        .wave { font-size: 3rem; bottom: 0; left: 30%; animation: wave-move 3s ease-in-out infinite; }

        @keyframes sun-pulse {
            0%, 100% { transform: scale(1); filter: drop-shadow(0 0 30px rgba(255, 200, 0, 0.5)); }
            50% { transform: scale(1.1); filter: drop-shadow(0 0 50px rgba(255, 200, 0, 0.7)); }
        }

        @keyframes wave-move {
            0%, 100% { transform: translateX(0); }
            50% { transform: translateX(20px); }
        }

        body.summer-theme { background: radial-gradient(ellipse at top, #2d2010 0%, #1a1205 100%); }
        body.summer-theme .header { background: linear-gradient(180deg, rgba(255,152,0,0.2) 0%, transparent 100%); }
        body.summer-theme .browser-item:hover { box-shadow: 0 0 15px rgba(255, 152, 0, 0.3); }

        /* ===== FALL / AUTUMN ===== */
        .fall-tree { font-size: 3rem; }
        .fall-tree-1 { bottom: 5%; left: 8%; font-size: 3.5rem; }
        .fall-tree-2 { bottom: 7%; right: 10%; font-size: 3rem; }

        .leaf { color: rgba(230, 81, 0, 0.7); animation: leaf-fall linear infinite; }

        @keyframes leaf-fall {
            0% { transform: translateY(-30px) translateX(0) rotate(0deg); opacity: 0; }
            10% { opacity: 0.7; }
            50% { transform: translateY(50vh) translateX(30px) rotate(180deg); }
            90% { opacity: 0.7; }
            100% { transform: translateY(100vh) translateX(-20px) rotate(360deg); opacity: 0; }
        }

        body.fall-theme { background: radial-gradient(ellipse at bottom, #2d1a0a 0%, #1a0f05 100%); }
        body.fall-theme .header { background: linear-gradient(180deg, rgba(230,81,0,0.2) 0%, transparent 100%); }
        body.fall-theme .browser-item:hover { box-shadow: 0 0 15px rgba(230, 81, 0, 0.3); }

        /* ===== ST. PATRICK'S DAY ===== */
        .clover { font-size: 3rem; animation: clover-spin 5s linear infinite; }
        .clover-1 { bottom: 5%; left: 5%; font-size: 3.5rem; }
        .clover-2 { bottom: 8%; right: 8%; font-size: 2.5rem; animation-delay: 1s; }
        .clover-3 { bottom: 3%; left: 30%; font-size: 2rem; opacity: 0.1; animation-delay: 2s; }
        .pot-gold { font-size: 4rem; bottom: 10%; right: 15%; animation: rainbow-glow 3s ease-in-out infinite; }

        .clover-fall { color: rgba(46, 125, 50, 0.7); }

        @keyframes clover-spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes rainbow-glow {
            0%, 100% { filter: drop-shadow(0 0 15px rgba(255, 215, 0, 0.5)); }
            50% { filter: drop-shadow(0 0 30px rgba(255, 215, 0, 0.8)); }
        }

        body.stpatricks-theme { background: radial-gradient(ellipse at bottom, #142814 0%, #0a1a0a 100%); }
        body.stpatricks-theme .header { background: linear-gradient(180deg, rgba(46,125,50,0.2) 0%, transparent 100%); }
        body.stpatricks-theme .browser-item:hover { box-shadow: 0 0 15px rgba(46, 125, 50, 0.3); }

        /* ===== 4TH OF JULY ===== */
        .firework { font-size: 3rem; animation: firework-burst 2s ease-out infinite; }
        .firework-1 { top: 10%; left: 15%; animation-delay: 0s; }
        .firework-2 { top: 15%; right: 20%; animation-delay: 0.7s; }
        .firework-3 { top: 8%; left: 50%; animation-delay: 1.4s; font-size: 2rem; }
        .flag { font-size: 4rem; bottom: 5%; right: 5%; animation: flag-wave 2s ease-in-out infinite; }

        .star { color: rgba(255, 215, 0, 0.7); text-shadow: 0 0 10px rgba(255, 215, 0, 0.5); }

        @keyframes firework-burst {
            0% { transform: scale(0.5); opacity: 0; }
            50% { transform: scale(1.2); opacity: 0.8; }
            100% { transform: scale(0.8); opacity: 0; }
        }

        @keyframes flag-wave {
            0%, 100% { transform: rotate(-3deg); }
            50% { transform: rotate(3deg); }
        }

        body.july4th-theme { background: radial-gradient(ellipse at bottom, #141428 0%, #0a0a1a 100%); }
        body.july4th-theme .header { background: linear-gradient(180deg, rgba(183,28,28,0.2) 0%, transparent 100%); }
        body.july4th-theme .browser-item:hover { box-shadow: 0 0 15px rgba(183, 28, 28, 0.3); }

        /* Ensure content stays above theme effects */
        .header, .main-content, .panel {
            position: relative;
            z-index: 1;
        }

        /* Mobile responsive for themes */
        @media (max-width: 768px) {
            .theme-decor { font-size: 2rem !important; opacity: 0.1 !important; }
            .tree-3, .tree-4, .snowman-3, .ghost-2, .bat-3, .flower-3, .clover-3 { display: none; }
            .fall-item { font-size: 0.8rem !important; }
            .sun { font-size: 3rem !important; }
            .flag { font-size: 2.5rem !important; }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <img src="https://raw.githubusercontent.com/jlightner86/jellylooter/main/icon.png" alt="JellyLooter" class="logo-icon" style="background: none;">
                <span class="logo-text">JellyLooter</span>
                <span class="pro-badge" id="header-pro-badge" style="display: none;" title="Click 5 times to manage license">PRO</span>
            </div>
            <div class="header-actions">
                <!-- Mobile menu button -->
                <button class="mobile-menu-btn" id="mobile-menu-btn">‚ò∞</button>
                
                <nav class="nav-tabs">
                    <button class="nav-tab active" data-tab="browse" data-i18n="browse">Browse</button>
                    <button class="nav-tab" data-tab="sync" data-i18n="sync">Sync</button>
                    <button class="nav-tab" data-tab="settings" data-i18n="settings">Settings</button>
                </nav>
                
                <button class="theme-toggle" id="theme-toggle" data-tooltip="Toggle Theme">
                    <span class="theme-icon-light">‚òÄÔ∏è</span>
                    <span class="theme-icon-dark">üåô</span>
                </button>
                
                <a href="/changelog" class="btn btn-secondary btn-sm" data-i18n="changelog">Changelog</a>
                <a href="/help" class="btn btn-secondary btn-sm" data-i18n="help">Help</a>
                
                <div class="user-menu">
                    <button class="user-btn" id="user-btn">
                        <span>üë§</span>
                        <span id="username-display">User</span>
                        <span>‚ñº</span>
                    </button>
                    <div class="user-dropdown" id="user-dropdown">
                        <button class="user-dropdown-item" onclick="openModal('password-modal')">Change Password</button>
                        <button class="user-dropdown-item danger" onclick="window.location.href='/logout'">Sign Out</button>
                    </div>
                </div>
            </div>
        </div>
    </header>
    
    <!-- Mobile Menu Overlay -->
    <div class="mobile-menu-overlay" id="mobile-menu-overlay"></div>
    
    <!-- Mobile Slide-out Menu -->
    <div class="mobile-menu" id="mobile-menu">
        <div class="mobile-menu-header">
            <span style="font-weight: 600;">Menu</span>
            <button class="mobile-menu-close" id="mobile-menu-close">√ó</button>
        </div>
        <div class="mobile-menu-items">
            <!-- Downloads Section (mobile only) -->
            <div class="mobile-menu-section">
                <div class="mobile-menu-section-title">üìä Quick Stats</div>
                <div class="mobile-stats-grid">
                    <div class="mobile-stat"><span id="mobile-stat-active">0</span> Active</div>
                    <div class="mobile-stat"><span id="mobile-stat-pending">0</span> Pending</div>
                </div>
            </div>
            <button onclick="openMobileDownloads(); closeMobileMenu();">‚¨áÔ∏è Downloads <span id="mobile-download-badge" class="mobile-badge" style="display:none;">0</span></button>
            <button onclick="openMobileLog(); closeMobileMenu();">üìã Activity Log</button>
            <hr style="border: none; border-top: 1px solid var(--jf-border); margin: 0.5rem 0;">
            <div class="mobile-menu-section">
                <div class="mobile-menu-section-title">üîß Actions</div>
            </div>
            <button onclick="mobileSync(); closeMobileMenu();">üîÑ Sync Now</button>
            <button onclick="mobileRebuildCache(); closeMobileMenu();">üóÑÔ∏è Rebuild Cache</button>
            <hr style="border: none; border-top: 1px solid var(--jf-border); margin: 0.5rem 0;">
            <button onclick="toggleTheme(); closeMobileMenu();">üåô Toggle Theme</button>
            <a href="/changelog">üìã Changelog</a>
            <a href="/help">‚ùì Help</a>
            <button onclick="openModal('password-modal'); closeMobileMenu();">üîë Change Password</button>
            <a href="/logout" style="color: var(--jf-error);">üö™ Sign Out</a>
        </div>
    </div>

    <!-- Mobile Downloads Modal -->
    <div class="modal" id="mobile-downloads-modal">
        <div class="modal-content" style="max-height: 80vh; overflow-y: auto;">
            <div class="modal-header">
                <h2>‚¨áÔ∏è Downloads</h2>
                <button class="modal-close" onclick="closeModal('mobile-downloads-modal')">√ó</button>
            </div>
            <div class="modal-body" style="padding: 0;">
                <div class="mobile-queue-controls" style="display: flex; gap: 0.5rem; padding: 1rem; border-bottom: 1px solid var(--jf-border);">
                    <button class="btn btn-secondary btn-sm" id="mobile-pause-btn" onclick="pauseDownloads()">‚è∏Ô∏è Pause</button>
                    <button class="btn btn-secondary btn-sm" id="mobile-resume-btn" onclick="resumeDownloads()" style="display: none;">‚ñ∂Ô∏è Resume</button>
                    <button class="btn btn-danger btn-sm" onclick="cancelAllDownloads()">‚èπÔ∏è Cancel All</button>
                </div>
                <div class="queue-container" id="mobile-download-queue" style="max-height: 50vh;">
                    <div class="queue-empty">
                        <div class="queue-empty-icon">üì≠</div>
                        <p>No active downloads</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile Log Modal -->
    <div class="modal" id="mobile-log-modal">
        <div class="modal-content" style="max-height: 80vh; overflow-y: auto;">
            <div class="modal-header">
                <h2>üìã Activity Log</h2>
                <button class="modal-close" onclick="closeModal('mobile-log-modal')">√ó</button>
            </div>
            <div class="modal-body" style="padding: 0;">
                <div class="log-container" id="mobile-log-container" style="max-height: 60vh;">
                    <div class="log-line">Waiting for activity...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="main-container">
        <!-- Left Column -->
        <div class="left-column">
            <!-- Browse Tab -->
            <div class="tab-content active" id="tab-browse">
                <div class="panel">
                    <div class="panel-header">
                        <h2 class="panel-title">
                            <span class="panel-title-icon">üìÅ</span>
                            <span data-i18n="remote_browser">Remote Browser</span>
                        </h2>
                        <div style="display: flex; gap: 0.5rem;">
                            <select id="server-select" class="form-input" style="width: auto; min-width: 180px; padding: 0.5rem 1rem;">
                                <option value="" data-i18n="select_server">Select Server...</option>
                            </select>
                            <button class="btn btn-secondary btn-sm" id="refresh-btn" data-tooltip="Refresh">üîÑ</button>
                        </div>
                    </div>
                    <div class="panel-body">
                        <div class="selection-bar" id="selection-bar">
                            <span class="selection-bar-text"><span id="selection-count">0</span> <span data-i18n="items_selected">items selected</span></span>
                            <div class="selection-bar-actions">
                                <button class="btn btn-secondary btn-sm" id="select-all-btn" data-i18n="select_all">Select All</button>
                                <button class="btn btn-sm" style="background: white; color: var(--jf-primary);" id="download-selected-btn" data-i18n="download_selected">Download Selected</button>
                                <button class="btn btn-secondary btn-sm" id="clear-selection-btn" data-i18n="clear">Clear</button>
                            </div>
                        </div>
                        
                        <div class="browser-path" id="browser-path">
                            <span class="browser-path-item" data-id="root">üè† <span data-i18n="home">Home</span></span>
                        </div>
                        
                        <!-- Search/Filter Box -->
                        <div class="search-box" id="search-box" style="margin-bottom: 0.75rem; display: none;">
                            <div style="display: flex; gap: 0.5rem;">
                                <input type="text" class="form-input" id="library-search" data-i18n-placeholder="search_library" placeholder="üîç Search library..." style="flex: 1;" onkeypress="if(event.key==='Enter')searchLibrary()">
                                <button class="btn btn-primary btn-sm" onclick="searchLibrary()" title="Search entire library">Search</button>
                                <button class="btn btn-secondary btn-sm" onclick="clearSearch()" title="Clear search and go back">‚úï</button>
                            </div>
                            <div id="search-status" style="font-size: 0.75rem; color: var(--jf-text-muted); margin-top: 0.25rem; display: none;"></div>
                        </div>
                        
                        <!-- Interaction Hints -->
                        <div class="interaction-hint" id="interaction-hint" style="display: none;">
                            <span>üëÜ Single-click to select</span>
                            <span>üëÜüëÜ Double-click to open folders</span>
                            <span>‚å®Ô∏è Ctrl+click for multi-select</span>
                        </div>
                        
                        <div class="browser-container">
                            <div class="browser-grid" id="browser-grid">
                                <div class="empty-state">
                                    <div class="empty-state-icon">üì°</div>
                                    <div class="empty-state-title" data-i18n="select_a_server">Select a Server</div>
                                    <p data-i18n="select_server_desc">Choose a remote server from the dropdown to browse its library.</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Pagination Controls -->
                        <div class="pagination-controls" id="pagination-controls" style="display: none;">
                            <div class="pagination-info">
                                <span id="pagination-info-text">Page 1 of 1</span>
                                <select id="items-per-page" class="form-input" style="width: auto; padding: 0.375rem 0.5rem; margin-left: 1rem;">
                                    <option value="25">25 per page</option>
                                    <option value="50" selected>50 per page</option>
                                    <option value="100">100 per page</option>
                                    <option value="200">200 per page</option>
                                </select>
                            </div>
                            <div class="pagination-buttons">
                                <button class="btn btn-sm" id="page-first" disabled>¬´</button>
                                <button class="btn btn-sm" id="page-prev" disabled>‚Äπ</button>
                                <span id="page-numbers"></span>
                                <button class="btn btn-sm" id="page-next" disabled>‚Ä∫</button>
                                <button class="btn btn-sm" id="page-last" disabled>¬ª</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sync Tab -->
            <div class="tab-content" id="tab-sync">
                <div class="panel">
                    <div class="panel-header">
                        <h2 class="panel-title">
                            <span class="panel-title-icon">üîÑ</span>
                            <span data-i18n="library_mappings">Library Mappings</span>
                        </h2>
                        <button class="btn btn-primary btn-sm" id="add-mapping-btn">+ <span data-i18n="add_mapping">Add Mapping</span></button>
                    </div>
                    <div class="panel-body">
                        <div id="mappings-list">
                            <div class="empty-state">
                                <div class="empty-state-icon">üó∫Ô∏è</div>
                                <div class="empty-state-title" data-i18n="no_mappings">No Mappings</div>
                                <p data-i18n="no_mappings_desc">Create a mapping to automatically sync content from remote libraries.</p>
                            </div>
                        </div>
                        
                        <div class="control-bar">
                            <button class="btn btn-primary" id="sync-now-btn" onclick="mobileSync()">
                                <span>üîÑ</span> <span data-i18n="sync_now">Sync Now</span>
                            </button>
                            <div class="toggle-container" style="flex: 1; justify-content: flex-end;">
                                <span class="toggle-label" data-i18n="auto_sync">Auto-Sync</span>
                                <label class="toggle" style="margin-left: 0.75rem;">
                                    <input type="checkbox" id="auto-sync-toggle" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                        
                        <!-- Skip List Section -->
                        <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--jf-border);">
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.75rem;">
                                <h3 style="margin: 0; font-size: 0.95rem;">üö´ Skip List</h3>
                                <button class="btn btn-xs btn-danger" onclick="clearSkipList()">Clear All</button>
                            </div>
                            <div class="form-hint" style="margin-bottom: 0.75rem;">
                                Items in this list will be excluded from auto-sync. Click the ‚è≠Ô∏è button on a Series or Movie poster to add/remove.
                            </div>
                            <div id="skip-list-items" style="max-height: 200px; overflow-y: auto;">
                                <div class="empty-state"><div class="empty-state-icon">‚úÖ</div><div>No items in skip list</div></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings Tab -->
            <div class="tab-content" id="tab-settings">
                <div class="panel">
                    <div class="panel-header">
                        <h2 class="panel-title">
                            <span class="panel-title-icon">‚öôÔ∏è</span>
                            <span data-i18n="configuration">Configuration</span>
                        </h2>
                    </div>
                    <div class="panel-body">
                        <!-- Appearance Section -->
                        <div class="settings-section">
                            <div class="settings-section-title"><span>üé®</span> <span data-i18n="appearance">Appearance</span></div>
                            <div class="toggle-container">
                                <span class="toggle-label" data-i18n="dark_theme">Dark Theme</span>
                                <label class="toggle">
                                    <input type="checkbox" id="theme-toggle-settings" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            <div class="form-hint" data-i18n="theme_hint">Switch between dark and light themes</div>
                            
                            <div class="form-group" style="margin-top: 1rem;">
                                <label class="form-label">üåê <span data-i18n="language">Language</span></label>
                                <div style="display: flex; gap: 0.5rem;">
                                    <select class="form-input" id="language-select" style="flex: 1;">
                                        <option value="en">English</option>
                                        <option value="es">Espa√±ol</option>
                                        <option value="de">Deutsch</option>
                                    </select>
                                    <button class="btn btn-primary" id="save-language-btn" data-i18n="save">Save</button>
                                </div>
                                <div class="form-hint" data-i18n="language_hint">Interface language (page will refresh)</div>
                            </div>
                        </div>

                        <!-- Remote Servers Section -->
                        <div class="settings-section">
                            <div class="settings-section-title"><span>üì°</span> <span data-i18n="remote_servers">Remote Servers</span></div>
                            <div class="server-list" id="settings-server-list"></div>
                            <button class="btn btn-primary" style="width: 100%; margin-top: 0.75rem;" id="add-server-btn">
                                + <span data-i18n="add_remote_server">Add Remote Server</span>
                            </button>
                        </div>

                        <!-- Local Server Section -->
                        <div class="settings-section">
                            <div class="settings-section-title"><span>üè†</span> <span data-i18n="local_server">Local Server</span> (<span data-i18n="duplicate_detection">Duplicate Detection</span>)</div>
                            <div id="local-server-info">
                                <div class="empty-state" style="padding: 1.5rem;">
                                    <p data-i18n="no_local_server">No local server configured. Add one to detect existing content.</p>
                                    <button class="btn btn-secondary btn-sm" style="margin-top: 0.75rem;" id="add-local-btn" data-i18n="configure_local">Configure Local Server</button>
                                </div>
                            </div>
                        </div>

                        <!-- Advanced Settings -->
                        <button class="advanced-toggle" id="advanced-toggle">
                            <span class="advanced-toggle-icon">‚ñº</span>
                            <span data-i18n="advanced_settings">Advanced Settings</span>
                        </button>
                        <div class="advanced-content" id="advanced-content">
                            <div class="form-group">
                                <label class="form-label" data-i18n="speed_limit">Speed Limit (KB/s)</label>
                                <input type="number" class="form-input" id="speed-limit" min="0" placeholder="0 = unlimited">
                                <div class="form-hint" data-i18n="speed_limit_hint">Set to 0 for unlimited speed</div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label" data-i18n="sync_time">Sync Time</label>
                                    <input type="time" class="form-input" id="sync-time" value="04:00">
                                </div>
                                <div class="form-group">
                                    <label class="form-label" data-i18n="max_downloads">Max Downloads</label>
                                    <input type="number" class="form-input" id="max-downloads" min="1" max="10" value="2">
                                    <div class="form-hint" id="max-downloads-hint" style="display: none;">
                                        <span style="color: var(--jf-warning);">‚ö†Ô∏è Free tier limited to 2 concurrent downloads</span>
                                    </div>
                                </div>
                            </div>
                            <div class="toggle-container pro-feature-toggle" style="margin-bottom: 0.75rem;">
                                <span class="toggle-label">‚ö° Override download limit (allows &gt;10) <span class="pro-badge-small">PRO</span></span>
                                <label class="toggle">
                                    <input type="checkbox" id="override-download-limit" onchange="toggleDownloadLimitOverride()">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            <div id="download-limit-warning" style="display: none; padding: 0.75rem; background: rgba(255, 59, 48, 0.15); border: 1px solid var(--jf-danger); border-radius: var(--radius); margin-bottom: 1rem;">
                                <div style="font-size: 0.85rem; color: var(--jf-danger); font-weight: 600;">‚ö†Ô∏è WARNING: High concurrent downloads can:</div>
                                <ul style="margin: 0.5rem 0 0 1rem; font-size: 0.8rem; color: var(--jf-text-muted);">
                                    <li>Overload the remote server</li>
                                    <li>Cause your account to be rate-limited or banned</li>
                                    <li>Negatively affect other users on shared servers</li>
                                    <li>Consume excessive bandwidth and system resources</li>
                                </ul>
                                <div style="font-size: 0.75rem; margin-top: 0.5rem; color: var(--jf-warning);">Use with caution. You have been warned!</div>
                            </div>
                            <div class="toggle-container" style="margin-bottom: 0.75rem;">
                                <span class="toggle-label">üîÑ Auto-retry failed downloads</span>
                                <label class="toggle">
                                    <input type="checkbox" id="download-auto-retry" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Retry attempts</label>
                                    <input type="number" class="form-input" id="download-retry-count" min="1" max="10" value="3">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Retry delay (seconds)</label>
                                    <input type="number" class="form-input" id="download-retry-delay" min="5" max="300" value="30">
                                </div>
                            </div>
                            <div class="form-hint" style="margin-bottom: 1rem;">
                                Automatically retry downloads that fail due to connection errors or timeouts.
                            </div>
                            <div class="form-group">
                                <label class="form-label" data-i18n="timezone">Timezone</label>
                                <select class="form-input" id="timezone">
                                    <option value="UTC">UTC</option>
                                    <option value="America/New_York">Eastern Time (US)</option>
                                    <option value="America/Chicago">Central Time (US)</option>
                                    <option value="America/Denver">Mountain Time (US)</option>
                                    <option value="America/Los_Angeles">Pacific Time (US)</option>
                                    <option value="America/Phoenix">Arizona (US)</option>
                                    <option value="America/Anchorage">Alaska (US)</option>
                                    <option value="Pacific/Honolulu">Hawaii (US)</option>
                                    <option value="America/Toronto">Eastern Time (Canada)</option>
                                    <option value="America/Vancouver">Pacific Time (Canada)</option>
                                    <option value="Europe/London">London (UK)</option>
                                    <option value="Europe/Paris">Paris (France)</option>
                                    <option value="Europe/Berlin">Berlin (Germany)</option>
                                    <option value="Europe/Amsterdam">Amsterdam (Netherlands)</option>
                                    <option value="Europe/Rome">Rome (Italy)</option>
                                    <option value="Europe/Madrid">Madrid (Spain)</option>
                                    <option value="Europe/Moscow">Moscow (Russia)</option>
                                    <option value="Asia/Tokyo">Tokyo (Japan)</option>
                                    <option value="Asia/Shanghai">Shanghai (China)</option>
                                    <option value="Asia/Hong_Kong">Hong Kong</option>
                                    <option value="Asia/Singapore">Singapore</option>
                                    <option value="Asia/Seoul">Seoul (Korea)</option>
                                    <option value="Asia/Kolkata">India (IST)</option>
                                    <option value="Asia/Dubai">Dubai (UAE)</option>
                                    <option value="Australia/Sydney">Sydney (Australia)</option>
                                    <option value="Australia/Melbourne">Melbourne (Australia)</option>
                                    <option value="Australia/Perth">Perth (Australia)</option>
                                    <option value="Pacific/Auckland">Auckland (New Zealand)</option>
                                    <option value="America/Sao_Paulo">S√£o Paulo (Brazil)</option>
                                    <option value="America/Mexico_City">Mexico City</option>
                                </select>
                                <div class="form-hint" data-i18n="timezone_hint">Affects log timestamps and scheduling</div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Time Format</label>
                                <select class="form-input" id="time-format">
                                    <option value="12h">12-hour (1:30 PM)</option>
                                    <option value="24h">24-hour (13:30)</option>
                                </select>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label" data-i18n="connection_timeout">Connection Timeout (s)</label>
                                    <input type="number" class="form-input" id="connection-timeout" min="5" max="120" value="30">
                                </div>
                                <div class="form-group">
                                    <label class="form-label" data-i18n="chunk_size">Chunk Size (KB)</label>
                                    <input type="number" class="form-input" id="chunk-size" min="16" max="1024" value="64">
                                </div>
                            </div>
                            <div class="toggle-container">
                                <span class="toggle-label" data-i18n="confirm_downloads">Confirm before downloading</span>
                                <label class="toggle">
                                    <input type="checkbox" id="confirm-downloads">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            <div class="toggle-container">
                                <span class="toggle-label" data-i18n="show_notifications">Show notifications</span>
                                <label class="toggle">
                                    <input type="checkbox" id="show-notifications" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            <div class="toggle-container">
                                <span class="toggle-label" data-i18n="show_ratings">Show ratings on posters</span>
                                <label class="toggle">
                                    <input type="checkbox" id="show-ratings" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            <div class="toggle-container">
                                <span class="toggle-label" data-i18n="show_quality">Show quality badges (4K, HDR, etc)</span>
                                <label class="toggle">
                                    <input type="checkbox" id="show-quality" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            <!-- Folder Naming Format -->
                            <div class="form-group">
                                <label class="form-label">üìÅ Folder Naming Format</label>
                                <select class="form-input" id="folder-naming-format">
                                    <option value="standard">Standard - Show Name / Movie (2010)</option>
                                    <option value="ids_space">IDs (Space) - Show Name tt1234567 76885</option>
                                    <option value="ids_braces">IDs (Braces) - Show Name {imdb-tt1234567} {tvdb-76885}</option>
                                    <option value="ids_brackets">IDs (Brackets) - Show Name [imdb-tt1234567]</option>
                                    <option value="tmdb_only">TMDB Only - Show Name {tmdb-12345}</option>
                                    <option value="imdb_only">IMDB Only - Show Name tt1234567</option>
                                </select>
                            </div>
                            <div class="form-hint" style="margin-top: -0.25rem; margin-bottom: 0.5rem;">
                                Choose how folder names are formatted. IDs help Jellyfin/Plex/Sonarr/Radarr identify media correctly.
                            </div>
                            <div style="background: var(--jf-bg-input); padding: 0.75rem; border-radius: var(--radius); margin-bottom: 1rem; font-size: 0.8rem; font-family: monospace;">
                                <strong>Preview:</strong><br>
                                <span id="folder-format-preview-movie">Movie: Inception (2010)</span><br>
                                <span id="folder-format-preview-show">Show: Breaking Bad</span>
                            </div>
                            
                            <!-- Metadata API Settings -->
                            <div style="margin-top: 1rem; padding: 1rem; background: var(--jf-bg-input); border-radius: var(--radius); border: 1px solid var(--jf-border);">
                                <h4 style="font-size: 0.85rem; margin: 0 0 0.75rem 0;">üîç Metadata API Keys (Optional)</h4>
                                <div class="form-hint" style="margin-bottom: 0.75rem;">
                                    When the remote server is missing IMDB/TVDB IDs, JellyLooter can look them up from external APIs. Get free API keys from:
                                    <a href="https://www.themoviedb.org/settings/api" target="_blank" style="color: var(--jf-primary);">TMDB</a>,
                                    <a href="https://thetvdb.com/api-information" target="_blank" style="color: var(--jf-primary);">TVDB</a>,
                                    <a href="https://www.omdbapi.com/apikey.aspx" target="_blank" style="color: var(--jf-primary);">OMDb</a>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">TMDB API Key</label>
                                        <input type="password" class="form-input" id="tmdb-api-key" placeholder="Movies & TV metadata">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">TVDB API Key</label>
                                        <input type="password" class="form-input" id="tvdb-api-key" placeholder="TV shows & anime">
                                    </div>
                                </div>
                                <div class="form-group" style="margin-top: 0.5rem;">
                                    <label class="form-label">OMDb API Key</label>
                                    <input type="password" class="form-input" id="omdb-api-key" placeholder="IMDB data fallback">
                                </div>
                                <div class="toggle-container" style="margin-top: 0.75rem;">
                                    <span class="toggle-label">üé¨ IMDB Direct Lookup (no API key needed)</span>
                                    <label class="toggle">
                                        <input type="checkbox" id="imdb-lookup-enabled" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="form-hint" style="margin-top: 0.25rem;">
                                    Uses IMDB's suggestion API as a fallback when other APIs don't return an IMDB ID.
                                </div>
                                <div class="toggle-container" style="margin-top: 0.75rem;">
                                    <span class="toggle-label">üîé Lookup metadata while browsing</span>
                                    <label class="toggle">
                                        <input type="checkbox" id="metadata-lookup-on-browse">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="form-hint" style="margin-top: 0.25rem;">
                                    <strong>ON:</strong> Slower browsing, but IDs are shown before download.<br>
                                    <strong>OFF:</strong> Faster browsing, IDs fetched only at download time.
                                </div>
                                <div class="pro-badge-inline" style="margin-top: 0.75rem; padding: 0.5rem; background: var(--jf-bg-card); border-radius: var(--radius); font-size: 0.8rem;">
                                    ‚≠ê <strong>Pro Feature:</strong> Metadata caching - stores lookups locally for faster repeat browsing.
                                </div>
                            </div>
                            
                            <div class="toggle-container" style="margin-top: 1rem;">
                                <span class="toggle-label" data-i18n="download_subtitles">üìù Download subtitles automatically</span>
                                <label class="toggle">
                                    <input type="checkbox" id="download-subtitles" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            <div class="form-group" id="subtitle-languages-group" style="margin-top: 0.5rem;">
                                <label class="form-label" data-i18n="subtitle_languages">Subtitle Languages (ISO codes)</label>
                                <input type="text" class="form-input" id="subtitle-languages" value="eng, spa, ger" placeholder="eng, spa, ger, fre">
                                <div class="form-hint" data-i18n="subtitle_hint">Comma-separated language codes. Use "all" to download all available subtitles.</div>
                            </div>
                            <button class="btn btn-primary" style="width: 100%; margin-top: 1rem;" id="save-settings-btn" data-i18n="save_settings">Save Settings</button>
                            
                            <!-- Config Backup/Restore -->
                            <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--jf-border);">
                                <h4 style="font-size: 0.9rem; margin-bottom: 0.75rem;">üíæ Backup & Restore</h4>
                                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                    <button class="btn btn-secondary btn-sm" onclick="exportConfig()">
                                        üì§ Export Config
                                    </button>
                                    <label class="btn btn-secondary btn-sm" style="cursor: pointer;">
                                        üì• Import Config
                                        <input type="file" id="import-config-file" accept=".json" style="display: none;" onchange="importConfig(event)">
                                    </label>
                                </div>
                                <div class="form-hint" style="margin-top: 0.5rem;">
                                    Export saves settings (API keys masked). Import restores settings while preserving existing API keys.
                                </div>
                            </div>
                        </div>
                        
                        <!-- Security Settings -->
                        <button class="advanced-toggle" id="security-toggle" style="margin-top: 1rem;">
                            <span class="advanced-toggle-icon">‚ñº</span>
                            <span data-i18n="security_settings">üîí Security Settings</span>
                        </button>
                        <div class="advanced-content" id="security-content" style="display: none;">
                            <div class="toggle-container">
                                <span class="toggle-label" data-i18n="enable_auth">Enable Authentication</span>
                                <label class="toggle">
                                    <input type="checkbox" id="auth-enabled">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            <div class="form-hint" data-i18n="auth_hint">Require login to access JellyLooter</div>
                            
                            <div class="form-group" style="margin-top: 1rem;">
                                <label class="form-label" data-i18n="session_timeout">Session Timeout (minutes)</label>
                                <input type="number" class="form-input" id="session-timeout" min="5" max="1440" value="30">
                            </div>
                            
                            <div class="toggle-container" style="margin-top: 1rem;">
                                <span class="toggle-label" data-i18n="trust_proxy">Trust X-Forwarded headers</span>
                                <label class="toggle">
                                    <input type="checkbox" id="trust-proxy">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            <div class="form-hint" data-i18n="trust_proxy_hint">Enable if using a reverse proxy (Nginx, Traefik, etc.) to get correct client IPs</div>
                            
                            <div class="form-group" style="margin-top: 1rem;">
                                <label class="form-label" data-i18n="trusted_proxies">Trusted Proxy IPs</label>
                                <input type="text" class="form-input" id="trusted-proxies" placeholder="172.17.0.0/16, 10.0.0.0/8">
                                <div class="form-hint" data-i18n="trusted_proxies_hint">Comma-separated list of IP ranges allowed to set X-Forwarded headers</div>
                            </div>
                            
                            <button class="btn btn-primary" style="width: 100%; margin-top: 1rem;" id="save-security-btn" data-i18n="save_security">Save Security Settings</button>
                        </div>
                        
                        <!-- Pro Settings -->
                        <button class="advanced-toggle pro-settings-toggle" id="pro-toggle" style="margin-top: 1rem;">
                            <span class="advanced-toggle-icon">‚ñº</span>
                            <span data-i18n="pro_features">‚≠ê Pro Settings</span>
                            <span class="pro-badge" id="pro-badge" style="display: none;">PRO</span>
                        </button>
                        <div class="advanced-content" id="pro-content" style="display: none;">
                            <!-- License Status -->
                            <div class="license-status-box" id="license-status-box">
                                <div id="license-status-text">Loading...</div>
                            </div>
                            
                            <!-- Notifications (Pro) -->
                            <div class="pro-section" id="notifications-section">
                                <h4 style="margin: 1rem 0 0.5rem; font-size: 0.9rem;" data-i18n="notifications">üîî Notifications</h4>
                                <div class="form-group">
                                    <label class="form-label" data-i18n="notification_urls">Notification URLs (Apprise)</label>
                                    <textarea class="form-input" id="notification-urls" rows="3" placeholder="discord://webhook_id/webhook_token&#10;telegram://bot_token/chat_id"></textarea>
                                    <div class="form-hint"><span data-i18n="notification_hint">One URL per line.</span> <a href="https://github.com/caronc/apprise/wiki" target="_blank">Apprise docs</a></div>
                                </div>
                                <div class="toggle-container">
                                    <span class="toggle-label" data-i18n="notify_complete">Notify on download complete</span>
                                    <label class="toggle">
                                        <input type="checkbox" id="notify-complete" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="toggle-container">
                                    <span class="toggle-label">Notify on errors</span>
                                    <label class="toggle">
                                        <input type="checkbox" id="notify-error" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                            </div>
                            
                            <!-- Transcoding (Pro) -->
                            <div class="pro-section" id="transcode-section">
                                <h4 style="margin: 1rem 0 0.5rem; font-size: 0.9rem;">üé¨ Transcoding</h4>
                                <p style="font-size: 0.8rem; color: var(--jf-text-muted); margin: 0 0 0.75rem;">Automatically convert downloaded media to your preferred format.</p>
                                
                                <div class="toggle-container">
                                    <span class="toggle-label">Enable transcoding</span>
                                    <label class="toggle">
                                        <input type="checkbox" id="transcode-enabled-test">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="form-group" style="margin-top: 0.5rem;">
                                    <label class="form-label">Encoder</label>
                                    <select class="form-input" id="transcode-encoder-test">
                                        <option value="software">Software (libx264/libx265)</option>
                                        <option value="nvenc">NVIDIA NVENC</option>
                                        <option value="qsv">Intel QuickSync</option>
                                        <option value="vaapi">AMD VAAPI</option>
                                    </select>
                                </div>
                                <div class="form-group" style="margin-top: 0.5rem;">
                                    <label class="form-label">Preset</label>
                                    <select class="form-input" id="transcode-preset-test">
                                        <option value="original">Original (no transcode)</option>
                                        <option value="h264">H.264 (compatible)</option>
                                        <option value="h265">H.265/HEVC (smaller)</option>
                                        <option value="avi">AVI (legacy compatible)</option>
                                        <option value="mobile">Mobile (720p)</option>
                                        <option value="4k">4K Optimized</option>
                                    </select>
                                </div>
                                <div class="form-group" style="margin-top: 0.5rem;">
                                    <label class="form-label">Concurrent Transcode Workers</label>
                                    <input type="number" class="form-input" id="max-transcodes" min="1" max="5" value="1">
                                    <div class="form-hint">Number of files to transcode simultaneously (1-5)</div>
                                </div>
                                <div class="toggle-container" style="margin-top: 0.5rem;">
                                    <span class="toggle-label">Skip if transcoded file is larger</span>
                                    <label class="toggle">
                                        <input type="checkbox" id="transcode-skip-larger" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="form-hint">Keep original file if transcoding increases size</div>
                                
                                <!-- Cache Drive Option -->
                                <div class="toggle-container" style="margin-top: 1rem;">
                                    <span class="toggle-label">üíæ Use cache drive for transcoding</span>
                                    <label class="toggle">
                                        <input type="checkbox" id="transcode-cache-enabled" onchange="toggleTranscodeCachePath()">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="form-hint">Transcode to fast SSD/local drive, then move to destination</div>
                                <div id="transcode-cache-path-group" style="display: none; margin-top: 0.5rem;">
                                    <label class="form-label">Cache Path</label>
                                    <input type="text" class="form-input" id="transcode-cache-path" value="/tmp/transcode_cache" placeholder="/tmp/transcode_cache">
                                    <div class="form-hint" style="font-size: 0.75rem;">
                                        ‚ö° <strong>Benefits:</strong> Faster I/O on SSD, reduces wear on destination drives, better for network storage
                                    </div>
                                    <div style="margin-top: 0.75rem; padding: 0.5rem; background: var(--jf-bg-card); border-radius: var(--radius); display: flex; align-items: center; justify-content: space-between;">
                                        <div style="font-size: 0.8rem;">
                                            <span style="color: var(--jf-text-muted);">Cache status:</span>
                                            <span id="transcode-cache-status">Unknown</span>
                                        </div>
                                        <button class="btn btn-secondary btn-xs" onclick="clearTranscodeCache()" title="Clear partial/failed transcode files">üóëÔ∏è Clear Cache</button>
                                    </div>
                                </div>
                                
                                <!-- Transcode Stats -->
                                <div id="transcode-stats-display" style="margin-top: 1rem; padding: 0.75rem; background: var(--jf-bg-input); border-radius: var(--radius);">
                                    <div style="font-weight: 600; margin-bottom: 0.5rem; font-size: 0.85rem;">üìä Transcode Statistics</div>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; font-size: 0.8rem;">
                                        <div>Files transcoded:</div><div id="transcode-stat-files">0</div>
                                        <div>Files skipped (larger):</div><div id="transcode-stat-skipped">0</div>
                                        <div>Space saved:</div><div id="transcode-stat-saved" style="color: var(--jf-success);">0 B</div>
                                        <div>Avg reduction:</div><div id="transcode-stat-percent">0%</div>
                                    </div>
                                    <button class="btn btn-secondary btn-xs" style="margin-top: 0.5rem;" onclick="resetTranscodeStats()">üîÑ Reset Stats</button>
                                </div>
                                
                                <!-- Hidden inputs to preserve settings -->
                                <input type="hidden" id="transcode-enabled" value="false">
                                <input type="hidden" id="transcode-encoder" value="software">
                                <input type="hidden" id="transcode-preset" value="original">
                                <input type="hidden" id="transcode-custom" value="">
                            </div>
                            
                            <!-- Scheduling (Pro) -->
                            <div class="pro-section" id="schedule-section">
                                <h4 style="margin: 1rem 0 0.5rem; font-size: 0.9rem;">üìÖ Scheduling</h4>
                                <div class="toggle-container">
                                    <span class="toggle-label">Download schedule</span>
                                    <label class="toggle">
                                        <input type="checkbox" id="schedule-enabled">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="form-row" style="margin-top: 0.5rem;">
                                    <div class="form-group">
                                        <label class="form-label">Start time</label>
                                        <input type="time" class="form-input" id="schedule-start" value="02:00">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">End time</label>
                                        <input type="time" class="form-input" id="schedule-end" value="06:00">
                                    </div>
                                </div>
                                <div class="form-hint">Downloads only run between these times</div>
                                
                                <div class="toggle-container" style="margin-top: 1rem;">
                                    <span class="toggle-label">Bandwidth schedule</span>
                                    <label class="toggle">
                                        <input type="checkbox" id="bandwidth-schedule-enabled">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="form-row" style="margin-top: 0.5rem;">
                                    <div class="form-group">
                                        <label class="form-label">Day limit (KB/s)</label>
                                        <input type="number" class="form-input" id="bandwidth-day" min="0" value="1000">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Night limit (KB/s)</label>
                                        <input type="number" class="form-input" id="bandwidth-night" min="0" value="0" placeholder="0 = unlimited">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- *arr Integration (Pro) -->
                            <div class="pro-section" id="arr-section">
                                <h4 style="margin: 1rem 0 0.5rem; font-size: 0.9rem;">üì∫ *arr Integration</h4>
                                <div class="form-hint" style="margin-bottom: 1rem; padding: 0.75rem; background: var(--jf-bg-input); border-radius: var(--radius);">
                                    <strong>Benefits:</strong>
                                    <ul style="margin: 0.5rem 0 0 1rem; font-size: 0.8rem;">
                                        <li>Auto-add movies/shows to *arr after download</li>
                                        <li>Auto-trigger library scans to import files</li>
                                        <li>Use *arr naming conventions for folders</li>
                                        <li>Sync metadata and organize files properly</li>
                                    </ul>
                                </div>
                                
                                <div class="toggle-container" style="margin-bottom: 1rem;">
                                    <span class="toggle-label">üîÑ Auto-import to *arr after download</span>
                                    <label class="toggle">
                                        <input type="checkbox" id="arr-auto-import" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="form-hint" style="margin-bottom: 1rem;">
                                    When enabled, downloads will be automatically added to Radarr/Sonarr and library scans triggered.
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Sonarr URL</label>
                                    <input type="text" class="form-input" id="sonarr-url" placeholder="http://localhost:8989">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Sonarr API Key</label>
                                    <input type="password" class="form-input" id="sonarr-key" placeholder="API key">
                                </div>
                                <button class="btn btn-secondary btn-sm" onclick="testArrConnection('sonarr')" style="margin-bottom: 1rem;">Test Sonarr</button>
                                
                                <div class="form-group">
                                    <label class="form-label">Radarr URL</label>
                                    <input type="text" class="form-input" id="radarr-url" placeholder="http://localhost:7878">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Radarr API Key</label>
                                    <input type="password" class="form-input" id="radarr-key" placeholder="API key">
                                </div>
                                <button class="btn btn-secondary btn-sm" onclick="testArrConnection('radarr')">Test Radarr</button>
                                
                                <div style="margin-top: 1.5rem; padding: 1rem; background: var(--jf-bg-input); border-radius: var(--radius); border: 1px solid var(--jf-border);">
                                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem;">
                                        <h5 style="margin: 0; font-size: 0.85rem; font-weight: 600;">üîÄ Library Path Mappings</h5>
                                        <button class="btn btn-secondary btn-sm" onclick="fetchArrPathMappings()">üîÑ Auto-Detect Paths</button>
                                    </div>
                                    
                                    <div class="form-hint" style="margin-bottom: 0.75rem; font-size: 0.8rem;">
                                        Click "Auto-Detect Paths" to scan your filesystem and find where Sonarr/Radarr folders exist. ‚úÖ = found, ‚ö†Ô∏è = not found.
                                    </div>
                                    
                                    <div id="arr-path-mappings-status" style="margin-bottom: 0.75rem; font-size: 0.8rem; color: var(--jf-text-muted);">
                                        No mappings loaded. Save API keys and click "Auto-Detect Paths".
                                    </div>
                                    
                                    <div id="arr-path-mappings" style="margin-bottom: 0.75rem;">
                                        <!-- Mappings will be rendered here -->
                                    </div>
                                    
                                    <button class="btn btn-secondary btn-sm" onclick="addPathMapping()" style="margin-right: 0.5rem;">
                                        ‚ûï Add Manual Mapping
                                    </button>
                                </div>
                                
                                <div style="margin-top: 1rem; padding: 0.75rem; background: var(--jf-bg-input); border-radius: var(--radius);">
                                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem;">
                                        <span style="font-weight: 600; font-size: 0.85rem;">üìÅ Folder Name Cache</span>
                                        <button class="btn btn-secondary btn-sm" onclick="refreshArrCache()">üîÑ Refresh</button>
                                    </div>
                                    <div id="arr-cache-status" style="font-size: 0.8rem; color: var(--jf-text-muted);">
                                        Loading...
                                    </div>
                                    <div style="font-size: 0.75rem; color: var(--jf-text-muted); margin-top: 0.5rem;">
                                        üí° Save Pro Settings before clicking Refresh to cache folder names.
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Themes (Pro) -->
                            <div class="pro-section" id="themes-section">
                                <h4 style="margin: 1rem 0 0.5rem; font-size: 0.9rem;">üé® Custom Themes</h4>
                                <div class="form-group">
                                    <label class="form-label">Theme</label>
                                    <select class="form-input" id="custom-theme-select">
                                        <option value="default">Default (JellyLooter)</option>
                                        <option value="jellyfin">Jellyfin Theme</option>
                                        <option value="plex">Plex Theme</option>
                                        <option value="emby">Emby Theme</option>
                                        <optgroup label="üå∏ Seasonal">
                                            <option value="winter">‚ùÑÔ∏è Winter</option>
                                            <option value="spring">üå∑ Spring</option>
                                            <option value="summer">‚òÄÔ∏è Summer</option>
                                            <option value="fall">üçÇ Fall / Autumn</option>
                                        </optgroup>
                                        <optgroup label="üéâ Holidays">
                                            <option value="christmas">üéÑ Christmas</option>
                                            <option value="halloween">üéÉ Halloween</option>
                                            <option value="valentines">üíï Valentine's Day</option>
                                            <option value="stpatricks">‚òòÔ∏è St. Patrick's Day</option>
                                            <option value="july4th">üá∫üá∏ 4th of July</option>
                                        </optgroup>
                                        <option value="custom">üé® Custom Colors</option>
                                    </select>
                                </div>
                                <div id="custom-colors-group" style="display: none; margin-top: 0.5rem;">
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label class="form-label">Primary Color</label>
                                            <input type="color" class="form-input" id="theme-primary" value="#00a4dc" style="height: 40px; padding: 2px;" title="Buttons, links, accents">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Accent Color</label>
                                            <input type="color" class="form-input" id="theme-accent" value="#aa5cc3" style="height: 40px; padding: 2px;" title="Secondary accents, gradients">
                                        </div>
                                    </div>
                                    <div class="form-row" style="margin-top: 0.5rem;">
                                        <div class="form-group">
                                            <label class="form-label">Background</label>
                                            <input type="color" class="form-input" id="theme-bg" value="#101010" style="height: 40px; padding: 2px;" title="Main background">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Card Background</label>
                                            <input type="color" class="form-input" id="theme-card" value="#1a1a1a" style="height: 40px; padding: 2px;" title="Cards, panels, modals">
                                        </div>
                                    </div>
                                    <div class="form-row" style="margin-top: 0.5rem;">
                                        <div class="form-group">
                                            <label class="form-label">Input Background</label>
                                            <input type="color" class="form-input" id="theme-input" value="#2a2a2a" style="height: 40px; padding: 2px;" title="Input fields, buttons">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Border Color</label>
                                            <input type="color" class="form-input" id="theme-border" value="#333333" style="height: 40px; padding: 2px;" title="Borders, dividers">
                                        </div>
                                    </div>
                                    <button class="btn btn-secondary btn-sm" onclick="applyCustomTheme()" style="margin-top: 0.5rem;">Apply Custom Theme</button>
                                </div>
                            </div>
                            
                            <!-- Multiple Local Servers (Pro) -->
                            <div class="pro-section" id="multi-local-section">
                                <h4 style="margin: 1rem 0 0.5rem; font-size: 0.9rem;">üè† Multiple Local Servers</h4>
                                <div class="form-hint" style="margin-bottom: 0.75rem;">
                                    Connect multiple local Jellyfin/Emby servers for unified duplicate detection across your network.
                                </div>
                                <div id="local-servers-list" style="margin-bottom: 0.5rem;"></div>
                                <button class="btn btn-secondary btn-sm" onclick="openModal('local-server-modal')">+ Add Local Server</button>
                            </div>
                            
                            <button class="btn btn-primary" style="width: 100%; margin-top: 1rem;" id="save-pro-btn">Save Pro Settings</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column -->
        <div class="right-column" id="right-column">
            <!-- Mobile toggle bar -->
            <div class="right-column-toggle" id="right-column-toggle"></div>
            
            <!-- Stats -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="stat-active">0</div>
                    <div class="stat-label" data-i18n="active">Active</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="stat-pending">0</div>
                    <div class="stat-label" data-i18n="pending">Pending</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="stat-cached">0</div>
                    <div class="stat-label" data-i18n="cached">Cached</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="stat-cache-time">Never</div>
                    <div class="stat-label" data-i18n="last_scan">Last Scan</div>
                </div>
            </div>

            <!-- Scan Progress -->
            <div class="scan-progress" id="scan-progress" style="display: none;">
                <div class="scan-progress-header">
                    <span data-i18n="scanning">Scanning local library...</span>
                    <span id="scan-percent">0%</span>
                </div>
                <div class="scan-progress-bar">
                    <div class="scan-progress-fill" id="scan-fill" style="width: 0%"></div>
                </div>
            </div>

            <!-- Download Statistics Widget -->
            <div class="stats-widget" id="stats-widget">
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="stat-total-downloaded">0 GB</div>
                        <div class="stat-label">Total Downloaded</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="stat-today">0</div>
                        <div class="stat-label">Today</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="stat-speed">0 KB/s</div>
                        <div class="stat-label">Current Speed</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="stat-queue">0</div>
                        <div class="stat-label">In Queue</div>
                    </div>
                </div>
            </div>

            <!-- Download Queue -->
            <div class="panel" id="panel-downloads" data-panel-id="downloads">
                <div class="panel-header" onclick="togglePanelCollapse(this.parentElement)">
                    <h2 class="panel-title">
                        <span class="panel-collapse-icon">‚ñº</span>
                        <span class="panel-title-icon">‚¨áÔ∏è</span>
                        <span data-i18n="downloads">Downloads</span>
                    </h2>
                    <div class="panel-controls" onclick="event.stopPropagation()">
                        <button class="btn btn-secondary btn-sm" id="pause-btn" title="Pause All">‚è∏Ô∏è</button>
                        <button class="btn btn-secondary btn-sm" id="resume-btn" style="display: none;" title="Resume All">‚ñ∂Ô∏è</button>
                        <button class="btn btn-secondary btn-sm" id="stop-after-btn" title="Stop after current" onclick="stopAfterCurrent()">üõë</button>
                        <button class="btn btn-danger btn-sm" id="cancel-all-btn" title="Cancel All">‚èπÔ∏è</button>
                    </div>
                </div>
                <div class="panel-body">
                    <div class="queue-container" id="download-queue">
                        <div class="queue-empty">
                            <div class="queue-empty-icon">üì≠</div>
                            <p data-i18n="no_active_downloads">No active downloads</p>
                        </div>
                    </div>
                    <!-- Resumable Downloads (Pro feature) -->
                    <div id="resumable-downloads" class="resumable-section" style="display: none;">
                        <div class="resumable-header">
                            <span>üîÑ Resumable Downloads</span>
                            <span class="pro-badge">PRO</span>
                        </div>
                        <div id="resumable-list"></div>
                    </div>
                </div>
            </div>

            <!-- Log Panel -->
            <div class="panel" id="panel-log" data-panel-id="log" style="margin-top: 1rem;">
                <div class="panel-header" onclick="togglePanelCollapse(this.parentElement)">
                    <h2 class="panel-title">
                        <span class="panel-collapse-icon">‚ñº</span>
                        <span class="panel-title-icon">üìã</span>
                        <span data-i18n="activity_log">Activity Log</span>
                    </h2>
                    <div class="panel-controls" onclick="event.stopPropagation()" style="flex-wrap: wrap; gap: 0.25rem;">
                        <select class="form-input" id="log-view-mode" style="width: auto; padding: 0.2rem 0.4rem; font-size: 0.7rem;">
                            <option value="basic">Basic</option>
                            <option value="advanced">Advanced</option>
                        </select>
                        <button class="btn btn-secondary btn-sm" onclick="copyLogs()" title="Copy Logs to Clipboard">üìã</button>
                        <button class="btn btn-secondary btn-sm" id="toggle-history-btn" title="Download History">üìú</button>
                        <button class="btn btn-secondary btn-sm" id="rebuild-cache-btn" onclick="mobileRebuildCache()" title="Rebuild Local Cache">üîÑ</button>
                    </div>
                </div>
                <div class="panel-body" style="padding: 0;">
                    <div class="log-container" id="log-container">
                        <div class="log-line">Waiting for activity...</div>
                    </div>
                    <div class="history-container" id="history-container" style="display: none;">
                        <div class="log-line">No download history yet...</div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>

    <!-- Modals -->
    <!-- Server Modal -->
    <div class="modal" id="server-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" data-i18n="add_remote_server">Add Remote Server</h3>
                <button class="modal-close" onclick="closeModal('server-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label" data-i18n="server_name">Server Name</label>
                    <input type="text" class="form-input" id="server-name" placeholder="My Jellyfin Server">
                </div>
                <div class="form-group">
                    <label class="form-label" data-i18n="server_url">Server URL</label>
                    <input type="text" class="form-input" id="server-url" placeholder="http://192.168.1.100:8096">
                </div>
                <div class="form-group">
                    <label class="form-label" data-i18n="auth_method">Authentication Method</label>
                    <select class="form-input" id="auth-method">
                        <option value="key" data-i18n="api_key">API Key</option>
                        <option value="creds" data-i18n="username_password">Username/Password</option>
                    </select>
                </div>
                <div id="auth-key-fields">
                    <div class="form-group">
                        <label class="form-label" data-i18n="api_key">API Key</label>
                        <input type="text" class="form-input" id="server-key" placeholder="Enter API key">
                    </div>
                </div>
                <div id="auth-creds-fields" style="display: none;">
                    <div class="form-group">
                        <label class="form-label" data-i18n="username">Username</label>
                        <input type="text" class="form-input" id="server-username" placeholder="Username">
                    </div>
                    <div class="form-group">
                        <label class="form-label" data-i18n="password">Password</label>
                        <input type="password" class="form-input" id="server-password" placeholder="Password">
                    </div>
                </div>
                <div class="form-hint" style="margin-top: 1rem; text-align: center;" data-i18n="test_before_adding">‚ö†Ô∏è Test the connection before adding the server</div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('server-modal')" data-i18n="cancel">Cancel</button>
                <button class="btn btn-secondary" onclick="testServerConnection()" data-i18n="test_connection">Test Connection</button>
                <button class="btn btn-primary" onclick="saveServer()" data-i18n="add_server">Add Server</button>
            </div>
        </div>
    </div>

    <!-- Local Server Modal -->
    <div class="modal" id="local-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" data-i18n="configure_local">Configure Local Server</h3>
                <button class="modal-close" onclick="closeModal('local-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label" data-i18n="server_url">Server URL</label>
                    <input type="text" class="form-input" id="local-server-url" placeholder="http://localhost:8096">
                </div>
                <div class="form-group">
                    <label class="form-label" data-i18n="api_key">API Key</label>
                    <input type="text" class="form-input" id="local-server-key" placeholder="Enter API key">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('local-modal')" data-i18n="cancel">Cancel</button>
                <button class="btn btn-primary" onclick="saveLocalServer()" data-i18n="save_and_scan">Save & Scan</button>
            </div>
        </div>
    </div>

    <!-- Download Path Modal -->
    <div class="modal" id="path-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" data-i18n="select_download_location">Select Download Location</h3>
                <button class="modal-close" onclick="closeModal('path-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Quick paths from mappings -->
                <div id="quick-paths" style="margin-bottom: 1rem;"></div>
                
                <div class="form-hint" style="margin-bottom: 0.5rem;" data-i18n="or_browse">Or browse to a folder:</div>
                <div class="browser-path" id="local-path-display">/storage</div>
                <div id="local-folder-list" style="max-height: 250px; overflow-y: auto;"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('path-modal')" data-i18n="cancel">Cancel</button>
                <button class="btn btn-primary" onclick="confirmDownloadPath()" data-i18n="download_here">Download Here</button>
            </div>
        </div>
    </div>

    <!-- Mapping Modal -->
    <div class="modal" id="mapping-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add Library Mapping</h3>
                <button class="modal-close" onclick="closeModal('mapping-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Remote Server</label>
                    <select class="form-input" id="mapping-server"></select>
                </div>
                <div class="form-group">
                    <label class="form-label">Remote Library</label>
                    <select class="form-input" id="mapping-library"></select>
                </div>
                <div class="form-group">
                    <label class="form-label">Local Path</label>
                    <div style="display: flex; gap: 0.5rem;">
                        <input type="text" class="form-input" id="mapping-path" placeholder="/storage/media" style="flex: 1;">
                        <button class="btn btn-secondary" onclick="openMappingPathBrowser()">Browse</button>
                    </div>
                </div>
                <div id="mapping-folder-browser" style="display: none; margin-top: 0.5rem; max-height: 200px; overflow-y: auto; border: 1px solid var(--jf-border); border-radius: var(--radius); background: var(--jf-bg-input);">
                    <div id="mapping-folder-list"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('mapping-modal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveMapping()">Add Mapping</button>
            </div>
        </div>
    </div>

    <!-- Password Change Modal -->
    <div class="modal" id="password-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Change Password</h3>
                <button class="modal-close" onclick="closeModal('password-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Current Password</label>
                    <input type="password" class="form-input" id="current-password" placeholder="Enter current password">
                </div>
                <div class="form-group">
                    <label class="form-label">New Password</label>
                    <input type="password" class="form-input" id="new-password" placeholder="Enter new password">
                </div>
                <div class="form-group">
                    <label class="form-label">Confirm New Password</label>
                    <input type="password" class="form-input" id="confirm-new-password" placeholder="Confirm new password">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('password-modal')">Cancel</button>
                <button class="btn btn-primary" onclick="changePassword()">Change Password</button>
            </div>
        </div>
    </div>

    <!-- Local Server Modal (Pro) -->
    <div class="modal" id="local-server-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">üè† Add Local Server</h3>
                <button class="modal-close" onclick="closeModal('local-server-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-hint" style="margin-bottom: 1rem; padding: 0.75rem; background: var(--jf-bg-input); border-radius: var(--radius);">
                    Add local Jellyfin/Emby servers for duplicate detection. JellyLooter will scan these servers to avoid downloading media you already have.
                </div>
                <div class="form-group">
                    <label class="form-label">Server Name</label>
                    <input type="text" class="form-input" id="new-local-server-name" placeholder="e.g., Living Room Server">
                </div>
                <div class="form-group">
                    <label class="form-label">Server URL</label>
                    <input type="text" class="form-input" id="new-local-server-url" placeholder="http://192.168.1.100:8096">
                </div>
                <div class="form-group">
                    <label class="form-label">Authentication Method</label>
                    <select class="form-input" id="new-local-auth-method">
                        <option value="key">API Key</option>
                        <option value="creds">Username / Password</option>
                    </select>
                </div>
                <div id="new-local-auth-key-fields">
                    <div class="form-group">
                        <label class="form-label">API Key</label>
                        <input type="password" class="form-input" id="new-local-server-key" placeholder="Enter API key">
                    </div>
                </div>
                <div id="new-local-auth-creds-fields" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">Username</label>
                        <input type="text" class="form-input" id="new-local-server-username" placeholder="Username">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <input type="password" class="form-input" id="new-local-server-password" placeholder="Password">
                    </div>
                </div>
                <button class="btn btn-secondary" onclick="testLocalServerConnection()" style="margin-top: 0.5rem;">Test Connection</button>
                <div id="new-local-server-test-result" style="margin-top: 0.5rem;"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('local-server-modal')">Cancel</button>
                <button class="btn btn-primary" onclick="addLocalServer()">Add Server</button>
            </div>
        </div>
    </div>

    <!-- Keyboard Shortcuts Modal -->
    <div class="modal" id="shortcuts-modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3 class="modal-title">‚å®Ô∏è Keyboard Shortcuts</h3>
                <button class="modal-close" onclick="closeModal('shortcuts-modal')">&times;</button>
            </div>
            <div class="modal-body" style="padding: 1rem;">
                <div style="display: grid; gap: 0.75rem;">
                    <div style="font-weight: 600; color: var(--jf-primary); margin-bottom: 0.5rem;">Navigation</div>
                    <div class="shortcut-row"><kbd>/</kbd> <span>Focus search box</span></div>
                    <div class="shortcut-row"><kbd>Esc</kbd> <span>Clear selection / Close modal</span></div>
                    <div class="shortcut-row"><kbd>1</kbd> <span>Go to Browse tab</span></div>
                    <div class="shortcut-row"><kbd>2</kbd> <span>Go to Sync tab</span></div>
                    <div class="shortcut-row"><kbd>3</kbd> <span>Go to Settings tab</span></div>
                    
                    <div style="font-weight: 600; color: var(--jf-primary); margin: 0.75rem 0 0.5rem;">Selection</div>
                    <div class="shortcut-row"><kbd>Space</kbd> <span>Toggle selection on hovered item</span></div>
                    <div class="shortcut-row"><kbd>Ctrl</kbd>+<kbd>A</kbd> <span>Select all items on page</span></div>
                    <div class="shortcut-row"><kbd>Enter</kbd> <span>Download selected items</span></div>
                    
                    <div style="font-weight: 600; color: var(--jf-primary); margin: 0.75rem 0 0.5rem;">Downloads</div>
                    <div class="shortcut-row"><kbd>P</kbd> <span>Pause / Resume downloads</span></div>
                    <div class="shortcut-row"><kbd>D</kbd> <span>Download selected items</span></div>
                    
                    <div style="font-weight: 600; color: var(--jf-primary); margin: 0.75rem 0 0.5rem;">Other</div>
                    <div class="shortcut-row"><kbd>?</kbd> <span>Show this help</span></div>
                    <div class="shortcut-row"><kbd>R</kbd> <span>Refresh current view</span></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="closeModal('shortcuts-modal')">Got it!</button>
            </div>
        </div>
    </div>

    <style>
        .shortcut-row {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.25rem 0;
        }
        .shortcut-row kbd {
            background: var(--jf-bg-input);
            border: 1px solid var(--jf-border);
            border-radius: 4px;
            padding: 0.25rem 0.5rem;
            font-family: monospace;
            font-size: 0.8rem;
            min-width: 2rem;
            text-align: center;
        }
        .shortcut-row span {
            color: var(--jf-text-muted);
        }
    </style>

    <script>
        // State
        let config = {};
        let currentServerId = null;
        let currentParentId = 'root';
        let currentLibraryId = null;  // The library we're browsing in
        let currentBaseUrl = '';      // Current server's base URL
        let browserPath = [{ id: 'root', name: 'üè† Home' }];
        let selectedItems = new Set();
        let pendingDownloadPath = '/storage';
        let baseUrl = '';
        let skipList = [];  // Items to skip in auto-sync
        
        // Pagination state
        let currentPage = 1;
        let totalPages = 1;
        let itemsPerPage = 50;
        let totalItems = 0;
        
        // Store current items for filtering
        let currentItems = [];
        let filterText = '';

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadConfig();
            loadUser();
            loadSkipList();
            initTheme();
            setupEventListeners();
            startStatusPolling();
            startLogPolling();
            setupSearch();
            setupKeyboardShortcuts();
            loadTranscodeSettingsOnLoad();
        });
        
        // Load transcode settings on page load
        async function loadTranscodeSettingsOnLoad() {
            try {
                const response = await api('transcode_test_mode');
                
                // Load settings into controls
                const transcodeEnabledEl = document.getElementById('transcode-enabled-test');
                const transcodeEncoderEl = document.getElementById('transcode-encoder-test');
                const transcodePresetEl = document.getElementById('transcode-preset-test');
                const maxTranscodesEl = document.getElementById('max-transcodes');
                const skipLargerEl = document.getElementById('transcode-skip-larger');
                const cacheEnabledEl = document.getElementById('transcode-cache-enabled');
                const cachePathEl = document.getElementById('transcode-cache-path');
                const cachePathGroupEl = document.getElementById('transcode-cache-path-group');
                
                if (transcodeEnabledEl) transcodeEnabledEl.checked = response.transcode_enabled;
                if (transcodeEncoderEl) transcodeEncoderEl.value = response.transcode_encoder;
                if (transcodePresetEl) transcodePresetEl.value = response.transcode_preset;
                if (maxTranscodesEl) maxTranscodesEl.value = response.max_concurrent_transcodes || 1;
                if (skipLargerEl) skipLargerEl.checked = response.transcode_skip_larger !== false;
                if (cacheEnabledEl) cacheEnabledEl.checked = response.transcode_cache_enabled || false;
                if (cachePathEl) cachePathEl.value = response.transcode_cache_path || '/tmp/transcode_cache';
                if (cachePathGroupEl) cachePathGroupEl.style.display = response.transcode_cache_enabled ? 'block' : 'none';
                
                // Load transcode stats and cache status
                setTimeout(() => {
                    if (typeof loadTranscodeStats === 'function') {
                        loadTranscodeStats();
                    }
                    if (response.transcode_cache_enabled && typeof loadTranscodeCacheStatus === 'function') {
                        loadTranscodeCacheStatus();
                    }
                }, 100);
            } catch (e) {
                console.error('Error loading transcode settings:', e);
            }
        }
        
        // Keyboard Shortcuts
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                // Don't trigger shortcuts when typing in inputs
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                    // But allow Escape to blur
                    if (e.key === 'Escape') {
                        e.target.blur();
                    }
                    return;
                }
                
                switch (e.key) {
                    case '?': // Show shortcuts help
                        e.preventDefault();
                        openModal('shortcuts-modal');
                        break;
                        
                    case ' ': // Space - toggle selection on focused item
                        e.preventDefault();
                        const focused = document.querySelector('.browser-item:focus, .browser-item:hover');
                        if (focused) {
                            toggleSelection(focused.dataset.id);
                        }
                        break;
                        
                    case 'Enter': // Enter - download selected or navigate
                        if (selectedItems.size > 0) {
                            document.getElementById('download-selected-btn').click();
                        }
                        break;
                        
                    case 'a': // Ctrl+A - select all
                        if (e.ctrlKey || e.metaKey) {
                            e.preventDefault();
                            selectAllOnPage();
                        }
                        break;
                        
                    case 'Escape': // Escape - clear selection or close modal
                        const openModal = document.querySelector('.modal.active');
                        if (openModal) {
                            closeModal(openModal.id);
                        } else if (selectedItems.size > 0) {
                            clearSelection();
                        }
                        break;
                        
                    case '/': // Focus search
                        e.preventDefault();
                        document.getElementById('library-search').focus();
                        break;
                    
                    case 'p': // P - Pause/Resume
                    case 'P':
                        e.preventDefault();
                        if (is_paused) {
                            document.getElementById('resume-btn').click();
                        } else {
                            document.getElementById('pause-btn').click();
                        }
                        break;
                    
                    case 'd': // D - Download selected
                    case 'D':
                        if (selectedItems.size > 0) {
                            e.preventDefault();
                            document.getElementById('download-selected-btn').click();
                        }
                        break;
                    
                    case 'r': // R - Refresh
                    case 'R':
                        if (!e.ctrlKey && !e.metaKey) {
                            e.preventDefault();
                            if (currentServerId) {
                                loadLibrary(currentServerId, currentParentId);
                            }
                        }
                        break;
                    
                    case '1': // 1 - Browse tab
                        e.preventDefault();
                        document.querySelector('[data-tab="browse"]').click();
                        break;
                    
                    case '2': // 2 - Sync tab
                        e.preventDefault();
                        document.querySelector('[data-tab="sync"]').click();
                        break;
                    
                    case '3': // 3 - Settings tab
                        e.preventDefault();
                        document.querySelector('[data-tab="settings"]').click();
                        break;
                }
            });
        }
        
        // Track pause state for keyboard shortcut
        let is_paused = false;
        let searchActive = false;
        let searchParentId = null;  // Store the parent ID when search started
        
        // Search functionality
        function setupSearch() {
            const searchInput = document.getElementById('library-search');
            
            // Enter key triggers search
            searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    searchLibrary();
                }
            });
        }
        
        async function searchLibrary() {
            const searchInput = document.getElementById('library-search');
            const query = searchInput.value.trim();
            
            if (!query) {
                showToast('Enter a search term', 'info');
                return;
            }
            
            if (query.length < 2) {
                showToast('Search term must be at least 2 characters', 'info');
                return;
            }
            
            if (!currentServerId) {
                showToast('Select a server first', 'warning');
                return;
            }
            
            // Store current parent so we can return to it
            if (!searchActive) {
                searchParentId = currentParentId;
            }
            
            const statusEl = document.getElementById('search-status');
            statusEl.style.display = 'block';
            statusEl.textContent = `Searching for "${query}"...`;
            
            try {
                const result = await api('search', 'POST', {
                    query: query,
                    server_id: currentServerId,
                    parent_id: currentLibraryId,  // Search within current library
                    limit: 100
                });
                
                if (result.error) {
                    statusEl.textContent = `Error: ${result.error}`;
                    return;
                }
                
                searchActive = true;
                currentItems = result.items || [];
                
                // Store base URL for image loading
                if (result.base_url) {
                    currentBaseUrl = result.base_url;
                }
                
                if (currentItems.length === 0) {
                    statusEl.textContent = `No results found for "${query}"`;
                } else {
                    statusEl.innerHTML = `Found <strong>${currentItems.length}</strong> result(s) for "<strong>${escapeHtml(query)}</strong>" ‚Ä¢ <a href="#" onclick="clearSearch(); return false;">Clear search</a>`;
                }
                
                // Hide pagination during search (showing all results)
                document.getElementById('pagination-controls').style.display = 'none';
                
                renderBrowserItems(currentItems);
                
            } catch (err) {
                statusEl.textContent = `Search failed: ${err.message}`;
            }
        }
        
        function clearSearch() {
            const searchInput = document.getElementById('library-search');
            searchInput.value = '';
            
            const statusEl = document.getElementById('search-status');
            statusEl.style.display = 'none';
            
            searchActive = false;
            
            // Go back to where we were before search
            if (searchParentId) {
                currentParentId = searchParentId;
                browseRemote();
            } else if (currentLibraryId) {
                currentParentId = currentLibraryId;
                browseRemote();
            }
            searchParentId = null;
        }
        
        function filterCurrentItems() {
            // Deprecated - now using server-side search
            const filterText = document.getElementById('library-search').value.toLowerCase();
            if (!filterText) {
                renderBrowserItems(currentItems);
                return;
            }
            
            const filtered = currentItems.filter(item => 
                item.Name.toLowerCase().includes(filterText)
            );
            renderBrowserItems(filtered);
        }

        // Theme Management
        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || config.theme || 'dark';
            setTheme(savedTheme);
        }

        function setTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
            document.getElementById('theme-toggle-settings').checked = theme === 'dark';
        }

        function toggleTheme() {
            const current = document.documentElement.getAttribute('data-theme');
            const newTheme = current === 'dark' ? 'light' : 'dark';
            setTheme(newTheme);
            config.theme = newTheme;
            api('config', 'POST', config);
        }

        // Mobile Menu
        function openMobileMenu() {
            document.getElementById('mobile-menu').classList.add('open');
            document.getElementById('mobile-menu-overlay').classList.add('open');
            document.body.style.overflow = 'hidden';
        }
        
        function closeMobileMenu() {
            document.getElementById('mobile-menu').classList.remove('open');
            document.getElementById('mobile-menu-overlay').classList.remove('open');
            document.body.style.overflow = '';
        }
        
        // Mobile action functions
        function mobileSync() {
            showToast('Starting sync...', 'info');
            api('sync', 'POST').then(() => {
                showToast('Sync started!', 'success');
            }).catch(() => {
                showToast('Sync failed', 'error');
            });
        }
        
        function mobileRebuildCache() {
            showToast('Rebuilding cache...', 'info');
            api('rebuild_cache', 'POST').then(() => {
                showToast('Cache rebuild started!', 'success');
            }).catch(() => {
                showToast('Cache rebuild failed', 'error');
            });
        }
        
        function copyLogs() {
            console.log('copyLogs called');
            const logContainer = document.getElementById('log-container');
            if (!logContainer) {
                console.log('No log container found');
                showToast('No logs to copy', 'error');
                return;
            }
            
            // Get all log lines as text - handle both .log-line divs and direct text
            let logLines = '';
            const logLineElements = logContainer.querySelectorAll('.log-line');
            console.log('Found log-line elements:', logLineElements.length);
            
            if (logLineElements.length > 0) {
                logLines = Array.from(logLineElements)
                    .map(line => line.textContent.trim())
                    .filter(line => line && line !== 'Waiting for activity...' && line !== 'No download history yet...')
                    .join('\n');
            } else {
                // Fallback: get inner text
                logLines = logContainer.innerText.trim();
            }
            
            console.log('Log lines to copy:', logLines.length, 'chars');
            
            if (!logLines) {
                showToast('No logs to copy', 'info');
                return;
            }
            
            // Always use the fallback method first since it's more reliable over HTTP
            copyLogsFallback(logLines);
        }
        
        function copyLogsFallback(text) {
            console.log('Using fallback copy method');
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.setAttribute('readonly', '');
            textarea.style.cssText = 'position:fixed;left:-9999px;top:0;opacity:0;';
            document.body.appendChild(textarea);
            
            // iOS Safari workaround
            const range = document.createRange();
            range.selectNodeContents(textarea);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            textarea.setSelectionRange(0, textarea.value.length);
            
            let success = false;
            try {
                success = document.execCommand('copy');
                console.log('execCommand result:', success);
            } catch (e) {
                console.error('execCommand error:', e);
            }
            
            document.body.removeChild(textarea);
            selection.removeAllRanges();
            
            if (success) {
                showToast(`Copied ${text.split('\n').length} log lines!`, 'success');
            } else {
                // Try clipboard API as last resort
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(text).then(() => {
                        showToast(`Copied ${text.split('\n').length} log lines!`, 'success');
                    }).catch(() => {
                        showToast('Copy failed - please select and copy manually', 'error');
                    });
                } else {
                    showToast('Copy failed - please select and copy manually', 'error');
                }
            }
        }
        
        function toggleDownloadLimitOverride() {
            const checkbox = document.getElementById('override-download-limit');
            const warning = document.getElementById('download-limit-warning');
            const maxInput = document.getElementById('max-downloads');
            
            // Pro feature check
            if (checkbox.checked && config.license_tier !== 'pro' && config.license_tier !== 'trial') {
                checkbox.checked = false;
                showToast('Download limit override requires a Pro license', 'warning');
                return;
            }
            
            if (checkbox.checked) {
                warning.style.display = 'block';
                maxInput.max = 50;  // Allow up to 50
                showToast('Download limit override enabled - use responsibly!', 'warning');
            } else {
                warning.style.display = 'none';
                maxInput.max = 10;
                if (parseInt(maxInput.value) > 10) {
                    maxInput.value = 10;
                }
            }
        }

        // API Helper
        async function api(endpoint, method = 'GET', body = null) {
            const options = {
                method,
                headers: { 'Content-Type': 'application/json' }
            };
            if (body) options.body = JSON.stringify(body);
            
            const res = await fetch(`/api/${endpoint}`, options);
            if (res.status === 401) {
                window.location.href = '/login';
                return;
            }
            
            const contentType = res.headers.get('content-type');
            if (contentType && contentType.includes('application/json')) {
                return res.json();
            }
            return res.text();
        }

        // Toast Notifications
        function showToast(message, type = 'success') {
            if (!config.show_notifications) return;
            
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <span>${type === 'success' ? '‚úì' : type === 'error' ? '‚úó' : '‚ö†'}</span>
                <span>${message}</span>
            `;
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }

        // User Management
        async function loadUser() {
            const user = await api('user');
            if (user && user.username) {
                document.getElementById('username-display').textContent = user.username;
            }
        }

        async function changePassword() {
            const current = document.getElementById('current-password').value;
            const newPwd = document.getElementById('new-password').value;
            const confirm = document.getElementById('confirm-new-password').value;
            
            if (newPwd !== confirm) {
                showToast('Passwords do not match', 'error');
                return;
            }
            
            if (newPwd.length < 8) {
                showToast('Password must be at least 8 characters', 'error');
                return;
            }
            
            const result = await api('change_password', 'POST', {
                current_password: current,
                new_password: newPwd
            });
            
            if (result.status === 'ok') {
                showToast('Password changed successfully');
                closeModal('password-modal');
                document.getElementById('current-password').value = '';
                document.getElementById('new-password').value = '';
                document.getElementById('confirm-new-password').value = '';
            } else {
                showToast(result.message || 'Failed to change password', 'error');
            }
        }

        // Config Management
        let translations = {};
        
        async function loadConfig() {
            config = await api('config');
            updateServerSelect();
            updateSettingsForm();
            updateServerList();
            updateLocalServerInfo();
            updateMappingsList();
            
            // Apply custom theme if set (Pro feature)
            if (config.custom_theme && config.custom_theme !== 'default') {
                // Apply silently (without toast) on initial load
                applyThemePresetSilent(config.custom_theme);
            }
            
            // Load and apply translations
            await loadTranslations(config.language || 'en');
        }
        
        async function loadSkipList() {
            try {
                const result = await api('skip_list');
                skipList = result.skip_list || [];
                updateSkipListDisplay();
            } catch (e) {
                console.error('Failed to load skip list:', e);
                skipList = [];
            }
        }
        
        async function toggleSkip(itemId, itemName, itemType) {
            const isCurrentlySkipped = skipList.some(s => s.id === itemId);
            
            try {
                let result;
                if (isCurrentlySkipped) {
                    result = await api('skip_list/remove', 'POST', { id: itemId });
                    showToast(`Removed from skip list: ${itemName}`, 'info');
                } else {
                    result = await api('skip_list/add', 'POST', { 
                        id: itemId, 
                        name: itemName, 
                        type: itemType,
                        server_id: currentServerId 
                    });
                    showToast(`Added to skip list: ${itemName}`, 'success');
                }
                
                if (result.success) {
                    skipList = result.skip_list;
                    updateSkipListDisplay();
                    // Re-render current items to update skip buttons
                    renderItems(currentItems);
                }
            } catch (e) {
                showToast('Failed to update skip list', 'error');
            }
        }
        
        async function clearSkipList() {
            if (!confirm('Clear all items from skip list? This will allow them to be included in auto-sync again.')) {
                return;
            }
            
            try {
                const result = await api('skip_list/clear', 'POST');
                if (result.success) {
                    skipList = [];
                    updateSkipListDisplay();
                    renderItems(currentItems);
                    showToast('Skip list cleared', 'success');
                }
            } catch (e) {
                showToast('Failed to clear skip list', 'error');
            }
        }
        
        function updateSkipListDisplay() {
            const container = document.getElementById('skip-list-items');
            if (!container) return;
            
            if (skipList.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚úÖ</div><div>No items in skip list</div></div>';
                return;
            }
            
            container.innerHTML = skipList.map(item => `
                <div class="skip-list-item">
                    <span class="skip-item-type">${item.type === 'Series' ? 'üì∫' : 'üé¨'}</span>
                    <span class="skip-item-name">${escapeHtml(item.name)}</span>
                    <button class="btn btn-xs btn-danger" onclick="removeFromSkipList('${item.id}')">‚úï</button>
                </div>
            `).join('');
        }
        
        async function removeFromSkipList(itemId) {
            try {
                const result = await api('skip_list/remove', 'POST', { id: itemId });
                if (result.success) {
                    skipList = result.skip_list;
                    updateSkipListDisplay();
                    renderItems(currentItems);
                    showToast('Removed from skip list', 'info');
                }
            } catch (e) {
                showToast('Failed to remove from skip list', 'error');
            }
        }
        
        async function loadTranslations(lang) {
            try {
                console.log('Loading translations for:', lang);
                // Direct fetch since translations don't require auth
                const res = await fetch(`/api/translations?lang=${lang}`);
                translations = await res.json();
                console.log('Translations loaded:', Object.keys(translations).length, 'keys');
                applyTranslations();
            } catch (e) {
                console.error('Failed to load translations:', e);
            }
        }
        
        function applyTranslations() {
            console.log('Applying translations, keys:', Object.keys(translations).length);
            // Apply translations to elements with data-i18n attribute
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (translations[key]) {
                    console.log('Translating:', key, '->', translations[key]);
                    el.textContent = translations[key];
                }
            });
            
            // Apply to placeholders
            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                const key = el.getAttribute('data-i18n-placeholder');
                if (translations[key]) {
                    el.placeholder = translations[key];
                }
            });
        }
        
        function t(key) {
            return translations[key] || key;
        }

        function updateServerSelect() {
            const select = document.getElementById('server-select');
            select.innerHTML = `<option value="">${t('select_server')}</option>`;
            
            (config.servers || []).forEach(server => {
                const opt = document.createElement('option');
                opt.value = server.id;
                opt.textContent = server.name;
                select.appendChild(opt);
            });
        }

        function updateServerList() {
            const container = document.getElementById('settings-server-list');
            if (!config.servers || config.servers.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="padding: 1.5rem;">
                        <p>${t('no_remote_servers')}</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = config.servers.map(server => `
                <div class="server-item">
                    <div class="server-icon">üì°</div>
                    <div class="server-info">
                        <div class="server-name">${escapeHtml(server.name)}</div>
                        <div class="server-url">${escapeHtml(server.url)}</div>
                    </div>
                    <button class="btn btn-icon btn-sm btn-danger" onclick="removeServer('${server.id}')" data-tooltip="${t('remove')}">üóëÔ∏è</button>
                </div>
            `).join('');
        }

        async function removeServer(id) {
            if (!confirm('Remove this server?')) return;
            config.servers = config.servers.filter(s => s.id !== id);
            await api('config', 'POST', config);
            loadConfig();
            showToast('Server removed');
        }

        function updateLocalServerInfo() {
            const container = document.getElementById('local-server-info');
            if (config.local_server_url) {
                container.innerHTML = `
                    <div class="server-item">
                        <div class="server-icon" style="background: var(--jf-success);">‚úì</div>
                        <div class="server-info">
                            <div class="server-name">${t('local_server')}</div>
                            <div class="server-url">${escapeHtml(config.local_server_url)}</div>
                        </div>
                        <button class="btn btn-icon btn-sm btn-danger" id="remove-local-btn" data-tooltip="${t('remove')}">üóëÔ∏è</button>
                    </div>
                `;
                document.getElementById('remove-local-btn').addEventListener('click', async () => {
                    if (confirm(t('confirm_remove_local'))) {
                        await api('remove_local', 'POST');
                        loadConfig();
                        showToast(t('local_server_removed'));
                    }
                });
            } else {
                container.innerHTML = `
                    <div class="empty-state" style="padding: 1.5rem;">
                        <p>${t('no_local_server')}</p>
                        <button class="btn btn-secondary btn-sm" style="margin-top: 0.75rem;" id="add-local-btn">${t('configure_local')}</button>
                    </div>
                `;
                document.getElementById('add-local-btn').addEventListener('click', () => openModal('local-modal'));
            }
        }

        async function saveLocalServer() {
            const url = document.getElementById('local-server-url').value;
            const key = document.getElementById('local-server-key').value;

            if (!url || !key) {
                showToast('Please fill in all fields', 'error');
                return;
            }

            config.local_server_url = url;
            config.local_server_key = key;
            await api('config', 'POST', config);
            await api('rebuild_cache', 'POST');
            closeModal('local-modal');
            loadConfig();
            showToast('Local server configured, scanning...');
        }

        function updateSettingsForm() {
            document.getElementById('speed-limit').value = config.speed_limit_kbs || 0;
            document.getElementById('sync-time').value = config.sync_time || '04:00';
            document.getElementById('timezone').value = config.timezone || 'UTC';
            document.getElementById('time-format').value = config.time_format || '12h';
            document.getElementById('max-downloads').value = config.max_concurrent_downloads || 2;
            // Download limit override (Pro feature)
            const overrideEl = document.getElementById('override-download-limit');
            if (overrideEl) {
                const isPro = config.license_tier === 'pro' || config.license_tier === 'trial';
                overrideEl.disabled = !isPro;
                if (!isPro) {
                    overrideEl.checked = false;
                    overrideEl.parentElement.parentElement.style.opacity = '0.5';
                } else {
                    overrideEl.checked = config.override_download_limit || false;
                    overrideEl.parentElement.parentElement.style.opacity = '1';
                    if (config.override_download_limit) {
                        document.getElementById('download-limit-warning').style.display = 'block';
                        document.getElementById('max-downloads').max = 50;
                    }
                }
            }
            // Retry settings
            const retryEl = document.getElementById('download-auto-retry');
            if (retryEl) retryEl.checked = config.download_auto_retry !== false;
            const retryCountEl = document.getElementById('download-retry-count');
            if (retryCountEl) retryCountEl.value = config.download_retry_count || 3;
            const retryDelayEl = document.getElementById('download-retry-delay');
            if (retryDelayEl) retryDelayEl.value = config.download_retry_delay || 30;
            
            document.getElementById('auto-sync-toggle').checked = config.auto_sync_enabled !== false;
            document.getElementById('connection-timeout').value = config.connection_timeout || 30;
            document.getElementById('chunk-size').value = config.chunk_size_kb || 64;
            document.getElementById('confirm-downloads').checked = config.confirm_downloads || false;
            document.getElementById('show-notifications').checked = config.show_notifications !== false;
            document.getElementById('show-ratings').checked = config.show_ratings !== false;
            document.getElementById('show-quality').checked = config.show_quality !== false;
            document.getElementById('folder-naming-format').value = config.folder_naming_format || 'standard';
            updateFolderFormatPreview();
            document.getElementById('tmdb-api-key').value = config.tmdb_api_key || '';
            document.getElementById('tvdb-api-key').value = config.tvdb_api_key || '';
            document.getElementById('omdb-api-key').value = config.omdb_api_key || '';
            document.getElementById('imdb-lookup-enabled').checked = config.imdb_lookup_enabled !== false;  // Default true
            document.getElementById('metadata-lookup-on-browse').checked = config.metadata_lookup_on_browse || false;
            document.getElementById('download-subtitles').checked = config.download_subtitles !== false;
            document.getElementById('subtitle-languages').value = (config.subtitle_languages || ['eng', 'spa', 'ger']).join(', ');
            document.getElementById('theme-toggle-settings').checked = (config.theme || 'dark') === 'dark';
            document.getElementById('language-select').value = config.language || 'en';
            
            // Security settings
            document.getElementById('auth-enabled').checked = config.auth_enabled || false;
            document.getElementById('session-timeout').value = config.session_timeout_minutes || 30;
            document.getElementById('trust-proxy').checked = config.trust_proxy_headers || false;
            document.getElementById('trusted-proxies').value = config.trusted_proxy_ips || '';
            
            // Apply tier limits to max downloads
            applyMaxDownloadsLimit();
        }
        
        function applyMaxDownloadsLimit() {
            const maxDownloadsInput = document.getElementById('max-downloads');
            const hint = document.getElementById('max-downloads-hint');
            const tier = config.license_tier || 'free';
            
            if (tier === 'free') {
                maxDownloadsInput.max = 2;
                if (parseInt(maxDownloadsInput.value) > 2) {
                    maxDownloadsInput.value = 2;
                }
                hint.style.display = 'block';
            } else {
                maxDownloadsInput.max = 10;
                hint.style.display = 'none';
            }
        }
        
        function updateFolderFormatPreview() {
            const format = document.getElementById('folder-naming-format').value;
            const moviePreview = document.getElementById('folder-format-preview-movie');
            const showPreview = document.getElementById('folder-format-preview-show');
            
            // Example IDs
            const movieName = 'Inception';
            const movieYear = '2010';
            const movieImdb = 'tt1375666';
            const movieTmdb = '27205';
            
            const showName = 'Breaking Bad';
            const showImdb = 'tt0903747';
            const showTvdb = '81189';
            const showTmdb = '1396';
            
            let movieFolder, showFolder;
            
            switch (format) {
                case 'standard':
                    movieFolder = `${movieName} (${movieYear})`;
                    showFolder = showName;
                    break;
                case 'ids_space':
                    movieFolder = `${movieName} (${movieYear}) ${movieImdb} ${movieTmdb}`;
                    showFolder = `${showName} ${showImdb} ${showTvdb}`;
                    break;
                case 'ids_braces':
                    movieFolder = `${movieName} (${movieYear}) {imdb-${movieImdb}} {tmdb-${movieTmdb}}`;
                    showFolder = `${showName} {imdb-${showImdb}} {tvdb-${showTvdb}}`;
                    break;
                case 'ids_brackets':
                    movieFolder = `${movieName} (${movieYear}) [imdb-${movieImdb}]`;
                    showFolder = `${showName} [imdb-${showImdb}] [tvdb-${showTvdb}]`;
                    break;
                case 'tmdb_only':
                    movieFolder = `${movieName} (${movieYear}) {tmdb-${movieTmdb}}`;
                    showFolder = `${showName} {tmdb-${showTmdb}}`;
                    break;
                case 'imdb_only':
                    movieFolder = `${movieName} (${movieYear}) ${movieImdb}`;
                    showFolder = `${showName} ${showImdb}`;
                    break;
                default:
                    movieFolder = `${movieName} (${movieYear})`;
                    showFolder = showName;
            }
            
            moviePreview.textContent = `Movie: ${movieFolder}`;
            showPreview.textContent = `Show: ${showFolder}`;
        }

        async function saveSettings() {
            config.speed_limit_kbs = parseInt(document.getElementById('speed-limit').value) || 0;
            config.sync_time = document.getElementById('sync-time').value || '04:00';
            config.timezone = document.getElementById('timezone').value || 'UTC';
            config.time_format = document.getElementById('time-format').value || '12h';
            
            // Enforce tier limit on max downloads (unless override enabled)
            let maxDownloads = parseInt(document.getElementById('max-downloads').value) || 2;
            const tier = config.license_tier || 'free';
            const overrideLimit = document.getElementById('override-download-limit')?.checked || false;
            
            if (!overrideLimit) {
                if (tier === 'free' && maxDownloads > 2) {
                    maxDownloads = 2;
                    showToast('Free tier limited to 2 concurrent downloads', 'warning');
                } else if (maxDownloads > 10) {
                    maxDownloads = 10;
                }
            }
            config.max_concurrent_downloads = maxDownloads;
            config.override_download_limit = overrideLimit;
            
            // Retry settings
            config.download_auto_retry = document.getElementById('download-auto-retry')?.checked !== false;
            config.download_retry_count = parseInt(document.getElementById('download-retry-count')?.value) || 3;
            config.download_retry_delay = parseInt(document.getElementById('download-retry-delay')?.value) || 30;
            
            config.connection_timeout = parseInt(document.getElementById('connection-timeout').value) || 30;
            config.chunk_size_kb = parseInt(document.getElementById('chunk-size').value) || 64;
            config.confirm_downloads = document.getElementById('confirm-downloads').checked;
            config.show_notifications = document.getElementById('show-notifications').checked;
            config.show_ratings = document.getElementById('show-ratings').checked;
            config.show_quality = document.getElementById('show-quality').checked;
            config.folder_naming_format = document.getElementById('folder-naming-format').value;
            // Metadata API keys (only save if changed, to avoid re-encrypting)
            const tmdbKey = document.getElementById('tmdb-api-key').value;
            const tvdbKey = document.getElementById('tvdb-api-key').value;
            const omdbKey = document.getElementById('omdb-api-key').value;
            if (tmdbKey) config.tmdb_api_key = tmdbKey;
            if (tvdbKey) config.tvdb_api_key = tvdbKey;
            if (omdbKey) config.omdb_api_key = omdbKey;
            config.imdb_lookup_enabled = document.getElementById('imdb-lookup-enabled').checked;
            config.metadata_lookup_on_browse = document.getElementById('metadata-lookup-on-browse').checked;
            config.download_subtitles = document.getElementById('download-subtitles').checked;
            // Parse subtitle languages from comma-separated string
            const subLangs = document.getElementById('subtitle-languages').value;
            config.subtitle_languages = subLangs.split(',').map(l => l.trim().toLowerCase()).filter(l => l);
            
            await api('config', 'POST', config);
            showToast('Settings saved');
        }
        
        async function saveLanguage() {
            const newLang = document.getElementById('language-select').value;
            config.language = newLang;
            
            await api('config', 'POST', config);
            showToast('Language saved - refreshing...');
            setTimeout(() => location.reload(), 500);
        }
        
        // Config Export/Import
        function exportConfig() {
            // Trigger download via API
            window.location.href = '/api/config/export';
            showToast('üì§ Config exported', 'success');
        }
        
        function importConfig(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const importData = JSON.parse(e.target.result);
                    
                    // Confirm import
                    const exportInfo = importData._export || {};
                    const confirmMsg = `Import configuration from ${exportInfo.exported_at ? new Date(exportInfo.exported_at).toLocaleString() : 'unknown date'}?\n\n` +
                        `Version: ${exportInfo.version || 'unknown'}\n\n` +
                        `Note: ${exportInfo.note || 'API keys will need to be re-entered.'}`;
                    
                    if (!confirm(confirmMsg)) {
                        event.target.value = '';
                        return;
                    }
                    
                    // Send to server
                    const response = await fetch('/api/config/import', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(importData)
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        showToast('üì• ' + result.message, 'success');
                        // Reload to apply new config
                        setTimeout(() => location.reload(), 1000);
                    } else {
                        showToast('‚ùå Import failed: ' + result.error, 'error');
                    }
                } catch (err) {
                    showToast('‚ùå Invalid config file: ' + err.message, 'error');
                }
                
                // Reset file input
                event.target.value = '';
            };
            
            reader.readAsText(file);
        }

        // Mappings
        function updateMappingsList() {
            const container = document.getElementById('mappings-list');
            if (!config.mappings || config.mappings.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üó∫Ô∏è</div>
                        <div class="empty-state-title">${t('no_mappings')}</div>
                        <p>${t('no_mappings_desc')}</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = config.mappings.map(m => {
                const server = config.servers.find(s => s.id === m.server_id);
                return `
                    <div class="mapping-item">
                        <div class="mapping-info">
                            <div class="mapping-path">${escapeHtml(m.local_path)}</div>
                            <div class="mapping-source">${server ? escapeHtml(server.name) : t('unknown')} ‚Üí ${m.lib_name || t('library')}</div>
                        </div>
                        <button class="btn btn-icon btn-sm btn-danger" onclick="removeMapping('${m.id}')" data-tooltip="${t('remove')}">üóëÔ∏è</button>
                    </div>
                `;
            }).join('');
        }

        async function removeMapping(id) {
            if (!confirm('Remove this mapping?')) return;
            config.mappings = config.mappings.filter(m => m.id !== id);
            await api('config', 'POST', config);
            loadConfig();
            showToast('Mapping removed');
        }

        // Event Listeners
        function setupEventListeners() {
            // Mobile menu
            document.getElementById('mobile-menu-btn')?.addEventListener('click', openMobileMenu);
            document.getElementById('mobile-menu-close')?.addEventListener('click', closeMobileMenu);
            document.getElementById('mobile-menu-overlay')?.addEventListener('click', closeMobileMenu);
            
            // Right column toggle (mobile)
            document.getElementById('right-column-toggle')?.addEventListener('click', () => {
                document.getElementById('right-column').classList.toggle('expanded');
            });
            
            // Theme toggle
            document.getElementById('theme-toggle').addEventListener('click', toggleTheme);
            document.getElementById('theme-toggle-settings').addEventListener('change', (e) => {
                setTheme(e.target.checked ? 'dark' : 'light');
                config.theme = e.target.checked ? 'dark' : 'light';
                api('config', 'POST', config);
            });

            // User dropdown
            document.getElementById('user-btn').addEventListener('click', () => {
                document.getElementById('user-dropdown').classList.toggle('active');
            });

            document.addEventListener('click', (e) => {
                if (!e.target.closest('.user-menu')) {
                    document.getElementById('user-dropdown').classList.remove('active');
                }
            });

            // Navigation tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    tab.classList.add('active');
                    document.getElementById(`tab-${tab.dataset.tab}`).classList.add('active');
                });
            });

            // Server select
            document.getElementById('server-select').addEventListener('change', (e) => {
                currentServerId = e.target.value;
                if (currentServerId) {
                    currentParentId = 'root';
                    currentPage = 1;
                    browserPath = [{ id: 'root', name: 'üè† Home' }];
                    browseRemote();
                }
            });

            // Refresh button
            document.getElementById('refresh-btn').addEventListener('click', browseRemote);
            
            // Pagination controls
            setupPaginationListeners();

            // Download controls
            document.getElementById('pause-btn').addEventListener('click', () => api('pause', 'POST'));
            document.getElementById('resume-btn').addEventListener('click', () => api('resume', 'POST'));
            document.getElementById('cancel-all-btn').addEventListener('click', () => {
                if (confirm('Cancel all downloads?')) api('cancel', 'POST', { all: true });
            });
            
            // Cancel single download/transcode
            window.cancelSingleDownload = async function(taskId) {
                try {
                    const result = await api('cancel', 'POST', { task_id: taskId });
                    if (result.type === 'transcode') {
                        showToast('Transcode cancelled', 'warning');
                    } else {
                        showToast('Download cancelled', 'warning');
                    }
                } catch (e) {
                    console.error('Cancel failed:', e);
                }
            };

            // Selection controls
            document.getElementById('download-selected-btn').addEventListener('click', () => {
                if (selectedItems.size > 0) {
                    openPathModal();
                }
            });
            document.getElementById('clear-selection-btn').addEventListener('click', clearSelection);
            document.getElementById('select-all-btn').addEventListener('click', selectAllOnPage);

            // Add server button
            document.getElementById('add-server-btn').addEventListener('click', () => openModal('server-modal'));

            // Auth method toggle
            document.getElementById('auth-method').addEventListener('change', (e) => {
                document.getElementById('auth-key-fields').style.display = e.target.value === 'key' ? 'block' : 'none';
                document.getElementById('auth-creds-fields').style.display = e.target.value === 'creds' ? 'block' : 'none';
            });

            // Save settings
            document.getElementById('save-settings-btn').addEventListener('click', saveSettings);
            
            // Folder naming format preview
            document.getElementById('folder-naming-format').addEventListener('change', updateFolderFormatPreview);
            
            // Save language button
            document.getElementById('save-language-btn').addEventListener('click', saveLanguage);

            // Advanced toggle
            document.getElementById('advanced-toggle').addEventListener('click', () => {
                document.getElementById('advanced-toggle').classList.toggle('open');
                document.getElementById('advanced-content').classList.toggle('open');
            });

            // Sync controls
            document.getElementById('sync-now-btn').addEventListener('click', () => {
                api('sync', 'POST');
                showToast('Sync started');
            });

            document.getElementById('auto-sync-toggle').addEventListener('change', async (e) => {
                config.auto_sync_enabled = e.target.checked;
                await api('config', 'POST', config);
            });

            // Add mapping button
            document.getElementById('add-mapping-btn').addEventListener('click', openMappingModal);

            // Rebuild cache
            document.getElementById('rebuild-cache-btn').addEventListener('click', () => {
                api('rebuild_cache', 'POST');
                showToast('Cache rebuild started');
            });
            
            // History toggle
            document.getElementById('toggle-history-btn').addEventListener('click', toggleHistoryView);
        }
        
        let showingHistory = false;
        
        function toggleHistoryView() {
            showingHistory = !showingHistory;
            const logContainer = document.getElementById('log-container');
            const historyContainer = document.getElementById('history-container');
            const btn = document.getElementById('toggle-history-btn');
            
            if (showingHistory) {
                logContainer.style.display = 'none';
                historyContainer.style.display = 'block';
                btn.textContent = 'üìã';
                btn.title = 'Back to Activity Log';
                loadHistory();
            } else {
                logContainer.style.display = 'block';
                historyContainer.style.display = 'none';
                btn.textContent = 'üìú';
                btn.title = 'Download History';
            }
        }
        
        async function loadHistory() {
            const history = await api('history');
            const container = document.getElementById('history-container');
            
            if (!history || history.length === 0) {
                container.innerHTML = '<div class="log-line">No download history yet...</div>';
                return;
            }
            
            container.innerHTML = history.map(item => `
                <div class="history-item">
                    <div class="history-item-name">‚úì ${escapeHtml(item.filename)}</div>
                    <div class="history-item-meta">
                        ${formatBytes(item.size)}<br>
                        ${item.timestamp}
                    </div>
                </div>
            `).join('');
        }
        
        function formatBytes(bytes) {
            if (!bytes) return '0 B';
            const units = ['B', 'KB', 'MB', 'GB', 'TB'];
            let i = 0;
            while (bytes >= 1024 && i < units.length - 1) {
                bytes /= 1024;
                i++;
            }
            return bytes.toFixed(2) + ' ' + units[i];
        }

        // Remote Browser
        async function browseRemote() {
            if (!currentServerId) return;

            const grid = document.getElementById('browser-grid');
            grid.innerHTML = '<div class="empty-state"><div class="spin">üîÑ</div><p>Loading...</p></div>';
            
            // Clear search when browsing new folder
            document.getElementById('library-search').value = '';
            filterText = '';
            document.getElementById('search-status').style.display = 'none';
            searchActive = false;
            
            // Show/hide search box based on level (hide at root)
            document.getElementById('search-box').style.display = currentParentId === 'root' ? 'none' : 'block';

            const data = await api('browse_remote', 'POST', {
                server_id: currentServerId,
                parent_id: currentParentId,
                page: currentPage,
                items_per_page: itemsPerPage
            });

            baseUrl = data.base_url;
            currentBaseUrl = data.base_url;  // Store for search results
            totalItems = data.total || 0;
            totalPages = data.total_pages || 1;
            
            // Store items for filtering
            currentItems = data.items || [];
            
            renderBrowserItems(currentItems);
            renderBrowserPath();
            renderPagination();
        }
        
        function renderPagination() {
            const controls = document.getElementById('pagination-controls');
            const infoText = document.getElementById('pagination-info-text');
            const pageNumbers = document.getElementById('page-numbers');
            
            // Only show pagination if we have more than one page or if not at root
            if (totalPages <= 1 && currentParentId === 'root') {
                controls.style.display = 'none';
                return;
            }
            
            controls.style.display = 'flex';
            
            const startItem = (currentPage - 1) * itemsPerPage + 1;
            const endItem = Math.min(currentPage * itemsPerPage, totalItems);
            infoText.textContent = totalItems > 0 
                ? `Showing ${startItem}-${endItem} of ${totalItems} items (Page ${currentPage}/${totalPages})`
                : `Page ${currentPage} of ${totalPages}`;
            
            // Update button states
            document.getElementById('page-first').disabled = currentPage <= 1;
            document.getElementById('page-prev').disabled = currentPage <= 1;
            document.getElementById('page-next').disabled = currentPage >= totalPages;
            document.getElementById('page-last').disabled = currentPage >= totalPages;
            
            // Render page numbers
            let html = '';
            const maxPages = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxPages / 2));
            let endPage = Math.min(totalPages, startPage + maxPages - 1);
            
            if (endPage - startPage < maxPages - 1) {
                startPage = Math.max(1, endPage - maxPages + 1);
            }
            
            for (let i = startPage; i <= endPage; i++) {
                html += `<button class="page-number ${i === currentPage ? 'active' : ''}" onclick="goToPage(${i})">${i}</button>`;
            }
            pageNumbers.innerHTML = html;
        }
        
        function goToPage(page) {
            if (page < 1 || page > totalPages || page === currentPage) return;
            currentPage = page;
            browseRemote();
        }
        
        function setupPaginationListeners() {
            document.getElementById('page-first').onclick = () => goToPage(1);
            document.getElementById('page-prev').onclick = () => goToPage(currentPage - 1);
            document.getElementById('page-next').onclick = () => goToPage(currentPage + 1);
            document.getElementById('page-last').onclick = () => goToPage(totalPages);
            
            document.getElementById('items-per-page').onchange = (e) => {
                itemsPerPage = parseInt(e.target.value);
                currentPage = 1;
                browseRemote();
            };
        }

        function renderBrowserItems(items) {
            const grid = document.getElementById('browser-grid');
            
            if (!items || items.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìÇ</div>
                        <div class="empty-state-title">Empty Folder</div>
                        <p>No items found in this location.</p>
                    </div>
                `;
                return;
            }
            
            // Show interaction hints when items are displayed
            const hint = document.getElementById('interaction-hint');
            if (hint) hint.style.display = 'block';

            grid.innerHTML = items.map(item => {
                const icon = item.IsFolder ? 'üìÅ' : (item.Type === 'Movie' ? 'üé¨' : 'üì∫');
                
                // Get Primary poster image at reasonable size
                const imgSrc = item.HasPrimary ? `${baseUrl}/Items/${item.Id}/Images/Primary?maxWidth=300&quality=90` : '';
                
                const classes = ['browser-item'];
                if (item.IsFolder) classes.push('folder');
                if (item.Type === 'Series') classes.push('series'); // Series looks like media, not pure folder
                if (item.Type === 'Movie' || item.Type === 'Episode') classes.push('media-item');
                
                // Handle exists status: 'full', 'partial', or false
                if (item.ExistsLocally === 'full' || item.ExistsLocally === true) {
                    classes.push('exists');
                } else if (item.ExistsLocally === 'partial') {
                    classes.push('partial');
                }
                
                if (selectedItems.has(item.Id)) classes.push('selected');
                
                // Check if item is in skip list
                const isSkipped = skipList.some(s => s.id === item.Id);
                if (isSkipped) classes.push('is-skipped');
                
                // Tooltip text - show name, and for folders add hint
                const tooltipText = item.IsFolder 
                    ? `${escapeHtml(item.Name)} (double-click to open)` 
                    : escapeHtml(item.Name);
                
                // Determine if this item should show overlays
                // Show for: Movies, Episodes, AND Series (which are "folders" but have ratings)
                const showOverlays = item.Type === 'Movie' || item.Type === 'Episode' || item.Type === 'Series';
                
                // Build rating badge HTML
                let ratingBadgeHtml = '';
                let contentRatingHtml = '';
                let qualityBadgesHtml = '';
                
                if (showOverlays && config.show_ratings !== false) {
                    // IMDB/TMDB Rating (CommunityRating is 0-10 scale)
                    if (item.CommunityRating && item.CommunityRating > 0) {
                        const rating = item.CommunityRating.toFixed(1);
                        ratingBadgeHtml = `<div class="rating-badge imdb"><span class="rating-badge-icon">‚≠ê</span>${rating}</div>`;
                    }
                    
                    // Critic Rating (Rotten Tomatoes 0-100)
                    if (item.CriticRating && item.CriticRating > 0) {
                        const isFresh = item.CriticRating >= 60;
                        const rtIcon = isFresh ? 'üçÖ' : 'ü•¨';
                        const rtClass = isFresh ? 'rt-fresh' : 'rt-rotten';
                        // If we already have community rating, show RT below it
                        if (!ratingBadgeHtml) {
                            ratingBadgeHtml = `<div class="rating-badge ${rtClass}"><span class="rating-badge-icon">${rtIcon}</span>${item.CriticRating}%</div>`;
                        }
                    }
                    
                    // Content Rating (PG-13, R, TV-MA, etc)
                    if (item.OfficialRating) {
                        contentRatingHtml = `<div class="content-rating-badge">${escapeHtml(item.OfficialRating)}</div>`;
                    }
                }
                
                // Build quality badges (resolution, HDR, Atmos) - only for actual media files (Movies, Episodes)
                if ((item.Type === 'Movie' || item.Type === 'Episode') && config.show_quality !== false) {
                    const qualityBadges = [];
                    
                    // Resolution badge
                    if (item.Resolution) {
                        const resClass = item.Resolution === '4K' ? 'res-4k' : 
                                        item.Resolution === '1080p' ? 'res-1080p' :
                                        item.Resolution === '720p' ? 'res-720p' : 'res-sd';
                        qualityBadges.push(`<span class="quality-badge ${resClass}">${item.Resolution}</span>`);
                    }
                    
                    // Dolby Vision (takes priority over HDR)
                    if (item.IsDolbyVision) {
                        qualityBadges.push(`<span class="quality-badge dolby-vision">DV</span>`);
                    } else if (item.IsHDR) {
                        qualityBadges.push(`<span class="quality-badge hdr">HDR</span>`);
                    }
                    
                    // Atmos
                    if (item.IsAtmos) {
                        qualityBadges.push(`<span class="quality-badge atmos">ATMOS</span>`);
                    }
                    
                    if (qualityBadges.length > 0) {
                        qualityBadgesHtml = `<div class="quality-badges">${qualityBadges.join('')}</div>`;
                    }
                }
                
                // Collection/Playlist download button
                let collectionBtnHtml = '';
                if (item.Type === 'BoxSet' || item.Type === 'Playlist') {
                    collectionBtnHtml = `<button class="collection-download-btn" onclick="event.stopPropagation(); downloadCollection('${item.Id}', '${escapeHtml(item.Name)}')" title="Download All Items">
                        <span>‚¨áÔ∏è</span> Download All
                    </button>`;
                }
                
                // Skip button for Series and Movies (for auto-sync)
                let skipBtnHtml = '';
                let skippedBadgeHtml = '';
                let episodeCountBadgeHtml = '';
                if (item.Type === 'Series' || item.Type === 'Movie') {
                    skipBtnHtml = `<button class="skip-btn ${isSkipped ? 'skipped' : ''}" 
                        onclick="event.stopPropagation(); toggleSkip('${item.Id}', '${escapeHtml(item.Name)}', '${item.Type}')" 
                        title="${isSkipped ? 'Click to remove from skip list' : 'Skip in auto-sync'}">
                        ${isSkipped ? '‚úï' : '‚è≠Ô∏è'}
                    </button>`;
                    
                    if (isSkipped) {
                        skippedBadgeHtml = `<div class="skipped-badge">SKIPPED</div>`;
                    }
                }
                
                // Episode count badge for partial series
                if (item.Type === 'Series' && item.ExistsLocally === 'partial' && item.LocalEpisodeCount > 0) {
                    const totalEps = item.RecursiveItemCount || item.ChildCount || '?';
                    episodeCountBadgeHtml = `<div class="episode-count-badge">${item.LocalEpisodeCount}/${totalEps} episodes</div>`;
                }

                return `
                    <div class="${classes.join(' ')}" 
                         data-id="${item.Id}" 
                         data-name="${escapeHtml(item.Name)}"
                         data-folder="${item.IsFolder}"
                         data-type="${item.Type || ''}"
                         title="${tooltipText}"
                         onclick="handleItemClick(event, '${item.Id}', ${item.IsFolder}, '${escapeHtml(item.Name)}')"
                         ondblclick="handleItemDblClick(event, '${item.Id}', ${item.IsFolder}, '${escapeHtml(item.Name)}')"
                         oncontextmenu="handleItemContext(event, '${item.Id}')">
                        ${ratingBadgeHtml}
                        ${contentRatingHtml}
                        ${skipBtnHtml}
                        ${skippedBadgeHtml}
                        ${episodeCountBadgeHtml}
                        ${imgSrc ? 
                            `<img class="browser-item-poster" src="${imgSrc}" loading="lazy" alt="" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                             <div class="browser-item-placeholder" style="display:none;">${icon}</div>` :
                            `<div class="browser-item-placeholder">${icon}</div>`
                        }
                        ${qualityBadgesHtml}
                        ${collectionBtnHtml}
                        <div class="browser-item-title">${escapeHtml(item.Name)}</div>
                    </div>
                `;
            }).join('');
        }

        function handleItemClick(e, id, isFolder, name) {
            if (e.ctrlKey || e.metaKey) {
                toggleSelection(id);
            } else {
                // Single click always selects (for both folders and media)
                toggleSelection(id);
            }
        }
        
        function handleItemDblClick(e, id, isFolder, name) {
            if (isFolder) {
                // Double click navigates into folders
                navigateTo(id, name);
            }
        }

        function handleItemContext(e, id) {
            e.preventDefault();
            toggleSelection(id);
        }

        function toggleSelection(id) {
            if (selectedItems.has(id)) {
                selectedItems.delete(id);
            } else {
                selectedItems.add(id);
            }
            updateSelectionUI();
        }

        function selectAllOnPage() {
            // Now includes folders too
            const items = document.querySelectorAll('.browser-item');
            const allSelected = Array.from(items).every(el => selectedItems.has(el.dataset.id));
            
            if (allSelected) {
                // Deselect all
                items.forEach(el => selectedItems.delete(el.dataset.id));
                document.getElementById('select-all-btn').textContent = 'Select All';
            } else {
                // Select all non-folder items
                items.forEach(el => selectedItems.add(el.dataset.id));
                document.getElementById('select-all-btn').textContent = 'Deselect All';
            }
            updateSelectionUI();
        }

        function updateSelectionUI() {
            document.querySelectorAll('.browser-item').forEach(el => {
                el.classList.toggle('selected', selectedItems.has(el.dataset.id));
            });

            const bar = document.getElementById('selection-bar');
            const count = document.getElementById('selection-count');
            
            if (selectedItems.size > 0) {
                bar.classList.add('active');
                count.textContent = selectedItems.size;
            } else {
                bar.classList.remove('active');
                document.getElementById('select-all-btn').textContent = 'Select All';
            }
        }

        function clearSelection() {
            selectedItems.clear();
            updateSelectionUI();
            document.getElementById('select-all-btn').textContent = 'Select All';
        }

        function navigateTo(id, name) {
            // If we're at root, this is a library - track it
            if (currentParentId === 'root') {
                currentLibraryId = id;
            }
            currentParentId = id;
            currentPage = 1;
            browserPath.push({ id, name });
            clearSelection();
            
            // Clear search when navigating
            searchActive = false;
            document.getElementById('search-status').style.display = 'none';
            
            browseRemote();
        }

        function navigateToPath(index) {
            browserPath = browserPath.slice(0, index + 1);
            currentParentId = browserPath[browserPath.length - 1].id;
            
            // If going back to root, clear library ID
            if (currentParentId === 'root') {
                currentLibraryId = null;
            } else if (index === 1) {
                // If going back to index 1, that's the library level
                currentLibraryId = browserPath[1].id;
            }
            
            currentPage = 1;
            clearSelection();
            
            // Clear search when navigating
            searchActive = false;
            document.getElementById('search-status').style.display = 'none';
            
            browseRemote();
        }

        function renderBrowserPath() {
            const container = document.getElementById('browser-path');
            container.innerHTML = browserPath.map((item, i) => 
                `<span class="browser-path-item" onclick="navigateToPath(${i})">${escapeHtml(item.name)}</span>` +
                (i < browserPath.length - 1 ? '<span>/</span>' : '')
            ).join('');
        }

        // Download Path Selection
        async function openPathModal() {
            openModal('path-modal');
            pendingDownloadPath = '/storage';
            
            // Show quick paths from library mappings
            const quickPaths = document.getElementById('quick-paths');
            const serverMappings = (config.mappings || []).filter(m => m.server_id === currentServerId);
            
            if (serverMappings.length > 0) {
                quickPaths.innerHTML = `
                    <div class="form-label" style="margin-bottom: 0.5rem;">üìÅ Quick Paths (from mappings):</div>
                    ${serverMappings.map(m => `
                        <button class="btn btn-secondary btn-sm" style="margin: 0.25rem;" onclick="selectQuickPath('${m.local_path}')">
                            ${escapeHtml(m.lib_name)} ‚Üí ${escapeHtml(m.local_path)}
                        </button>
                    `).join('')}
                `;
            } else {
                quickPaths.innerHTML = '<div class="form-hint">No library mappings for this server. Add mappings in Sync tab for quick access.</div>';
            }
            
            browseLocalPath('/storage');
        }
        
        function selectQuickPath(path) {
            pendingDownloadPath = path;
            document.getElementById('local-path-display').textContent = path;
            browseLocalPath(path);
        }

        async function browseLocalPath(path) {
            const data = await api('browse_local', 'POST', { path });
            pendingDownloadPath = data.current;
            document.getElementById('local-path-display').textContent = data.current;

            const list = document.getElementById('local-folder-list');
            let html = '';

            if (data.parent) {
                html += `<div class="server-item" onclick="browseLocalPath('${data.parent}')">
                    <div class="server-icon">‚¨ÜÔ∏è</div>
                    <div class="server-info"><div class="server-name">..</div></div>
                </div>`;
            }

            data.folders.forEach(folder => {
                const fullPath = data.current === '/' ? `/${folder}` : `${data.current}/${folder}`;
                html += `<div class="server-item" onclick="browseLocalPath('${fullPath}')">
                    <div class="server-icon">üìÅ</div>
                    <div class="server-info"><div class="server-name">${escapeHtml(folder)}</div></div>
                </div>`;
            });

            list.innerHTML = html || '<div class="empty-state" style="padding: 1rem;"><p>No subfolders</p></div>';
        }

        async function confirmDownloadPath() {
            const itemCount = selectedItems.size;
            
            if (config.confirm_downloads) {
                if (!confirm(`Download ${itemCount} item(s) to ${pendingDownloadPath}?`)) {
                    return;
                }
            }

            await api('batch_download', 'POST', {
                server_id: currentServerId,
                item_ids: Array.from(selectedItems),
                path: pendingDownloadPath
            });

            closeModal('path-modal');
            clearSelection();
            showToast(`Queued ${itemCount} item(s) for download`);
        }

        // Download entire collection/playlist
        async function downloadCollection(collectionId, collectionName) {
            showToast(`üì¶ Fetching items from "${collectionName}"...`, 'info');
            
            try {
                // First, get all items in the collection
                const result = await api('collection_items', 'POST', {
                    server_id: currentServerId,
                    collection_id: collectionId
                });
                
                if (result.error) {
                    showToast('‚ùå ' + result.error, 'error');
                    return;
                }
                
                if (!result.items || result.items.length === 0) {
                    showToast('üì≠ Collection is empty or has no downloadable items', 'warning');
                    return;
                }
                
                const itemCount = result.items.length;
                
                // Confirm download
                if (!confirm(`Download all ${itemCount} items from "${collectionName}"?\n\nThis will queue all movies/episodes in this collection.`)) {
                    return;
                }
                
                // Get download path - use default or last used
                const downloadPath = config.download_path || '/downloads';
                
                // Queue all items
                const itemIds = result.items.map(item => item.Id);
                
                await api('batch_download', 'POST', {
                    server_id: currentServerId,
                    item_ids: itemIds,
                    path: downloadPath
                });
                
                showToast(`üì¶ Queued ${itemCount} items from "${collectionName}"`, 'success');
                
            } catch (e) {
                showToast('‚ùå Failed to fetch collection items', 'error');
                console.error('Collection download error:', e);
            }
        }

        // Server Management
        async function testServerConnection() {
            const url = document.getElementById('server-url').value;
            const method = document.getElementById('auth-method').value;
            
            let payload = { url };
            if (method === 'key') {
                payload.key = document.getElementById('server-key').value;
            } else {
                payload.username = document.getElementById('server-username').value;
                payload.password = document.getElementById('server-password').value;
            }

            const result = await api('test_connection', 'POST', payload);
            if (result.status === 'ok') {
                showToast('Connection successful!');
                // Store the token and user_id
                document.getElementById('server-key').value = result.key;
                document.getElementById('server-key').dataset.tested = 'true';
                if (result.user_id) {
                    document.getElementById('server-key').dataset.userId = result.user_id;
                }
            } else {
                showToast(result.error || 'Connection failed', 'error');
            }
        }

        async function saveServer() {
            const name = document.getElementById('server-name').value;
            const url = document.getElementById('server-url').value;
            const key = document.getElementById('server-key').value;
            const userId = document.getElementById('server-key').dataset.userId || null;

            if (!name || !url) {
                showToast('Please fill in server name and URL', 'error');
                return;
            }
            
            if (!key) {
                showToast('Please test connection first to verify credentials', 'error');
                return;
            }

            const server = {
                id: Date.now().toString(36),
                name,
                url: url.replace(/\/$/, ''),
                key,
                user_id: userId  // Store user_id for username/password auth
            };

            if (!config.servers) config.servers = [];
            config.servers.push(server);
            await api('config', 'POST', config);
            closeModal('server-modal');
            loadConfig();
            showToast('Server added');
            
            // Clear form
            document.getElementById('server-name').value = '';
            document.getElementById('server-url').value = '';
            document.getElementById('server-key').value = '';
            document.getElementById('server-key').dataset.userId = '';
        }

        // Mapping Management
        async function openMappingModal() {
            const serverSelect = document.getElementById('mapping-server');
            serverSelect.innerHTML = '<option value="">Select Server...</option>' +
                (config.servers || []).map(s => `<option value="${s.id}">${escapeHtml(s.name)}</option>`).join('');

            serverSelect.onchange = async () => {
                const libs = await api('scan_libs');
                const serverLibs = libs.find(l => l.server_id === serverSelect.value);
                const libSelect = document.getElementById('mapping-library');
                
                if (serverLibs) {
                    libSelect.innerHTML = serverLibs.libs.map(l => 
                        `<option value="${l.Id}" data-name="${escapeHtml(l.Name)}">${escapeHtml(l.Name)}</option>`
                    ).join('');
                }
            };

            openModal('mapping-modal');
        }

        async function saveMapping() {
            const serverId = document.getElementById('mapping-server').value;
            const libSelect = document.getElementById('mapping-library');
            const libId = libSelect.value;
            const libName = libSelect.options[libSelect.selectedIndex]?.dataset.name;
            const path = document.getElementById('mapping-path').value;

            if (!serverId || !libId || !path) {
                showToast('Please fill in all fields', 'error');
                return;
            }

            const mapping = {
                id: Date.now().toString(36),
                server_id: serverId,
                lib_id: libId,
                lib_name: libName,
                local_path: path
            };

            if (!config.mappings) config.mappings = [];
            config.mappings.push(mapping);
            await api('config', 'POST', config);
            closeModal('mapping-modal');
            loadConfig();
            showToast('Mapping added');
        }

        // Mapping Path Browser
        let mappingBrowserPath = '/storage';
        
        async function openMappingPathBrowser() {
            const browser = document.getElementById('mapping-folder-browser');
            browser.style.display = browser.style.display === 'none' ? 'block' : 'none';
            if (browser.style.display === 'block') {
                mappingBrowserPath = document.getElementById('mapping-path').value || '/storage';
                await browseMappingPath(mappingBrowserPath);
            }
        }
        
        async function browseMappingPath(path) {
            const data = await api('browse_local', 'POST', { path });
            mappingBrowserPath = data.current;
            
            const list = document.getElementById('mapping-folder-list');
            let html = `<div style="padding: 0.5rem; border-bottom: 1px solid var(--jf-border); background: var(--jf-bg-card); font-size: 0.8rem; color: var(--jf-text-muted);">${data.current}</div>`;
            
            if (data.parent) {
                html += `<div class="server-item" style="padding: 0.5rem; cursor: pointer;" onclick="browseMappingPath('${data.parent}')">
                    <span style="margin-right: 0.5rem;">‚¨ÜÔ∏è</span> ..
                </div>`;
            }
            
            data.folders.forEach(folder => {
                const fullPath = data.current === '/' ? `/${folder}` : `${data.current}/${folder}`;
                html += `<div class="server-item" style="padding: 0.5rem; cursor: pointer; display: flex; justify-content: space-between; align-items: center;" onmouseover="this.style.background='var(--jf-bg-card-hover)'" onmouseout="this.style.background=''">
                    <span onclick="browseMappingPath('${fullPath}')" style="flex: 1; display: flex; align-items: center;">
                        <span style="margin-right: 0.5rem;">üìÅ</span> ${folder}
                    </span>
                    <button class="btn btn-sm btn-primary" onclick="selectMappingPath('${fullPath}')" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">Select</button>
                </div>`;
            });
            
            // Add select current folder button
            html += `<div style="padding: 0.5rem; border-top: 1px solid var(--jf-border);">
                <button class="btn btn-primary btn-sm" onclick="selectMappingPath('${data.current}')" style="width: 100%;">Select This Folder</button>
            </div>`;
            
            list.innerHTML = html;
        }
        
        function selectMappingPath(path) {
            document.getElementById('mapping-path').value = path;
            document.getElementById('mapping-folder-browser').style.display = 'none';
        }

        // Status Polling (optimized - 2 second interval)
        function startStatusPolling() {
            async function poll() {
                try {
                    const status = await api('status');
                    updateDownloadQueue(status);
                    updateStats(status);
                    updateScanProgress(status.scan_progress);
                    
                    // Update mobile stats
                    if (typeof updateMobileStats === 'function') {
                        updateMobileStats(status);
                    }

                    // Update pause state for keyboard shortcut
                    is_paused = status.paused;
                    document.getElementById('pause-btn').style.display = status.paused ? 'none' : 'flex';
                    document.getElementById('resume-btn').style.display = status.paused ? 'flex' : 'none';
                } catch (err) {
                    console.error('Status poll error:', err);
                }
            }
            poll();
            setInterval(poll, 2000); // 2 second polling for better performance
        }

        function updateDownloadQueue(status) {
            const container = document.getElementById('download-queue');
            const active = Object.values(status.active || {});
            const pending = status.pending || [];
            const pendingTranscodes = status.pending_transcodes || [];

            if (active.length === 0 && pending.length === 0 && pendingTranscodes.length === 0) {
                container.innerHTML = `<div class="queue-empty"><div class="queue-empty-icon">üì≠</div><p>${t('no_active_downloads')}</p></div>`;
                return;
            }

            container.innerHTML = [
                ...active.map(d => {
                    const eta = calculateETA(d);
                    const isTranscode = d.transcode || d.status?.includes('Transcoding');
                    return `
                    <div class="download-item">
                        <div class="download-header">
                            <span class="download-name" title="${escapeHtml(d.filename)}">${escapeHtml(d.filename)}</span>
                            <div class="download-header-right">
                                <span class="download-status ${d.status === 'Paused' ? 'paused' : ''} ${isTranscode ? 'transcoding' : ''}">${d.status}</span>
                                <button class="btn btn-danger btn-xs" onclick="cancelSingleDownload('${d.id}')" title="Cancel">‚úï</button>
                            </div>
                        </div>
                        <div class="download-progress">
                            <div class="download-progress-bar ${isTranscode ? 'transcode' : ''}" style="width: ${d.percent}%"></div>
                        </div>
                        <div class="download-meta">
                            <span>${d.speed}${eta ? ' ‚Ä¢ ' + eta : ''}</span>
                            <span>${d.percent}%</span>
                        </div>
                    </div>
                `}),
                ...pending.map(p => `
                    <div class="download-item">
                        <div class="download-header">
                            <span class="download-name" title="${escapeHtml(p.name)}">${escapeHtml(p.name)}</span>
                            <div class="download-header-right">
                                <span class="download-status pending">Pending</span>
                                <button class="btn btn-danger btn-xs" onclick="cancelSingleDownload('${p.id}')" title="Cancel">‚úï</button>
                            </div>
                        </div>
                    </div>
                `),
                ...pendingTranscodes.map(p => `
                    <div class="download-item">
                        <div class="download-header">
                            <span class="download-name" title="${escapeHtml(p.name)}">üîÑ ${escapeHtml(p.name)}</span>
                            <div class="download-header-right">
                                <span class="download-status transcoding-pending">Queued (${p.preset})</span>
                                <button class="btn btn-danger btn-xs" onclick="cancelSingleDownload('${p.id}')" title="Cancel">‚úï</button>
                            </div>
                        </div>
                    </div>
                `)
            ].join('');
        }
        
        // Resumable Downloads (Pro feature)
        let lastResumableCheck = 0;
        
        async function loadResumableDownloads() {
            const now = Date.now();
            if (now - lastResumableCheck < 30000) return; // Check every 30 seconds
            lastResumableCheck = now;
            
            try {
                const data = await api('downloads/resumable');
                const section = document.getElementById('resumable-downloads');
                const list = document.getElementById('resumable-list');
                
                if (data.pro_required || !data.resumable || data.resumable.length === 0) {
                    section.style.display = 'none';
                    return;
                }
                
                section.style.display = 'block';
                list.innerHTML = data.resumable.map(item => `
                    <div class="resumable-item">
                        <div class="resumable-info">
                            <div class="resumable-name" title="${escapeHtml(item.filename)}">${escapeHtml(item.filename)}</div>
                            <div class="resumable-meta">
                                ${item.downloaded_human} / ${item.total_human} (${item.percent}%) ‚Ä¢ ${item.age}
                            </div>
                        </div>
                        <div class="resumable-actions">
                            <button class="btn btn-primary btn-sm" onclick="resumePartialDownload('${item.task_id}')" title="Resume">‚ñ∂Ô∏è</button>
                            <button class="btn btn-danger btn-sm" onclick="deletePartialDownload('${item.task_id}')" title="Delete">üóëÔ∏è</button>
                        </div>
                    </div>
                `).join('');
            } catch (e) {
                // Silently fail
            }
        }
        
        async function resumePartialDownload(taskId) {
            try {
                const result = await fetch('/api/downloads/resume_partial', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ task_id: taskId })
                }).then(r => r.json());
                
                if (result.success) {
                    showToast('üîÑ ' + result.message, 'success');
                    lastResumableCheck = 0; // Force refresh
                    loadResumableDownloads();
                } else {
                    showToast('‚ùå ' + result.error, 'error');
                }
            } catch (e) {
                showToast('Failed to resume download', 'error');
            }
        }
        
        async function deletePartialDownload(taskId) {
            if (!confirm('Delete this partial download? This cannot be undone.')) return;
            
            try {
                const result = await fetch('/api/downloads/delete_partial', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ task_id: taskId })
                }).then(r => r.json());
                
                if (result.success) {
                    showToast('üóëÔ∏è Partial download deleted', 'success');
                    lastResumableCheck = 0; // Force refresh
                    loadResumableDownloads();
                } else {
                    showToast('‚ùå ' + result.error, 'error');
                }
            } catch (e) {
                showToast('Failed to delete partial download', 'error');
            }
        }
        
        // Load resumable downloads periodically
        setInterval(loadResumableDownloads, 30000);
        setTimeout(loadResumableDownloads, 2000); // Initial check after 2 sec
        
        function calculateETA(download) {
            if (!download.speed_raw || download.speed_raw <= 0) return null;
            if (!download.total || download.total <= 0) return null;
            
            const remaining = download.total - download.current;
            if (remaining <= 0) return null;
            
            const seconds = Math.round(remaining / download.speed_raw);
            
            if (seconds < 60) return `~${seconds}s`;
            if (seconds < 3600) return `~${Math.round(seconds / 60)}m`;
            return `~${Math.round(seconds / 3600)}h ${Math.round((seconds % 3600) / 60)}m`;
        }

        function updateStats(status) {
            const activeCount = Object.keys(status.active || {}).length;
            const pendingCount = (status.pending || []).length + (status.queue_size || 0);
            
            document.getElementById('stat-active').textContent = activeCount;
            document.getElementById('stat-pending').textContent = pendingCount;
            document.getElementById('stat-cached').textContent = status.cache_count || 0;
            document.getElementById('stat-cache-time').textContent = status.cache_time || 'Never';
            
            // Update title bar with download count
            if (activeCount > 0) {
                document.title = `JellyLooter (${activeCount} ‚¨á)`;
                // Refresh total stats more often when downloads are active
                updateTotalStats(true);
            } else if (pendingCount > 0) {
                document.title = `JellyLooter (${pendingCount} pending)`;
            } else {
                document.title = 'JellyLooter';
            }
            
            // Update stats widget - calculate current speed from active downloads
            let currentSpeed = 0;
            Object.values(status.active || {}).forEach(dl => {
                if (dl.speed_raw) currentSpeed += dl.speed_raw;
            });
            
            document.getElementById('stat-speed').textContent = currentSpeed > 0 
                ? (currentSpeed > 1024*1024 ? `${(currentSpeed/1024/1024).toFixed(1)} MB/s` : `${(currentSpeed/1024).toFixed(0)} KB/s`)
                : '0 KB/s';
            document.getElementById('stat-queue').textContent = activeCount + pendingCount;
        }
        
        // Fetch and update total downloaded stats (less frequently)
        let lastStatsUpdate = 0;
        async function updateTotalStats(force = false) {
            const now = Date.now();
            const interval = force ? 3000 : 10000; // 3 sec when forced, 10 sec otherwise
            if (now - lastStatsUpdate < interval) return;
            lastStatsUpdate = now;
            
            try {
                const stats = await api('stats');
                document.getElementById('stat-total-downloaded').textContent = stats.total_human || '0 B';
                document.getElementById('stat-today').textContent = stats.today_count || 0;
            } catch (e) {
                // Silently fail
            }
        }
        
        // Call total stats update periodically
        setInterval(updateTotalStats, 10000);
        setTimeout(updateTotalStats, 1000); // Initial update after 1 sec

        function updateScanProgress(scan) {
            const container = document.getElementById('scan-progress');
            if (scan && scan.running) {
                container.style.display = 'block';
                document.getElementById('scan-percent').textContent = `${scan.percent}%`;
                document.getElementById('scan-fill').style.width = `${scan.percent}%`;
            } else {
                container.style.display = 'none';
            }
        }

        // Log Polling
        let logViewMode = 'basic';
        
        // Basic log patterns - only show these in basic mode
        const basicLogPatterns = [
            /^‚¨áÔ∏è/,          // Download starting
            /^‚úì/,           // Success
            /^‚úó/,           // Error
            /^üì•/,          // Queued
            /^üîÑ/,          // Syncing/Transcoding
            /^‚è∏Ô∏è/,          // Paused
            /^‚ñ∂Ô∏è/,          // Resumed
            /^\d+%/,        // Progress
            /Downloading:/,
            /Download complete/i,
            /Complete:/,
            /Queued:/,
            /Started:/,
            /Cancelled/,
            /Failed/,
            /Error/,
            /paused/i,
            /resumed/i
        ];
        
        function isBasicLogLine(line) {
            if (!line || line.trim() === '') return false;
            return basicLogPatterns.some(pattern => pattern.test(line));
        }
        
        function startLogPolling() {
            async function poll() {
                try {
                    const res = await fetch('/api/logs');
                    const text = await res.text();
                    const container = document.getElementById('log-container');
                    
                    if (text.trim()) {
                        const lines = text.split('\n');
                        const viewMode = document.getElementById('log-view-mode')?.value || 'basic';
                        
                        // Filter lines based on view mode
                        const filteredLines = viewMode === 'basic' 
                            ? lines.filter(line => isBasicLogLine(line))
                            : lines;
                        
                        if (filteredLines.length === 0 && viewMode === 'basic') {
                            container.innerHTML = '<div class="log-line" style="color: var(--jf-text-muted);">Waiting for downloads... (switch to Advanced for all logs)</div>';
                        } else {
                            container.innerHTML = filteredLines.map(line => {
                                let cls = '';
                                if (line.includes('‚úì') || line.includes('Complete')) cls = 'success';
                                if (line.includes('‚úó') || line.includes('Error') || line.includes('Failed')) cls = 'error';
                                return `<div class="log-line"><span class="${cls}">${escapeHtml(line)}</span></div>`;
                            }).join('');
                        }
                    }
                } catch (err) {
                    console.error('Log poll error:', err);
                }
            }
            poll();
            setInterval(poll, 2000);
        }

        // Modal Helpers
        function openModal(id) {
            document.getElementById(id).classList.add('active');
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }

        // Utility
        function escapeHtml(str) {
            if (!str) return '';
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }
        
        // --- Mobile menu functions ---
        function openMobileDownloads() {
            openModal('mobile-downloads-modal');
            updateMobileDownloadQueue();
        }
        
        function openMobileLog() {
            openModal('mobile-log-modal');
            updateMobileLog();
        }
        
        function updateMobileDownloadQueue() {
            const mobileQueue = document.getElementById('mobile-download-queue');
            const desktopQueue = document.getElementById('download-queue');
            if (mobileQueue && desktopQueue) {
                mobileQueue.innerHTML = desktopQueue.innerHTML;
            }
        }
        
        function updateMobileLog() {
            const mobileLog = document.getElementById('mobile-log-container');
            const desktopLog = document.getElementById('log-container');
            if (mobileLog && desktopLog) {
                mobileLog.innerHTML = desktopLog.innerHTML;
            }
        }
        
        function updateMobileStats(data) {
            const activeCount = Object.keys(data.active || {}).length;
            const pendingCount = (data.pending || []).length;
            
            // Update mobile stats
            const mobileActive = document.getElementById('mobile-stat-active');
            const mobilePending = document.getElementById('mobile-stat-pending');
            const mobileBadge = document.getElementById('mobile-download-badge');
            
            if (mobileActive) mobileActive.textContent = activeCount;
            if (mobilePending) mobilePending.textContent = pendingCount;
            
            // Show badge if downloads active
            if (mobileBadge) {
                const total = activeCount + pendingCount;
                if (total > 0) {
                    mobileBadge.textContent = total;
                    mobileBadge.style.display = 'inline-block';
                } else {
                    mobileBadge.style.display = 'none';
                }
            }
            
            // Sync mobile pause/resume buttons
            const mobilePause = document.getElementById('mobile-pause-btn');
            const mobileResume = document.getElementById('mobile-resume-btn');
            if (mobilePause && mobileResume) {
                mobilePause.style.display = data.paused ? 'none' : '';
                mobileResume.style.display = data.paused ? '' : 'none';
            }
        }
        
        // --- License banner ---
        function initLicenseBanner() {
            const banner = document.getElementById('license-banner');
            if (!banner) return;
            
            // Check license status from last status poll
            fetch('/api/license')
                .then(r => r.json())
                .then(data => {
                    if (data.tier === 'pro') {
                        // Show thank you message for Pro users
                        banner.className = 'license-banner';
                        banner.style.background = 'linear-gradient(135deg, #4caf50 0%, #2e7d32 100%)';
                        banner.innerHTML = `
                            <span class="license-banner-text">‚≠ê Thank you for supporting JellyLooter!</span>
                            <button class="license-banner-btn" onclick="this.parentElement.style.display='none'">‚úì Dismiss</button>
                        `;
                        banner.style.display = 'flex';
                        // Auto-hide after 5 seconds
                        setTimeout(() => { banner.style.display = 'none'; }, 5000);
                        
                        // Show PRO badge
                        updateProBadge(true);
                    } else if (data.tier === 'trial') {
                        banner.className = 'license-banner license-banner-trial';
                        banner.innerHTML = `
                            <span class="license-banner-text">‚è∞ Pro Trial: ${data.trial_days_remaining} days remaining</span>
                            <button class="license-banner-btn" onclick="activateLicenseKey()">üîë Enter License</button>
                            <a href="https://lightwave43.gumroad.com/l/rmtmrr" target="_blank" class="license-banner-btn">Buy Pro - $10</a>
                        `;
                        banner.style.display = 'flex';
                        updateProBadge(false);
                    } else {
                        banner.className = 'license-banner license-banner-free';
                        banner.innerHTML = `
                            <span class="license-banner-text">üîì Free Version</span>
                            <button class="license-banner-btn" onclick="activateTrial()">üöÄ Start 14-Day Trial</button>
                            <a href="https://lightwave43.gumroad.com/l/rmtmrr" target="_blank" class="license-banner-btn" style="background: var(--jf-purple); color: white;">‚≠ê Go Pro - $10</a>
                        `;
                        banner.style.display = 'flex';
                        updateProBadge(false);
                    }
                })
                .catch(() => {
                    // Default to free banner on error
                    banner.style.display = 'flex';
                    updateProBadge(false);
                });
        }
        
        // PRO badge next to logo
        function updateProBadge(isPro) {
            const badge = document.getElementById('header-pro-badge');
            if (badge) {
                if (isPro) {
                    badge.style.display = 'inline-block';
                    badge.onclick = handleProBadgeClick;
                } else {
                    badge.style.display = 'none';
                }
            }
        }
        
        // Hidden license purge via PRO badge clicks
        let proBadgeClicks = 0;
        let proBadgeTimer = null;
        function handleProBadgeClick() {
            proBadgeClicks++;
            clearTimeout(proBadgeTimer);
            proBadgeTimer = setTimeout(() => { proBadgeClicks = 0; }, 500);
            
            if (proBadgeClicks >= 5) {
                proBadgeClicks = 0;
                purgeAllLicenses();
            }
        }
        
        function activateTrial() {
            fetch('/api/license/trial', { method: 'POST' })
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        showToast('üéâ Trial activated! Enjoy 14 days of Pro features.', 'success');
                        initLicenseBanner();
                        loadProSettings(); // Reload pro settings to enable sections
                    } else {
                        showToast(data.error || 'Could not activate trial', 'error');
                    }
                });
        }
        
        function activateLicenseKey() {
            const key = prompt('Enter your Pro license key:');
            if (!key) return;
            
            fetch('/api/license/activate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ key: key.trim() })
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    showToast('üéâ Pro license activated! Reloading...', 'success');
                    // Force immediate reload to apply all Pro settings
                    setTimeout(() => window.location.reload(true), 1000);
                } else {
                    showToast(data.error || 'Invalid license key', 'error');
                }
            });
        }
        
        // --- Settings Toggle Sections ---
        function setupSettingsToggles() {
            // Security toggle
            const securityToggle = document.getElementById('security-toggle');
            const securityContent = document.getElementById('security-content');
            if (securityToggle && securityContent) {
                securityToggle.addEventListener('click', () => {
                    securityContent.style.display = securityContent.style.display === 'none' ? 'block' : 'none';
                    securityToggle.querySelector('.advanced-toggle-icon').textContent = 
                        securityContent.style.display === 'none' ? '‚ñº' : '‚ñ≤';
                });
            }
            
            // Pro toggle
            const proToggle = document.getElementById('pro-toggle');
            const proContent = document.getElementById('pro-content');
            if (proToggle && proContent) {
                proToggle.addEventListener('click', () => {
                    proContent.style.display = proContent.style.display === 'none' ? 'block' : 'none';
                    proToggle.querySelector('.advanced-toggle-icon').textContent = 
                        proContent.style.display === 'none' ? '‚ñº' : '‚ñ≤';
                    if (proContent.style.display === 'block') {
                        loadProSettings();
                    }
                });
            }
            
            // Transcode preset change
            const transcodePreset = document.getElementById('transcode-preset');
            if (transcodePreset) {
                transcodePreset.addEventListener('change', () => {
                    document.getElementById('custom-transcode-group').style.display = 
                        transcodePreset.value === 'custom' ? 'block' : 'none';
                });
            }
        }
        
        // --- Load Pro Settings ---
        function loadProSettings() {
            fetch('/api/license')
                .then(r => r.json())
                .then(data => {
                    const statusBox = document.getElementById('license-status-box');
                    const proBadge = document.getElementById('pro-badge');
                    
                    // Update config.license_tier
                    config.license_tier = data.tier;
                    
                    if (data.tier === 'pro') {
                        statusBox.className = 'license-status-box pro';
                        statusBox.innerHTML = '<span style="color: #ffd700;">‚≠ê</span> <strong>Pro License Active</strong>';
                        if (proBadge) proBadge.style.display = 'inline-block';
                        enableProSections(true);
                    } else if (data.tier === 'trial') {
                        statusBox.className = 'license-status-box trial';
                        statusBox.innerHTML = `<strong>Pro Trial</strong> - ${data.trial_days_remaining} days remaining<br>
                            <button class="btn btn-sm" style="margin-top: 0.5rem;" onclick="window.open('https://lightwave43.gumroad.com/l/rmtmrr', '_blank')">Buy Pro - $10</button>`;
                        enableProSections(true);
                    } else {
                        statusBox.className = 'license-status-box free';
                        statusBox.innerHTML = `<strong>Free Tier</strong><br>
                            <button class="btn btn-sm" style="margin-top: 0.5rem;" onclick="activateTrial()">Start 14-Day Trial</button>
                            <button class="btn btn-sm" style="margin-top: 0.5rem; margin-left: 0.5rem;" onclick="activateLicenseKey()">Enter License Key</button>
                            <div id="backup-license-check" style="margin-top: 0.5rem;"></div>`;
                        enableProSections(false);
                        
                        // Check for backup license in library folders
                        checkBackupLicense();
                    }
                    
                    // Update max downloads input limit based on tier
                    applyMaxDownloadsLimit();
                    
                    // Load saved pro settings into form
                    loadProFormValues();
                });
        }
        
        function checkBackupLicense() {
            fetch('/api/license/check_backup')
                .then(r => r.json())
                .then(data => {
                    const container = document.getElementById('backup-license-check');
                    if (!container) return;
                    
                    if (data.found) {
                        container.innerHTML = `
                            <div style="background: rgba(0,164,220,0.1); padding: 0.5rem; border-radius: var(--radius); margin-top: 0.5rem;">
                                <span style="color: var(--jf-primary);">üîç Found backup license in library</span><br>
                                <button class="btn btn-primary btn-sm" style="margin-top: 0.5rem;" onclick="restoreBackupLicense()">
                                    üîÑ Restore License
                                </button>
                            </div>`;
                    }
                });
        }
        
        function restoreBackupLicense() {
            fetch('/api/license/restore', { method: 'POST' })
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        showToast('‚úÖ License restored from backup!', 'success');
                        loadLicenseStatus();
                        updateLicenseBanner();
                    } else {
                        showToast('‚ùå Could not restore license: ' + (data.error || 'Unknown error'), 'error');
                    }
                })
                .catch(() => showToast('Failed to restore license', 'error'));
        }
        
        // Hidden purge function - accessible via console, Ctrl+Shift+Alt+P, or clicking PRO badge 5 times
        function purgeAllLicenses() {
            if (!confirm('‚ö†Ô∏è NUCLEAR OPTION ‚ö†Ô∏è\n\nThis will remove ALL licenses including backups.\n\nAre you sure?')) {
                return;
            }
            if (!confirm('FINAL WARNING: This cannot be undone.\n\nType "yes" in the next prompt to confirm.')) {
                return;
            }
            const finalConfirm = prompt('Type "PURGE" to confirm:');
            if (finalConfirm !== 'PURGE') {
                showToast('Purge cancelled', 'warning');
                return;
            }
            
            fetch('/api/license/purge_all', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ confirm: 'PURGE_ALL_LICENSES_CONFIRM' })
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    showToast(`‚ò¢Ô∏è ${data.message}`, 'success');
                    loadLicenseStatus();
                    updateLicenseBanner();
                } else {
                    showToast('Purge failed: ' + data.error, 'error');
                }
            })
            .catch(() => showToast('Purge request failed', 'error'));
        }
        
        // Secret keyboard shortcut: Ctrl+Shift+Alt+P
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.shiftKey && e.altKey && e.key === 'P') {
                e.preventDefault();
                purgeAllLicenses();
            }
        });
        
        function enableProSections(enabled) {
            const sections = ['notifications-section', 'transcode-section', 'schedule-section', 'arr-section', 'themes-section', 'multi-local-section'];
            sections.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.classList.toggle('disabled', !enabled);
                    if (!enabled) {
                        el.classList.add('pro-lock-overlay');
                    } else {
                        el.classList.remove('pro-lock-overlay');
                    }
                }
            });
        }
        
        function loadProFormValues() {
            // Load current config values into pro settings form
            if (!config) return;
            
            // Notifications
            const notifyUrls = config.notification_urls || [];
            document.getElementById('notification-urls').value = notifyUrls.join('\n');
            document.getElementById('notify-complete').checked = config.notify_on_complete !== false;
            document.getElementById('notify-error').checked = config.notify_on_error !== false;
            
            // Transcoding (disabled - just preserve values in hidden inputs)
            const transcodeEnabled = document.getElementById('transcode-enabled');
            const transcodeEncoder = document.getElementById('transcode-encoder');
            const transcodePreset = document.getElementById('transcode-preset');
            const transcodeCustom = document.getElementById('transcode-custom');
            if (transcodeEnabled) transcodeEnabled.value = 'false'; // Always disabled
            if (transcodeEncoder) transcodeEncoder.value = config.transcode_encoder || 'software';
            if (transcodePreset) transcodePreset.value = 'original'; // Always original
            if (transcodeCustom) transcodeCustom.value = config.transcode_custom_args || '';
            
            // Scheduling
            document.getElementById('schedule-enabled').checked = config.download_schedule_enabled || false;
            document.getElementById('schedule-start').value = config.download_schedule_start || '02:00';
            document.getElementById('schedule-end').value = config.download_schedule_end || '06:00';
            document.getElementById('bandwidth-schedule-enabled').checked = config.bandwidth_schedule_enabled || false;
            document.getElementById('bandwidth-day').value = config.bandwidth_day_limit_kbs || 1000;
            document.getElementById('bandwidth-night').value = config.bandwidth_night_limit_kbs || 0;
            
            // *arr
            document.getElementById('sonarr-url').value = config.sonarr_url || '';
            document.getElementById('sonarr-key').value = config.sonarr_api_key || '';
            document.getElementById('radarr-url').value = config.radarr_url || '';
            document.getElementById('radarr-key').value = config.radarr_api_key || '';
            document.getElementById('arr-auto-import').checked = config.arr_auto_import !== false;
            
            // Load path mappings
            arrPathMappings = config.arr_path_mappings || [];
            // Migrate old single mapping if present
            if (arrPathMappings.length === 0 && config.arr_path_mapping_from && config.arr_path_mapping_to) {
                arrPathMappings = [{ remotePath: config.arr_path_mapping_from, localPath: config.arr_path_mapping_to }];
            }
            renderPathMappings();
            updatePathMappingsStatus();
            
            // Theme
            if (config.custom_theme) {
                document.getElementById('custom-theme-select').value = config.custom_theme;
                if (config.custom_theme === 'custom') {
                    document.getElementById('custom-colors-group').style.display = 'block';
                    document.getElementById('theme-primary').value = config.theme_primary || '#00a4dc';
                    document.getElementById('theme-accent').value = config.theme_accent || '#aa5cc3';
                    document.getElementById('theme-bg').value = config.theme_bg || '#101010';
                    document.getElementById('theme-card').value = config.theme_card || '#1a1a1a';
                    document.getElementById('theme-input').value = config.theme_input || '#2a2a2a';
                    document.getElementById('theme-border').value = config.theme_border || '#333333';
                    // Apply custom theme on load
                    applyCustomTheme();
                } else if (config.custom_theme !== 'default') {
                    applyThemePreset(config.custom_theme);
                }
            }
        }
        
        // --- Save Security Settings ---
        document.addEventListener('DOMContentLoaded', () => {
            setupSettingsToggles();
            
            const saveSecurityBtn = document.getElementById('save-security-btn');
            if (saveSecurityBtn) {
                saveSecurityBtn.addEventListener('click', () => {
                    config.auth_enabled = document.getElementById('auth-enabled').checked;
                    config.session_timeout_minutes = parseInt(document.getElementById('session-timeout').value) || 30;
                    config.trust_proxy_headers = document.getElementById('trust-proxy').checked;
                    config.trusted_proxy_ips = document.getElementById('trusted-proxies').value;
                    
                    api('config', 'POST', config)
                        .then(() => showToast('Security settings saved!', 'success'))
                        .catch(() => showToast('Failed to save settings', 'error'));
                });
            }
            
            const saveProBtn = document.getElementById('save-pro-btn');
            if (saveProBtn) {
                saveProBtn.addEventListener('click', saveProSettings);
            }
            
            // Theme selector toggle
            const themeSelect = document.getElementById('custom-theme-select');
            if (themeSelect) {
                themeSelect.addEventListener('change', () => {
                    document.getElementById('custom-colors-group').style.display = 
                        themeSelect.value === 'custom' ? 'block' : 'none';
                    if (themeSelect.value !== 'custom') {
                        applyThemePreset(themeSelect.value);
                    }
                });
            }
        });
        
        function saveProSettings() {
            // Notifications
            const urlText = document.getElementById('notification-urls').value;
            config.notification_urls = urlText.split('\n').map(u => u.trim()).filter(u => u);
            config.notify_on_complete = document.getElementById('notify-complete').checked;
            config.notify_on_error = document.getElementById('notify-error').checked;
            
            // Transcoding
            config.transcode_enabled = document.getElementById('transcode-enabled-test').checked;
            config.transcode_encoder = document.getElementById('transcode-encoder-test').value;
            config.transcode_preset = document.getElementById('transcode-preset-test').value;
            config.max_concurrent_transcodes = parseInt(document.getElementById('max-transcodes').value) || 1;
            config.transcode_skip_larger = document.getElementById('transcode-skip-larger').checked;
            config.transcode_cache_enabled = document.getElementById('transcode-cache-enabled').checked;
            config.transcode_cache_path = document.getElementById('transcode-cache-path').value || '/tmp/transcode_cache';
            config.transcode_custom_args = '';
            
            // Scheduling
            config.download_schedule_enabled = document.getElementById('schedule-enabled').checked;
            config.download_schedule_start = document.getElementById('schedule-start').value;
            config.download_schedule_end = document.getElementById('schedule-end').value;
            config.bandwidth_schedule_enabled = document.getElementById('bandwidth-schedule-enabled').checked;
            config.bandwidth_day_limit_kbs = parseInt(document.getElementById('bandwidth-day').value) || 1000;
            config.bandwidth_night_limit_kbs = parseInt(document.getElementById('bandwidth-night').value) || 0;
            
            // *arr
            config.sonarr_url = document.getElementById('sonarr-url').value;
            config.sonarr_api_key = document.getElementById('sonarr-key').value;
            config.radarr_url = document.getElementById('radarr-url').value;
            config.radarr_api_key = document.getElementById('radarr-key').value;
            config.arr_auto_import = document.getElementById('arr-auto-import').checked;
            // Only save non-empty mappings
            config.arr_path_mappings = arrPathMappings.filter(m => m.remotePath || m.localPath);
            
            // Theme
            config.custom_theme = document.getElementById('custom-theme-select').value;
            config.theme_primary = document.getElementById('theme-primary').value;
            config.theme_accent = document.getElementById('theme-accent').value;
            config.theme_bg = document.getElementById('theme-bg').value;
            config.theme_card = document.getElementById('theme-card').value;
            config.theme_input = document.getElementById('theme-input').value;
            config.theme_border = document.getElementById('theme-border').value;
            
            api('config', 'POST', config)
                .then(() => showToast('Pro settings saved!', 'success'))
                .catch(() => showToast('Failed to save settings', 'error'));
        }
        
        // Color utility function
        function adjustColor(hex, amount) {
            let color = hex.replace('#', '');
            if (color.length === 3) color = color[0]+color[0]+color[1]+color[1]+color[2]+color[2];
            const num = parseInt(color, 16);
            const r = Math.min(255, Math.max(0, (num >> 16) + amount));
            const g = Math.min(255, Math.max(0, ((num >> 8) & 0x00FF) + amount));
            const b = Math.min(255, Math.max(0, (num & 0x0000FF) + amount));
            return '#' + (0x1000000 + (r << 16) + (g << 8) + b).toString(16).slice(1);
        }
        
        // Theme factory - generates full theme from minimal config
        function createTheme(primary, accent, bg, special = null) {
            const bgCard = adjustColor(bg, 16);
            const bgInput = adjustColor(bg, 32);
            const border = adjustColor(bg, 48);
            // Parse primary for header bg
            const p = primary.slice(1);
            const r = parseInt(p.slice(0,2), 16);
            const g = parseInt(p.slice(2,4), 16);
            const b = parseInt(p.slice(4,6), 16);
            return {
                primary, accent, bg, bgCard, bgInput, border,
                text: '#ffffff',
                textMuted: '#888888',
                headerBg: `rgba(${r},${g},${b},0.15)`,
                gradient: `linear-gradient(135deg, ${primary} 0%, ${accent} 100%)`,
                special
            };
        }
        
        const THEME_PRESETS = {
            // Standard Themes
            default: createTheme('#00a4dc', '#aa5cc3', '#101010'),
            jellyfin: createTheme('#00a4dc', '#aa5cc3', '#101010'),
            plex: createTheme('#e5a00d', '#cc7b19', '#1f2326'),
            emby: createTheme('#52b54b', '#4caf50', '#202020'),
            // Seasonal Themes
            winter: createTheme('#5b9bd5', '#a8d5e5', '#0a1929', 'winter'),
            spring: createTheme('#e91e8c', '#8bc34a', '#1a0f15', 'spring'),
            summer: createTheme('#ff9800', '#03a9f4', '#1a1205', 'summer'),
            fall: createTheme('#e65100', '#8d6e63', '#1a0f05', 'fall'),
            // Holiday Themes
            christmas: createTheme('#c41e3a', '#228b22', '#0d1a0d', 'christmas'),
            halloween: createTheme('#ff6f00', '#7b1fa2', '#0d0d0d', 'halloween'),
            valentines: createTheme('#e91e63', '#f48fb1', '#1a0a10', 'valentines'),
            stpatricks: createTheme('#2e7d32', '#ffd700', '#0a1a0a', 'stpatricks'),
            july4th: createTheme('#b71c1c', '#1565c0', '#0a0a1a', 'july4th')
        };
        
        function applyThemePreset(preset) {
            applyThemePresetSilent(preset);
            showToast(`Applied ${preset} theme`, 'success');
        }
        
        function applyThemePresetSilent(preset) {
            const theme = THEME_PRESETS[preset] || THEME_PRESETS.default;
            const root = document.documentElement;
            
            // Apply all color variables
            root.style.setProperty('--jf-primary', theme.primary);
            root.style.setProperty('--jf-primary-dark', adjustColor(theme.primary, -20));
            root.style.setProperty('--jf-primary-light', adjustColor(theme.primary, 20));
            root.style.setProperty('--jf-purple', theme.accent);
            root.style.setProperty('--jf-bg-dark', theme.bg);
            root.style.setProperty('--jf-bg-card', theme.bgCard);
            root.style.setProperty('--jf-bg-card-hover', adjustColor(theme.bgCard, 10));
            root.style.setProperty('--jf-bg-input', theme.bgInput);
            root.style.setProperty('--jf-border', theme.border);
            root.style.setProperty('--jf-text', theme.text);
            root.style.setProperty('--jf-text-muted', theme.textMuted);
            root.style.setProperty('--jf-header-bg', theme.headerBg);
            root.style.setProperty('--jf-gradient', theme.gradient);
            
            // Handle special theme effects
            removeSpecialEffects();
            if (theme.special) {
                applySpecialEffects(theme.special);
            }
        }
        
        function removeSpecialEffects() {
            // Remove any special theme effects
            const existing = document.getElementById('theme-effects');
            if (existing) existing.remove();
            // Remove all theme classes
            document.body.classList.remove('christmas-theme', 'winter-theme', 'halloween-theme', 
                'valentines-theme', 'spring-theme', 'summer-theme', 'fall-theme', 
                'stpatricks-theme', 'july4th-theme');
        }
        
        // Theme effects configuration - data-driven for smaller code
        const THEME_EFFECTS = {
            christmas: { decor: ['tree tree-1:üéÑ','tree tree-2:üéÑ','tree tree-3:üéÑ','tree tree-4:üéÑ'], fall: 'snowflake', fallItems: '‚ùÑ‚ùÖ‚ùÜ‚ùÑ‚ùÖ‚ùÜ‚ùÑ‚ùÖ' },
            winter: { decor: ['snowman snowman-1:‚õÑ','snowman snowman-2:‚òÉÔ∏è','snowman snowman-3:‚õÑ'], fall: 'snowflake', fallItems: '‚ùÑ‚ùÖ‚ùÜ‚ùÑ‚ùÖ‚ùÜ‚ùÑ‚ùÖ‚ùÑ‚ùÖ' },
            halloween: { decor: ['pumpkin pumpkin-1:üéÉ','pumpkin pumpkin-2:üéÉ','ghost ghost-1:üëª','ghost ghost-2:üëª','bat bat-1:ü¶á','bat bat-2:ü¶á','bat bat-3:ü¶á'] },
            valentines: { fall: 'heart', fallItems: 'üíï‚ù§Ô∏èüíóüíñüíï‚ù§Ô∏èüíóüíñ' },
            spring: { decor: ['flower flower-1:üå∏','flower flower-2:üå∑','flower flower-3:üå∫'], fall: 'petal', fallItems: 'üå∏üåºüå∏üåºüå∏üåº' },
            summer: { decor: ['sun:‚òÄÔ∏è','palm palm-1:üå¥','palm palm-2:üå¥','wave wave-1:üåä'] },
            fall: { decor: ['fall-tree fall-tree-1:üçÇ','fall-tree fall-tree-2:üçÅ'], fall: 'leaf', fallItems: 'üçÇüçÅüçÉüçÇüçÅüçÉüçÇüçÅ' },
            stpatricks: { decor: ['clover clover-1:‚òòÔ∏è','clover clover-2:üçÄ','clover clover-3:‚òòÔ∏è','pot-gold:üåà'], fall: 'clover-fall', fallItems: '‚òòÔ∏èüçÄ‚òòÔ∏èüçÄ‚òòÔ∏èüçÄ' },
            july4th: { decor: ['firework firework-1:üéÜ','firework firework-2:üéá','firework firework-3:‚ú®','flag:üá∫üá∏'], fall: 'star', fallItems: '‚≠ê‚ú®‚≠ê‚ú®‚≠ê‚ú®' }
        };
        
        function applySpecialEffects(effectType) {
            document.body.classList.add(`${effectType}-theme`);
            const container = document.createElement('div');
            container.id = 'theme-effects';
            
            const effect = THEME_EFFECTS[effectType];
            if (!effect) return;
            
            let html = '';
            // Add decorations
            if (effect.decor) {
                effect.decor.forEach(d => {
                    const [classes, emoji] = d.split(':');
                    html += `<div class="theme-decor ${classes}">${emoji}</div>`;
                });
            }
            // Add falling items
            if (effect.fall && effect.fallItems) {
                html += '<div class="falling-items">';
                [...effect.fallItems].forEach(emoji => {
                    html += `<div class="fall-item ${effect.fall}">${emoji}</div>`;
                });
                html += '</div>';
            }
            
            container.innerHTML = html;
            document.body.appendChild(container);
        }
        
        function applyCustomTheme() {
            const primary = document.getElementById('theme-primary').value;
            const accent = document.getElementById('theme-accent').value;
            const root = document.documentElement;
            
            root.style.setProperty('--jf-primary', primary);
            root.style.setProperty('--jf-primary-dark', adjustColor(primary, -20));
            root.style.setProperty('--jf-primary-light', adjustColor(primary, 20));
            root.style.setProperty('--jf-purple', accent);
            root.style.setProperty('--jf-gradient', `linear-gradient(135deg, ${primary} 0%, ${accent} 100%)`);
            
            // Apply background colors
            const bg = document.getElementById('theme-bg').value;
            const card = document.getElementById('theme-card').value;
            const input = document.getElementById('theme-input').value;
            const border = document.getElementById('theme-border').value;
            
            root.style.setProperty('--jf-bg-dark', bg);
            root.style.setProperty('--jf-bg-card', card);
            root.style.setProperty('--jf-bg-card-hover', adjustColor(card, 10));
            root.style.setProperty('--jf-bg-input', input);
            root.style.setProperty('--jf-border', border);
            
            // Convert primary to rgba for header background
            const r = parseInt(primary.slice(1,3), 16);
            const g = parseInt(primary.slice(3,5), 16);
            const b = parseInt(primary.slice(5,7), 16);
            root.style.setProperty('--jf-header-bg', `rgba(${r},${g},${b},0.15)`);
            
            // Remove special effects for custom theme
            removeSpecialEffects();
            
            showToast('Custom theme applied!', 'success');
        }
        
        function testArrConnection(type) {
            const url = document.getElementById(`${type}-url`).value;
            const key = document.getElementById(`${type}-key`).value;
            
            fetch('/api/test_arr', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ type, url, api_key: key })
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    showToast(`‚úì Connected to ${data.name} v${data.version}`, 'success');
                    // Refresh cache after successful connection
                    refreshArrCache();
                } else {
                    showToast(`‚úó ${type}: ${data.error}`, 'error');
                }
            })
            .catch(() => showToast(`Failed to test ${type}`, 'error'));
        }
        
        function refreshArrCache() {
            const statusEl = document.getElementById('arr-cache-status');
            if (statusEl) statusEl.textContent = 'Refreshing...';
            
            fetch('/api/refresh_arr_cache', { method: 'POST' })
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        showToast('*arr cache refresh started', 'success');
                        // Update status after a delay
                        setTimeout(loadArrCacheStatus, 2000);
                    } else {
                        showToast(data.error || 'Failed to refresh cache', 'error');
                    }
                })
                .catch(() => showToast('Failed to refresh cache', 'error'));
        }
        
        function loadArrCacheStatus() {
            fetch('/api/arr_cache_status')
                .then(r => r.json())
                .then(data => {
                    const statusEl = document.getElementById('arr-cache-status');
                    if (statusEl) {
                        const parts = [];
                        if (data.sonarr_series_count > 0) {
                            parts.push(`${data.sonarr_series_count} series (Sonarr)`);
                        }
                        if (data.radarr_movies_count > 0) {
                            parts.push(`${data.radarr_movies_count} movies (Radarr)`);
                        }
                        if (parts.length > 0) {
                            statusEl.textContent = `Cached: ${parts.join(', ')}`;
                            if (data.last_refresh) {
                                statusEl.textContent += ` ‚Ä¢ Last: ${data.last_refresh}`;
                            }
                        } else {
                            statusEl.textContent = 'No cached data. Click Refresh after configuring *arr connections.';
                        }
                    }
                })
                .catch(() => {
                    const statusEl = document.getElementById('arr-cache-status');
                    if (statusEl) statusEl.textContent = 'Could not load cache status';
                });
        }
        
        // --- Path Mappings ---
        let arrPathMappings = [];
        
        function renderPathMappings() {
            const container = document.getElementById('arr-path-mappings');
            if (!container) return;
            
            if (arrPathMappings.length === 0) {
                container.innerHTML = '';
                return;
            }
            
            container.innerHTML = arrPathMappings.map((mapping, index) => {
                const accessible = mapping.accessible !== false; // Default to true for manual mappings
                const accessIcon = mapping.source ? (accessible ? '‚úÖ' : '‚ö†Ô∏è') : '';
                const borderColor = mapping.source ? (accessible ? 'var(--jf-success)' : 'var(--jf-warning)') : 'var(--jf-border)';
                
                return `
                <div class="path-mapping-row" style="border-color: ${borderColor};">
                    ${mapping.source ? `<span class="path-mapping-source">${mapping.source}</span>` : ''}
                    <div style="flex: 2; display: flex; flex-direction: column; gap: 0.25rem;">
                        <div class="path-mapping-label">${accessIcon} JellyLooter Path (where you download to)</div>
                        <input type="text" class="form-input" placeholder="/storage/data/media/tv" value="${escapeHtml(mapping.remotePath || '')}"
                            onchange="updatePathMapping(${index}, 'remotePath', this.value)">
                    </div>
                    <span class="mapping-arrow">‚Üí</span>
                    <div style="flex: 2; display: flex; flex-direction: column; gap: 0.25rem;">
                        <div class="path-mapping-label">*arr Path (what Sonarr/Radarr sees)</div>
                        <input type="text" class="form-input" placeholder="/tv" value="${escapeHtml(mapping.localPath || '')}"
                            onchange="updatePathMapping(${index}, 'localPath', this.value)" ${mapping.source ? 'readonly' : ''}>
                    </div>
                    <button class="btn btn-danger btn-remove" onclick="removePathMapping(${index})" title="Remove">‚úï</button>
                </div>
            `}).join('');
        }
        
        function addPathMapping() {
            arrPathMappings.push({ remotePath: '', localPath: '', source: '' });
            renderPathMappings();
        }
        
        function removePathMapping(index) {
            arrPathMappings.splice(index, 1);
            renderPathMappings();
            updatePathMappingsStatus();
        }
        
        function updatePathMapping(index, field, value) {
            if (arrPathMappings[index]) {
                arrPathMappings[index][field] = value;
            }
        }
        
        function updatePathMappingsStatus() {
            const statusEl = document.getElementById('arr-path-mappings-status');
            if (!statusEl) return;
            
            if (arrPathMappings.length === 0) {
                statusEl.innerHTML = 'No mappings configured. Click "Fetch Root Folders" to auto-load from *arr.';
            } else {
                const fromSonarr = arrPathMappings.filter(m => m.source === 'Sonarr').length;
                const fromRadarr = arrPathMappings.filter(m => m.source === 'Radarr').length;
                const fromBoth = arrPathMappings.filter(m => m.source === 'Both').length;
                const manual = arrPathMappings.filter(m => !m.source).length;
                const accessible = arrPathMappings.filter(m => m.accessible !== false).length;
                
                const parts = [];
                if (fromSonarr) parts.push(`${fromSonarr} Sonarr`);
                if (fromRadarr) parts.push(`${fromRadarr} Radarr`);
                if (fromBoth) parts.push(`${fromBoth} shared`);
                if (manual) parts.push(`${manual} manual`);
                
                const accessStatus = accessible === arrPathMappings.length 
                    ? '‚úÖ All paths accessible' 
                    : `‚ö†Ô∏è ${accessible}/${arrPathMappings.length} paths accessible`;
                
                statusEl.innerHTML = `<span style="color: var(--jf-success);">${arrPathMappings.length} folder(s): ${parts.join(', ')}</span> ‚Ä¢ ${accessStatus}`;
            }
        }
        
        async function fetchArrPathMappings() {
            const statusEl = document.getElementById('arr-path-mappings-status');
            if (statusEl) statusEl.innerHTML = '<span style="color: var(--jf-primary);">‚è≥ Fetching root folders and building mappings...</span>';
            
            try {
                const result = await api('fetch_arr_path_mappings', 'POST');
                
                if (result.success) {
                    const fetched = result.mappings || [];
                    
                    if (fetched.length === 0) {
                        if (statusEl) statusEl.innerHTML = '<span style="color: var(--jf-warning);">‚ö†Ô∏è No root folders found in *arr. Check your *arr configuration.</span>';
                    } else {
                        // Keep existing manual mappings, replace fetched ones
                        const manualMappings = arrPathMappings.filter(m => !m.source);
                        arrPathMappings = [...fetched, ...manualMappings];
                        renderPathMappings();
                        updatePathMappingsStatus();
                        
                        // Show accessibility info
                        const accessible = result.accessible_count || 0;
                        const base = result.jellylooter_base || 'not detected';
                        if (accessible === fetched.length) {
                            showToast(`‚úÖ Loaded ${fetched.length} folder(s) - all paths accessible!`, 'success');
                        } else if (accessible > 0) {
                            showToast(`Loaded ${fetched.length} folder(s), ${accessible} accessible. Check paths marked ‚ö†Ô∏è`, 'warning', 5000);
                        } else {
                            showToast(`Loaded ${fetched.length} folder(s). Paths may need editing - JellyLooter base: ${base}`, 'info', 5000);
                        }
                    }
                } else {
                    if (statusEl) statusEl.innerHTML = `<span style="color: var(--jf-danger);">‚ùå ${result.error || 'Failed to fetch'}</span>`;
                    showToast(result.error || 'Failed to fetch root folders', 'error');
                }
            } catch (e) {
                if (statusEl) statusEl.innerHTML = '<span style="color: var(--jf-danger);">‚ùå Error fetching. Check API keys.</span>';
                showToast('Failed to fetch root folders', 'error');
            }
        }
        
        // --- Stop After Current ---
        function stopAfterCurrent() {
            fetch('/api/stop_after_current', { method: 'POST' })
                .then(r => r.json())
                .then(() => showToast('Will stop after current downloads complete', 'success'));
        }
        
        // --- Collapsible Panels ---
        function togglePanelCollapse(panel) {
            panel.classList.toggle('collapsed');
            savePanelLayout();
        }
        
        function savePanelLayout() {
            const rightColumn = document.getElementById('right-column');
            if (!rightColumn) return;
            
            const panels = rightColumn.querySelectorAll('.panel[data-panel-id]');
            const layout = {
                order: Array.from(panels).map(p => p.dataset.panelId),
                collapsed: Array.from(panels).filter(p => p.classList.contains('collapsed')).map(p => p.dataset.panelId)
            };
            
            // Save to config
            config.panel_layout = layout;
            api('config', 'POST', config).catch(() => {});
        }
        
        function loadPanelLayout() {
            if (!config.panel_layout) return;
            
            const rightColumn = document.getElementById('right-column');
            if (!rightColumn) return;
            
            const layout = config.panel_layout;
            
            // Restore collapsed state
            if (layout.collapsed) {
                layout.collapsed.forEach(id => {
                    const panel = document.querySelector(`.panel[data-panel-id="${id}"]`);
                    if (panel) panel.classList.add('collapsed');
                });
            }
            
            // Restore order (Pro only)
            if (layout.order && isProTier()) {
                const panels = {};
                rightColumn.querySelectorAll('.panel[data-panel-id]').forEach(p => {
                    panels[p.dataset.panelId] = p;
                });
                
                layout.order.forEach(id => {
                    if (panels[id]) {
                        rightColumn.appendChild(panels[id]);
                    }
                });
            }
        }
        
        function isProTier() {
            return config.license_tier === 'pro' || config.license_tier === 'trial';
        }
        
        // Initialize panel layout on load
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(loadPanelLayout, 100);
            
            // Show/hide pro controls
            if (!isProTier()) {
                document.querySelectorAll('.pro-only').forEach(el => {
                    el.style.display = 'none';
                });
            }
        });
        
        // --- Local Server Management (Pro) ---
        function loadLocalServers() {
            fetch('/api/local_servers')
                .then(r => r.json())
                .then(data => {
                    const list = document.getElementById('local-servers-list');
                    if (!list) return;
                    
                    if (!data.servers || data.servers.length === 0) {
                        list.innerHTML = '<div class="form-hint">No local servers configured</div>';
                        return;
                    }
                    
                    list.innerHTML = data.servers.map(s => `
                        <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: var(--jf-bg-input); border-radius: var(--radius); margin-bottom: 0.5rem;">
                            <span style="flex: 1;">üè† ${escapeHtml(s.name || 'Local Server')}</span>
                            <span style="font-size: 0.75rem; color: var(--jf-text-muted);">${escapeHtml(s.url)}</span>
                            <button class="btn btn-danger btn-sm" onclick="deleteLocalServer('${s.id}')" title="Remove">üóëÔ∏è</button>
                        </div>
                    `).join('');
                });
        }
        
        function testLocalServerConnection() {
            const url = document.getElementById('new-local-server-url').value.trim();
            const method = document.getElementById('new-local-auth-method').value;
            const resultEl = document.getElementById('new-local-server-test-result');
            
            if (!url) {
                resultEl.innerHTML = '<span style="color: var(--jf-error);">Please enter a URL</span>';
                return;
            }
            
            resultEl.innerHTML = '<span style="color: var(--jf-text-muted);">Testing...</span>';
            
            let payload = { url };
            if (method === 'key') {
                payload.key = document.getElementById('new-local-server-key').value;
            } else {
                payload.username = document.getElementById('new-local-server-username').value;
                payload.password = document.getElementById('new-local-server-password').value;
            }
            
            fetch('/api/test_connection', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            })
            .then(r => r.json())
            .then(data => {
                if (data.status === 'ok') {
                    resultEl.innerHTML = '<span style="color: var(--jf-success);">‚úì Connection successful!</span>';
                    // Store the key/user_id for adding
                    window._localServerKey = data.key;
                    window._localServerUserId = data.user_id;
                } else {
                    resultEl.innerHTML = `<span style="color: var(--jf-error);">‚úó ${data.error || 'Connection failed'}</span>`;
                }
            })
            .catch(() => {
                resultEl.innerHTML = '<span style="color: var(--jf-error);">‚úó Connection error</span>';
            });
        }
        
        function addLocalServer() {
            const name = document.getElementById('new-local-server-name').value.trim() || 'Local Server';
            const url = document.getElementById('new-local-server-url').value.trim();
            const key = window._localServerKey || document.getElementById('new-local-server-key').value;
            const userId = window._localServerUserId;
            
            if (!url) {
                showToast('Please enter a server URL', 'error');
                return;
            }
            
            fetch('/api/local_servers', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, url, key, user_id: userId })
            })
            .then(r => r.json())
            .then(data => {
                if (data.status === 'ok') {
                    showToast('Local server added!', 'success');
                    closeModal('local-server-modal');
                    loadLocalServers();
                    // Clear form
                    document.getElementById('new-local-server-name').value = '';
                    document.getElementById('new-local-server-url').value = '';
                    document.getElementById('new-local-server-key').value = '';
                    window._localServerKey = null;
                    window._localServerUserId = null;
                } else {
                    showToast(data.error || 'Failed to add server', 'error');
                }
            })
            .catch(() => showToast('Failed to add server', 'error'));
        }
        
        function deleteLocalServer(id) {
            if (!confirm('Remove this local server?')) return;
            
            fetch(`/api/local_servers/${id}`, { method: 'DELETE' })
                .then(r => r.json())
                .then(() => {
                    showToast('Local server removed', 'success');
                    loadLocalServers();
                })
                .catch(() => showToast('Failed to remove server', 'error'));
        }
        
        // Load local servers when Pro settings are opened
        document.addEventListener('DOMContentLoaded', () => {
            const proToggle = document.getElementById('pro-toggle');
            if (proToggle) {
                proToggle.addEventListener('click', () => {
                    setTimeout(loadLocalServers, 100);
                    setTimeout(loadArrCacheStatus, 100);
                });
            }
            
            // Local server auth method toggle (multi-local server modal)
            const newLocalAuthMethod = document.getElementById('new-local-auth-method');
            if (newLocalAuthMethod) {
                newLocalAuthMethod.addEventListener('change', (e) => {
                    document.getElementById('new-local-auth-key-fields').style.display = e.target.value === 'key' ? 'block' : 'none';
                    document.getElementById('new-local-auth-creds-fields').style.display = e.target.value === 'creds' ? 'block' : 'none';
                });
            }
        });
        
        // Initialize license banner on load
        document.addEventListener('DOMContentLoaded', initLicenseBanner);
        
        // Transcode Settings Functions
        function toggleTranscodeCachePath() {
            const enabled = document.getElementById('transcode-cache-enabled').checked;
            document.getElementById('transcode-cache-path-group').style.display = enabled ? 'block' : 'none';
        }
        
        async function loadTranscodeStats() {
            try {
                const stats = await api('transcode_stats');
                document.getElementById('transcode-stat-files').textContent = stats.files_transcoded || 0;
                document.getElementById('transcode-stat-skipped').textContent = stats.files_skipped_larger || 0;
                document.getElementById('transcode-stat-saved').textContent = stats.total_space_saved_human || '0 B';
                document.getElementById('transcode-stat-percent').textContent = (stats.percent_saved || 0) + '%';
            } catch (e) {
                console.error('Failed to load transcode stats:', e);
            }
        }
        
        async function resetTranscodeStats() {
            if (!confirm('Reset all transcode statistics?')) return;
            try {
                await api('transcode_stats/reset', 'POST');
                showToast('Transcode stats reset', 'info');
                loadTranscodeStats();
            } catch (e) {
                showToast('Failed to reset stats', 'error');
            }
        }
        
        async function clearTranscodeCache() {
            const cachePath = document.getElementById('transcode-cache-path').value || '/tmp/transcode_cache';
            if (!confirm(`Clear all partial/failed transcode files from:\n${cachePath}\n\nThis cannot be undone.`)) return;
            
            try {
                const result = await api('transcode_cache/clear', 'POST', { path: cachePath });
                if (result.success) {
                    showToast(`Cleared ${result.files_deleted} files (${result.space_freed_human})`, 'success');
                    loadTranscodeCacheStatus();
                } else {
                    showToast(result.error || 'Failed to clear cache', 'error');
                }
            } catch (e) {
                showToast('Failed to clear cache', 'error');
            }
        }
        
        async function loadTranscodeCacheStatus() {
            const statusEl = document.getElementById('transcode-cache-status');
            if (!statusEl) return;
            
            const cachePath = document.getElementById('transcode-cache-path').value || '/tmp/transcode_cache';
            
            try {
                const result = await api('transcode_cache/status', 'POST', { path: cachePath });
                if (result.exists) {
                    if (result.file_count > 0) {
                        statusEl.innerHTML = `<span style="color: var(--jf-warning);">${result.file_count} files (${result.total_size_human})</span>`;
                    } else {
                        statusEl.innerHTML = `<span style="color: var(--jf-success);">Empty</span>`;
                    }
                } else {
                    statusEl.innerHTML = `<span style="color: var(--jf-text-muted);">Not created yet</span>`;
                }
            } catch (e) {
                statusEl.textContent = 'Error';
            }
        }
        
        // Load cache status when cache is enabled
        document.getElementById('transcode-cache-enabled')?.addEventListener('change', (e) => {
            if (e.target.checked) {
                setTimeout(loadTranscodeCacheStatus, 100);
            }
        });
    </script>
    
    <!-- License Banner -->
    <div class="license-banner license-banner-free" id="license-banner" style="display: none;">
        <span class="license-banner-text">üîì Free Version</span>
        <button class="license-banner-btn" onclick="activateLicenseKey()">üîë Enter License Key</button>
        <a href="https://lightwave43.gumroad.com/l/rmtmrr" target="_blank" class="license-banner-btn" style="background: var(--jf-purple); color: white;">‚≠ê Go Pro - $10</a>
    </div>
</body>
</html>
