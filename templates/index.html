<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JellyLooter</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Theme Variables */
        :root {
            --jf-primary: #00a4dc;
            --jf-primary-dark: #0086b3;
            --jf-primary-light: #33b5e5;
            --jf-success: #4caf50;
            --jf-warning: #ff9800;
            --jf-error: #f44336;
            --jf-purple: #aa5cc3;
            --jf-gradient: linear-gradient(135deg, #00a4dc 0%, #aa5cc3 100%);
            --radius: 8px;
            --radius-lg: 12px;
            --shadow: 0 4px 24px rgba(0, 0, 0, 0.4);
            --transition: all 0.2s ease;
        }

        /* Dark Theme (Default) */
        [data-theme="dark"] {
            --jf-bg-dark: #101010;
            --jf-bg-card: #1a1a1a;
            --jf-bg-card-hover: #242424;
            --jf-bg-input: #2a2a2a;
            --jf-text: #ffffff;
            --jf-text-muted: #888888;
            --jf-text-dim: #666666;
            --jf-border: #333333;
            --jf-header-bg: rgba(0,164,220,0.15);
        }

        /* Light Theme */
        [data-theme="light"] {
            --jf-bg-dark: #f5f5f5;
            --jf-bg-card: #ffffff;
            --jf-bg-card-hover: #f0f0f0;
            --jf-bg-input: #e8e8e8;
            --jf-text: #1a1a1a;
            --jf-text-muted: #666666;
            --jf-text-dim: #888888;
            --jf-border: #dddddd;
            --jf-header-bg: rgba(0,164,220,0.1);
            --shadow: 0 4px 24px rgba(0, 0, 0, 0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Quicksand', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--jf-bg-dark);
            color: var(--jf-text);
            min-height: 100vh;
            line-height: 1.5;
            transition: background-color 0.3s, color 0.3s;
        }

        /* Header */
        .header {
            background: linear-gradient(180deg, var(--jf-header-bg) 0%, transparent 100%);
            border-bottom: 1px solid var(--jf-border);
            padding: 1rem 2rem;
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(20px);
        }

        .header-content {
            max-width: 1600px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: var(--jf-gradient);
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }

        .logo-text {
            font-size: 1.5rem;
            font-weight: 700;
            background: var(--jf-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        /* Theme Toggle */
        .theme-toggle {
            width: 40px;
            height: 40px;
            border: 1px solid var(--jf-border);
            background: var(--jf-bg-card);
            border-radius: var(--radius);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.125rem;
            transition: var(--transition);
        }

        .theme-toggle:hover {
            background: var(--jf-bg-card-hover);
            border-color: var(--jf-primary);
        }

        .theme-icon-light, .theme-icon-dark { display: none; }
        [data-theme="dark"] .theme-icon-light { display: block; }
        [data-theme="light"] .theme-icon-dark { display: block; }

        /* User Menu */
        .user-menu {
            position: relative;
        }

        .user-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--jf-bg-card);
            border: 1px solid var(--jf-border);
            border-radius: var(--radius);
            color: var(--jf-text);
            cursor: pointer;
            font-family: inherit;
            font-size: 0.875rem;
            font-weight: 600;
            transition: var(--transition);
        }

        .user-btn:hover {
            background: var(--jf-bg-card-hover);
        }

        .user-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 0.5rem;
            background: var(--jf-bg-card);
            border: 1px solid var(--jf-border);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            min-width: 180px;
            display: none;
            z-index: 1000;
        }

        .user-dropdown.active { display: block; }

        .user-dropdown-item {
            display: block;
            width: 100%;
            padding: 0.75rem 1rem;
            background: none;
            border: none;
            color: var(--jf-text);
            font-family: inherit;
            font-size: 0.875rem;
            text-align: left;
            cursor: pointer;
            transition: var(--transition);
        }

        .user-dropdown-item:hover {
            background: var(--jf-bg-input);
        }

        .user-dropdown-item.danger { color: var(--jf-error); }

        /* Navigation Tabs */
        .nav-tabs {
            display: flex;
            gap: 0.25rem;
            background: var(--jf-bg-card);
            padding: 0.25rem;
            border-radius: var(--radius);
        }

        .nav-tab {
            padding: 0.5rem 1rem;
            border: none;
            background: transparent;
            color: var(--jf-text-muted);
            cursor: pointer;
            border-radius: calc(var(--radius) - 2px);
            font-family: inherit;
            font-size: 0.875rem;
            font-weight: 500;
            transition: var(--transition);
        }

        .nav-tab:hover {
            color: var(--jf-text);
            background: var(--jf-bg-input);
        }

        .nav-tab.active {
            background: var(--jf-primary);
            color: white;
        }

        /* Main Layout */
        .main-container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 1.5rem 2rem;
            display: grid;
            grid-template-columns: 1fr 380px;
            gap: 1.5rem;
        }

        @media (max-width: 1200px) {
            .main-container { grid-template-columns: 1fr; }
        }
        
        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            .header { padding: 0.75rem 1rem; }
            .header-content { flex-wrap: wrap; gap: 0.5rem; }
            .logo-text { font-size: 1.25rem; }
            .header-actions { 
                width: 100%; 
                justify-content: space-between;
                flex-wrap: wrap;
            }
            .nav-tabs { 
                order: 3; 
                width: 100%; 
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            .nav-tab { padding: 0.5rem 0.75rem; font-size: 0.8125rem; }
            
            .main { padding: 0.75rem; }
            .panel-header { padding: 0.75rem 1rem; flex-wrap: wrap; gap: 0.5rem; }
            .panel-body { padding: 0.75rem; }
            
            .browser-grid {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
                gap: 0.5rem;
            }
            
            .browser-item-title { font-size: 0.6875rem; padding: 0.375rem; }
            
            .selection-bar { flex-direction: column; text-align: center; }
            .selection-bar-actions { width: 100%; justify-content: center; }
            
            .pagination-controls { flex-direction: column; text-align: center; }
            .pagination-info { margin-bottom: 0.5rem; flex-wrap: wrap; justify-content: center; }
            
            .sidebar { position: fixed; right: -100%; top: 0; height: 100%; z-index: 1000; transition: right 0.3s; }
            .sidebar.open { right: 0; }
            
            .download-item { flex-direction: column; align-items: flex-start; }
            .download-item-actions { width: 100%; justify-content: flex-end; margin-top: 0.5rem; }
            
            .modal-content { width: 95%; max-width: none; margin: 1rem; }
            .form-input { font-size: 16px; } /* Prevent zoom on iOS */
            
            .btn { padding: 0.625rem 1rem; }
            .btn-sm { padding: 0.5rem 0.75rem; }
        }
        
        @media (max-width: 480px) {
            .browser-grid {
                grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
                gap: 0.375rem;
            }
            .browser-item-title { font-size: 0.625rem; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
        }

        /* Panels */
        .panel {
            background: var(--jf-bg-card);
            border-radius: var(--radius-lg);
            border: 1px solid var(--jf-border);
            overflow: hidden;
        }

        .panel-header {
            padding: 1rem 1.25rem;
            border-bottom: 1px solid var(--jf-border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: linear-gradient(180deg, rgba(255,255,255,0.02) 0%, transparent 100%);
        }

        [data-theme="light"] .panel-header {
            background: linear-gradient(180deg, rgba(0,0,0,0.02) 0%, transparent 100%);
        }

        .panel-title {
            font-size: 1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .panel-title-icon { color: var(--jf-primary); }

        .panel-body { padding: 1.25rem; }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.625rem 1.25rem;
            border: none;
            border-radius: var(--radius);
            font-family: inherit;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            white-space: nowrap;
        }

        .btn-primary {
            background: var(--jf-primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--jf-primary-dark);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: var(--jf-bg-input);
            color: var(--jf-text);
            border: 1px solid var(--jf-border);
        }

        .btn-secondary:hover {
            background: var(--jf-bg-card-hover);
            border-color: var(--jf-text-dim);
        }

        .btn-danger {
            background: var(--jf-error);
            color: white;
        }

        .btn-danger:hover { background: #d32f2f; }

        .btn-success {
            background: var(--jf-success);
            color: white;
        }

        .btn-warning {
            background: var(--jf-warning);
            color: #1a1a1a;
        }

        .btn-sm {
            padding: 0.375rem 0.75rem;
            font-size: 0.8125rem;
        }

        .btn-icon {
            width: 36px;
            height: 36px;
            padding: 0;
            border-radius: var(--radius);
        }

        .btn-icon.btn-sm {
            width: 28px;
            height: 28px;
        }

        /* Form Elements */
        .form-group { margin-bottom: 1rem; }

        .form-label {
            display: block;
            font-size: 0.8125rem;
            font-weight: 600;
            color: var(--jf-text-muted);
            margin-bottom: 0.375rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-input {
            width: 100%;
            padding: 0.75rem 1rem;
            background: var(--jf-bg-input);
            border: 1px solid var(--jf-border);
            border-radius: var(--radius);
            color: var(--jf-text);
            font-family: inherit;
            font-size: 0.9375rem;
            transition: var(--transition);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--jf-primary);
            box-shadow: 0 0 0 3px rgba(0, 164, 220, 0.15);
        }

        .form-input::placeholder { color: var(--jf-text-dim); }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .form-hint {
            font-size: 0.75rem;
            color: var(--jf-text-muted);
            margin-top: 0.375rem;
        }

        /* Toggle Switch */
        .toggle-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 0;
        }

        .toggle-label { font-size: 0.9375rem; }

        .toggle {
            position: relative;
            width: 48px;
            height: 26px;
        }

        .toggle input { opacity: 0; width: 0; height: 0; }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            inset: 0;
            background: var(--jf-bg-input);
            border-radius: 26px;
            transition: var(--transition);
            border: 1px solid var(--jf-border);
        }

        .toggle-slider::before {
            content: '';
            position: absolute;
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background: var(--jf-text-muted);
            border-radius: 50%;
            transition: var(--transition);
        }

        .toggle input:checked + .toggle-slider {
            background: var(--jf-primary);
            border-color: var(--jf-primary);
        }

        .toggle input:checked + .toggle-slider::before {
            transform: translateX(22px);
            background: white;
        }

        /* Server List */
        .server-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .server-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.875rem 1rem;
            background: var(--jf-bg-input);
            border-radius: var(--radius);
            cursor: pointer;
            transition: var(--transition);
            border: 1px solid transparent;
        }

        .server-item:hover {
            background: var(--jf-bg-card-hover);
            border-color: var(--jf-border);
        }

        .server-item.active {
            border-color: var(--jf-primary);
            background: rgba(0, 164, 220, 0.1);
        }

        .server-icon {
            width: 40px;
            height: 40px;
            background: var(--jf-gradient);
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.125rem;
            flex-shrink: 0;
        }

        .server-info {
            flex: 1;
            min-width: 0;
        }

        .server-name {
            font-weight: 600;
            font-size: 0.9375rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .server-url {
            font-size: 0.8125rem;
            color: var(--jf-text-muted);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Browser Grid */
        .browser-container {
            display: flex;
            flex-direction: column;
            height: 500px;
        }

        .browser-path {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1rem;
            background: var(--jf-bg-input);
            border-radius: var(--radius);
            margin-bottom: 1rem;
            font-size: 0.875rem;
            color: var(--jf-text-muted);
            overflow-x: auto;
        }

        .browser-path-item {
            color: var(--jf-primary);
            cursor: pointer;
            white-space: nowrap;
        }

        .browser-path-item:hover { text-decoration: underline; }

        .browser-grid {
            flex: 1;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 1rem;
            overflow-y: auto;
            padding: 0.25rem;
        }

        .pagination-controls {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 0;
            border-top: 1px solid var(--jf-border);
            margin-top: 1rem;
            flex-wrap: wrap;
            gap: 0.75rem;
        }

        .pagination-info {
            display: flex;
            align-items: center;
            color: var(--jf-text-muted);
            font-size: 0.875rem;
        }

        .pagination-buttons {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .pagination-buttons .btn {
            min-width: 36px;
        }

        .page-number {
            padding: 0.375rem 0.75rem;
            background: var(--jf-bg-input);
            border: 1px solid var(--jf-border);
            border-radius: var(--radius);
            color: var(--jf-text);
            cursor: pointer;
            font-size: 0.875rem;
            margin: 0 0.125rem;
        }

        .page-number:hover {
            background: var(--jf-bg-card-hover);
        }

        .page-number.active {
            background: var(--jf-primary);
            border-color: var(--jf-primary);
            color: white;
        }

        .browser-item {
            position: relative;
            aspect-ratio: 2/3;
            background: var(--jf-bg-input);
            border-radius: var(--radius);
            overflow: hidden;
            cursor: pointer;
            transition: var(--transition);
            border: 2px solid transparent;
        }

        .browser-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .browser-item.selected { border-color: var(--jf-primary); }

        .browser-item.exists { opacity: 0.5; }

        .browser-item.exists::after {
            content: '‚úì';
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            width: 24px;
            height: 24px;
            background: var(--jf-success);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: bold;
            color: white;
        }

        .browser-item-poster {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .browser-item-placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            color: var(--jf-text-dim);
            background: linear-gradient(135deg, var(--jf-bg-card) 0%, var(--jf-bg-input) 100%);
        }

        .browser-item-title {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 2rem 0.5rem 0.5rem;
            background: linear-gradient(transparent, rgba(0,0,0,0.9));
            font-size: 0.75rem;
            font-weight: 600;
            line-height: 1.3;
            text-align: center;
            color: white;
        }

        .browser-item.folder .browser-item-placeholder {
            background: linear-gradient(135deg, rgba(0,164,220,0.2) 0%, rgba(170,92,195,0.2) 100%);
        }

        /* Download Queue */
        .queue-container {
            max-height: 400px;
            overflow-y: auto;
        }

        .queue-empty {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--jf-text-muted);
        }

        .queue-empty-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .download-item {
            padding: 1rem;
            background: var(--jf-bg-input);
            border-radius: var(--radius);
            margin-bottom: 0.5rem;
        }

        .download-item:last-child { margin-bottom: 0; }

        .download-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .download-name {
            font-size: 0.875rem;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex: 1;
            margin-right: 0.5rem;
        }

        .download-status {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            background: var(--jf-primary);
            color: white;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .download-status.paused {
            background: var(--jf-warning);
            color: #1a1a1a;
        }

        .download-status.pending {
            background: var(--jf-text-dim);
        }

        .download-progress {
            height: 6px;
            background: var(--jf-border);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 0.5rem;
        }

        .download-progress-bar {
            height: 100%;
            background: var(--jf-gradient);
            transition: width 0.3s;
        }

        .download-meta {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            color: var(--jf-text-muted);
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .stat-card {
            background: var(--jf-bg-card);
            border: 1px solid var(--jf-border);
            border-radius: var(--radius);
            padding: 1rem;
            text-align: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--jf-primary);
        }

        .stat-label {
            font-size: 0.75rem;
            color: var(--jf-text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Control Bar */
        .control-bar {
            display: flex;
            gap: 0.5rem;
            padding-top: 1rem;
            border-top: 1px solid var(--jf-border);
            margin-top: 1rem;
        }

        /* Log Container */
        .log-container {
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 0.8125rem;
            background: var(--jf-bg-input);
            border-radius: var(--radius);
            padding: 1rem;
            max-height: 300px;
            overflow-y: auto;
            line-height: 1.6;
        }

        .log-line { padding: 0.125rem 0; }
        .log-line .success { color: var(--jf-success); }
        .log-line .error { color: var(--jf-error); }

        /* Modal */
        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 2rem;
        }

        .modal.active { display: flex; }

        .modal-content {
            background: var(--jf-bg-card);
            border-radius: var(--radius-lg);
            border: 1px solid var(--jf-border);
            width: 100%;
            max-width: 480px;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--jf-border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-title {
            font-size: 1.125rem;
            font-weight: 700;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--jf-text-muted);
            cursor: pointer;
            line-height: 1;
        }

        .modal-close:hover { color: var(--jf-text); }

        .modal-body {
            padding: 1.5rem;
            overflow-y: auto;
        }

        .modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--jf-border);
            display: flex;
            gap: 0.75rem;
            justify-content: flex-end;
        }

        /* Advanced Settings Toggle */
        .advanced-toggle {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 0;
            color: var(--jf-text-muted);
            cursor: pointer;
            font-size: 0.875rem;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            font-family: inherit;
        }

        .advanced-toggle:hover { color: var(--jf-text); }

        .advanced-toggle-icon { transition: transform 0.2s; }
        .advanced-toggle.open .advanced-toggle-icon { transform: rotate(180deg); }

        .advanced-content {
            display: none;
            padding-top: 0.5rem;
        }

        .advanced-content.open { display: block; }

        /* Tab Content */
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Mapping List */
        .mapping-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.875rem 1rem;
            background: var(--jf-bg-input);
            border-radius: var(--radius);
            margin-bottom: 0.5rem;
        }

        .mapping-info {
            flex: 1;
            min-width: 0;
        }

        .mapping-path {
            font-size: 0.875rem;
            font-weight: 600;
        }

        .mapping-source {
            font-size: 0.75rem;
            color: var(--jf-text-muted);
        }

        /* Scan Progress */
        .scan-progress {
            padding: 1rem;
            background: var(--jf-bg-input);
            border-radius: var(--radius);
            margin-bottom: 1rem;
        }

        .scan-progress-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }

        .scan-progress-bar {
            height: 6px;
            background: var(--jf-border);
            border-radius: 3px;
            overflow: hidden;
        }

        .scan-progress-fill {
            height: 100%;
            background: var(--jf-gradient);
            transition: width 0.3s;
        }

        /* Selection Bar */
        .selection-bar {
            display: none;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 1rem;
            background: var(--jf-primary);
            border-radius: var(--radius);
            margin-bottom: 1rem;
        }

        .selection-bar.active { display: flex; }

        .selection-bar-text {
            font-weight: 600;
            color: white;
        }

        .selection-bar-actions { display: flex; gap: 0.5rem; }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--jf-text-muted);
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.3;
        }

        .empty-state-title {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--jf-text);
        }

        /* Tooltip */
        [data-tooltip] { position: relative; }

        [data-tooltip]::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            padding: 0.375rem 0.75rem;
            background: var(--jf-text);
            color: var(--jf-bg-dark);
            font-size: 0.75rem;
            font-weight: 500;
            border-radius: 4px;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition);
            pointer-events: none;
            margin-bottom: 0.5rem;
        }

        [data-tooltip]:hover::after {
            opacity: 1;
            visibility: visible;
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb {
            background: var(--jf-border);
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover { background: var(--jf-text-dim); }

        /* Animations */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .pulse { animation: pulse 2s infinite; }

        @keyframes spin { to { transform: rotate(360deg); } }
        .spin { animation: spin 1s linear infinite; }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .toast {
            background: var(--jf-bg-card);
            border: 1px solid var(--jf-border);
            border-radius: var(--radius);
            padding: 1rem 1.25rem;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            animation: slideIn 0.3s ease;
        }

        .toast.success { border-left: 4px solid var(--jf-success); }
        .toast.error { border-left: 4px solid var(--jf-error); }
        .toast.warning { border-left: 4px solid var(--jf-warning); }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Settings Section */
        .settings-section {
            margin-bottom: 1.5rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid var(--jf-border);
        }

        .settings-section:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }

        .settings-section-title {
            font-size: 0.9375rem;
            font-weight: 600;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .settings-section-title span { color: var(--jf-primary); }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <img src="https://raw.githubusercontent.com/jlightner86/jellylooter/main/icon.png" alt="JellyLooter" class="logo-icon" style="background: none;">
                <span class="logo-text">JellyLooter</span>
            </div>
            <div class="header-actions">
                <nav class="nav-tabs">
                    <button class="nav-tab active" data-tab="browse">Browse</button>
                    <button class="nav-tab" data-tab="sync">Sync</button>
                    <button class="nav-tab" data-tab="settings">Settings</button>
                </nav>
                
                <button class="theme-toggle" id="theme-toggle" data-tooltip="Toggle Theme">
                    <span class="theme-icon-light">‚òÄÔ∏è</span>
                    <span class="theme-icon-dark">üåô</span>
                </button>
                
                <a href="https://buymeacoffee.com/friendlymedia" target="_blank" class="btn btn-sm" style="background: #ffdd00; color: #1a1a1a; border-color: #ffdd00;">‚òï Support</a>
                <a href="/changelog" class="btn btn-secondary btn-sm">Changelog</a>
                <a href="/help" class="btn btn-secondary btn-sm">Help</a>
                
                <div class="user-menu">
                    <button class="user-btn" id="user-btn">
                        <span>üë§</span>
                        <span id="username-display">User</span>
                        <span>‚ñº</span>
                    </button>
                    <div class="user-dropdown" id="user-dropdown">
                        <button class="user-dropdown-item" onclick="openModal('password-modal')">Change Password</button>
                        <button class="user-dropdown-item danger" onclick="window.location.href='/logout'">Sign Out</button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-container">
        <!-- Left Column -->
        <div class="left-column">
            <!-- Browse Tab -->
            <div class="tab-content active" id="tab-browse">
                <div class="panel">
                    <div class="panel-header">
                        <h2 class="panel-title">
                            <span class="panel-title-icon">üìÅ</span>
                            Remote Browser
                        </h2>
                        <div style="display: flex; gap: 0.5rem;">
                            <select id="server-select" class="form-input" style="width: auto; min-width: 180px; padding: 0.5rem 1rem;">
                                <option value="">Select Server...</option>
                            </select>
                            <button class="btn btn-secondary btn-sm" id="refresh-btn" data-tooltip="Refresh">üîÑ</button>
                        </div>
                    </div>
                    <div class="panel-body">
                        <div class="selection-bar" id="selection-bar">
                            <span class="selection-bar-text"><span id="selection-count">0</span> items selected</span>
                            <div class="selection-bar-actions">
                                <button class="btn btn-sm" style="background: white; color: var(--jf-primary);" id="download-selected-btn">Download Selected</button>
                                <button class="btn btn-secondary btn-sm" id="clear-selection-btn">Clear</button>
                            </div>
                        </div>
                        
                        <div class="browser-path" id="browser-path">
                            <span class="browser-path-item" data-id="root">üè† Home</span>
                        </div>
                        
                        <div class="browser-container">
                            <div class="browser-grid" id="browser-grid">
                                <div class="empty-state">
                                    <div class="empty-state-icon">üì°</div>
                                    <div class="empty-state-title">Select a Server</div>
                                    <p>Choose a remote server from the dropdown to browse its library.</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Pagination Controls -->
                        <div class="pagination-controls" id="pagination-controls" style="display: none;">
                            <div class="pagination-info">
                                <span id="pagination-info-text">Page 1 of 1</span>
                                <select id="items-per-page" class="form-input" style="width: auto; padding: 0.375rem 0.5rem; margin-left: 1rem;">
                                    <option value="25">25 per page</option>
                                    <option value="50" selected>50 per page</option>
                                    <option value="100">100 per page</option>
                                    <option value="200">200 per page</option>
                                </select>
                            </div>
                            <div class="pagination-buttons">
                                <button class="btn btn-sm" id="page-first" disabled>¬´</button>
                                <button class="btn btn-sm" id="page-prev" disabled>‚Äπ</button>
                                <span id="page-numbers"></span>
                                <button class="btn btn-sm" id="page-next" disabled>‚Ä∫</button>
                                <button class="btn btn-sm" id="page-last" disabled>¬ª</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sync Tab -->
            <div class="tab-content" id="tab-sync">
                <div class="panel">
                    <div class="panel-header">
                        <h2 class="panel-title">
                            <span class="panel-title-icon">üîÑ</span>
                            Library Mappings
                        </h2>
                        <button class="btn btn-primary btn-sm" id="add-mapping-btn">+ Add Mapping</button>
                    </div>
                    <div class="panel-body">
                        <div id="mappings-list">
                            <div class="empty-state">
                                <div class="empty-state-icon">üó∫Ô∏è</div>
                                <div class="empty-state-title">No Mappings</div>
                                <p>Create a mapping to automatically sync content from remote libraries.</p>
                            </div>
                        </div>
                        
                        <div class="control-bar">
                            <button class="btn btn-primary" id="sync-now-btn">
                                <span>üîÑ</span> Sync Now
                            </button>
                            <div class="toggle-container" style="flex: 1; justify-content: flex-end;">
                                <span class="toggle-label">Auto-Sync</span>
                                <label class="toggle" style="margin-left: 0.75rem;">
                                    <input type="checkbox" id="auto-sync-toggle" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings Tab -->
            <div class="tab-content" id="tab-settings">
                <div class="panel">
                    <div class="panel-header">
                        <h2 class="panel-title">
                            <span class="panel-title-icon">‚öôÔ∏è</span>
                            Configuration
                        </h2>
                    </div>
                    <div class="panel-body">
                        <!-- Appearance Section -->
                        <div class="settings-section">
                            <div class="settings-section-title"><span>üé®</span> Appearance</div>
                            <div class="toggle-container">
                                <span class="toggle-label">Dark Theme</span>
                                <label class="toggle">
                                    <input type="checkbox" id="theme-toggle-settings" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            <div class="form-hint">Switch between dark and light themes</div>
                        </div>

                        <!-- Remote Servers Section -->
                        <div class="settings-section">
                            <div class="settings-section-title"><span>üì°</span> Remote Servers</div>
                            <div class="server-list" id="settings-server-list"></div>
                            <button class="btn btn-primary" style="width: 100%; margin-top: 0.75rem;" id="add-server-btn">
                                + Add Remote Server
                            </button>
                        </div>

                        <!-- Local Server Section -->
                        <div class="settings-section">
                            <div class="settings-section-title"><span>üè†</span> Local Server (Duplicate Detection)</div>
                            <div id="local-server-info">
                                <div class="empty-state" style="padding: 1.5rem;">
                                    <p>No local server configured. Add one to detect existing content.</p>
                                    <button class="btn btn-secondary btn-sm" style="margin-top: 0.75rem;" id="add-local-btn">Configure Local Server</button>
                                </div>
                            </div>
                        </div>

                        <!-- Advanced Settings -->
                        <button class="advanced-toggle" id="advanced-toggle">
                            <span class="advanced-toggle-icon">‚ñº</span>
                            Advanced Settings
                        </button>
                        <div class="advanced-content" id="advanced-content">
                            <div class="form-group">
                                <label class="form-label">Speed Limit (KB/s)</label>
                                <input type="number" class="form-input" id="speed-limit" min="0" placeholder="0 = unlimited">
                                <div class="form-hint">Set to 0 for unlimited speed</div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Sync Time</label>
                                    <input type="time" class="form-input" id="sync-time" value="04:00">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Max Downloads</label>
                                    <input type="number" class="form-input" id="max-downloads" min="1" max="10" value="2">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Connection Timeout (s)</label>
                                    <input type="number" class="form-input" id="connection-timeout" min="5" max="120" value="30">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Chunk Size (KB)</label>
                                    <input type="number" class="form-input" id="chunk-size" min="16" max="1024" value="64">
                                </div>
                            </div>
                            <div class="toggle-container">
                                <span class="toggle-label">Confirm before downloading</span>
                                <label class="toggle">
                                    <input type="checkbox" id="confirm-downloads">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            <div class="toggle-container">
                                <span class="toggle-label">Show notifications</span>
                                <label class="toggle">
                                    <input type="checkbox" id="show-notifications" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            <button class="btn btn-primary" style="width: 100%; margin-top: 1rem;" id="save-settings-btn">Save Settings</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column -->
        <div class="right-column">
            <!-- Stats -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="stat-active">0</div>
                    <div class="stat-label">Active</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="stat-pending">0</div>
                    <div class="stat-label">Pending</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="stat-cached">0</div>
                    <div class="stat-label">Cached</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="stat-cache-time">Never</div>
                    <div class="stat-label">Last Scan</div>
                </div>
            </div>

            <!-- Scan Progress -->
            <div class="scan-progress" id="scan-progress" style="display: none;">
                <div class="scan-progress-header">
                    <span>Scanning local library...</span>
                    <span id="scan-percent">0%</span>
                </div>
                <div class="scan-progress-bar">
                    <div class="scan-progress-fill" id="scan-fill" style="width: 0%"></div>
                </div>
            </div>

            <!-- Download Queue -->
            <div class="panel">
                <div class="panel-header">
                    <h2 class="panel-title">
                        <span class="panel-title-icon">‚¨áÔ∏è</span>
                        Downloads
                    </h2>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-secondary btn-sm" id="pause-btn" data-tooltip="Pause All">‚è∏Ô∏è</button>
                        <button class="btn btn-secondary btn-sm" id="resume-btn" style="display: none;" data-tooltip="Resume All">‚ñ∂Ô∏è</button>
                        <button class="btn btn-danger btn-sm" id="cancel-all-btn" data-tooltip="Cancel All">‚èπÔ∏è</button>
                    </div>
                </div>
                <div class="panel-body">
                    <div class="queue-container" id="download-queue">
                        <div class="queue-empty">
                            <div class="queue-empty-icon">üì≠</div>
                            <p>No active downloads</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Log Panel -->
            <div class="panel" style="margin-top: 1rem;">
                <div class="panel-header">
                    <h2 class="panel-title">
                        <span class="panel-title-icon">üìã</span>
                        Activity Log
                    </h2>
                    <button class="btn btn-secondary btn-sm" id="rebuild-cache-btn">üîÑ Rebuild Cache</button>
                </div>
                <div class="panel-body" style="padding: 0;">
                    <div class="log-container" id="log-container">
                        <div class="log-line">Waiting for activity...</div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>

    <!-- Modals -->
    <!-- Server Modal -->
    <div class="modal" id="server-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add Remote Server</h3>
                <button class="modal-close" onclick="closeModal('server-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Server Name</label>
                    <input type="text" class="form-input" id="server-name" placeholder="My Jellyfin Server">
                </div>
                <div class="form-group">
                    <label class="form-label">Server URL</label>
                    <input type="text" class="form-input" id="server-url" placeholder="http://192.168.1.100:8096">
                </div>
                <div class="form-group">
                    <label class="form-label">Authentication Method</label>
                    <select class="form-input" id="auth-method">
                        <option value="key">API Key</option>
                        <option value="creds">Username/Password</option>
                    </select>
                </div>
                <div id="auth-key-fields">
                    <div class="form-group">
                        <label class="form-label">API Key</label>
                        <input type="text" class="form-input" id="server-key" placeholder="Enter API key">
                    </div>
                </div>
                <div id="auth-creds-fields" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">Username</label>
                        <input type="text" class="form-input" id="server-username" placeholder="Username">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <input type="password" class="form-input" id="server-password" placeholder="Password">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('server-modal')">Cancel</button>
                <button class="btn btn-secondary" onclick="testServerConnection()">Test Connection</button>
                <button class="btn btn-primary" onclick="saveServer()">Add Server</button>
            </div>
        </div>
    </div>

    <!-- Local Server Modal -->
    <div class="modal" id="local-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Configure Local Server</h3>
                <button class="modal-close" onclick="closeModal('local-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Server URL</label>
                    <input type="text" class="form-input" id="local-server-url" placeholder="http://localhost:8096">
                </div>
                <div class="form-group">
                    <label class="form-label">API Key</label>
                    <input type="text" class="form-input" id="local-server-key" placeholder="Enter API key">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('local-modal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveLocalServer()">Save & Scan</button>
            </div>
        </div>
    </div>

    <!-- Download Path Modal -->
    <div class="modal" id="path-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Select Download Location</h3>
                <button class="modal-close" onclick="closeModal('path-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="browser-path" id="local-path-display">/storage</div>
                <div id="local-folder-list" style="max-height: 300px; overflow-y: auto;"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('path-modal')">Cancel</button>
                <button class="btn btn-primary" onclick="confirmDownloadPath()">Download Here</button>
            </div>
        </div>
    </div>

    <!-- Mapping Modal -->
    <div class="modal" id="mapping-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add Library Mapping</h3>
                <button class="modal-close" onclick="closeModal('mapping-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Remote Server</label>
                    <select class="form-input" id="mapping-server"></select>
                </div>
                <div class="form-group">
                    <label class="form-label">Remote Library</label>
                    <select class="form-input" id="mapping-library"></select>
                </div>
                <div class="form-group">
                    <label class="form-label">Local Path</label>
                    <input type="text" class="form-input" id="mapping-path" placeholder="/storage/media">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('mapping-modal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveMapping()">Add Mapping</button>
            </div>
        </div>
    </div>

    <!-- Password Change Modal -->
    <div class="modal" id="password-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Change Password</h3>
                <button class="modal-close" onclick="closeModal('password-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Current Password</label>
                    <input type="password" class="form-input" id="current-password" placeholder="Enter current password">
                </div>
                <div class="form-group">
                    <label class="form-label">New Password</label>
                    <input type="password" class="form-input" id="new-password" placeholder="Enter new password">
                </div>
                <div class="form-group">
                    <label class="form-label">Confirm New Password</label>
                    <input type="password" class="form-input" id="confirm-new-password" placeholder="Confirm new password">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('password-modal')">Cancel</button>
                <button class="btn btn-primary" onclick="changePassword()">Change Password</button>
            </div>
        </div>
    </div>

    <script>
        // State
        let config = {};
        let currentServerId = null;
        let currentParentId = 'root';
        let browserPath = [{ id: 'root', name: 'üè† Home' }];
        let selectedItems = new Set();
        let pendingDownloadPath = '/storage';
        let baseUrl = '';
        
        // Pagination state
        let currentPage = 1;
        let totalPages = 1;
        let itemsPerPage = 50;
        let totalItems = 0;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadConfig();
            loadUser();
            initTheme();
            setupEventListeners();
            startStatusPolling();
            startLogPolling();
        });

        // Theme Management
        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || config.theme || 'dark';
            setTheme(savedTheme);
        }

        function setTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
            document.getElementById('theme-toggle-settings').checked = theme === 'dark';
        }

        function toggleTheme() {
            const current = document.documentElement.getAttribute('data-theme');
            const newTheme = current === 'dark' ? 'light' : 'dark';
            setTheme(newTheme);
            config.theme = newTheme;
            api('config', 'POST', config);
        }

        // API Helper
        async function api(endpoint, method = 'GET', body = null) {
            const options = {
                method,
                headers: { 'Content-Type': 'application/json' }
            };
            if (body) options.body = JSON.stringify(body);
            
            const res = await fetch(`/api/${endpoint}`, options);
            if (res.status === 401) {
                window.location.href = '/login';
                return;
            }
            
            const contentType = res.headers.get('content-type');
            if (contentType && contentType.includes('application/json')) {
                return res.json();
            }
            return res.text();
        }

        // Toast Notifications
        function showToast(message, type = 'success') {
            if (!config.show_notifications) return;
            
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <span>${type === 'success' ? '‚úì' : type === 'error' ? '‚úó' : '‚ö†'}</span>
                <span>${message}</span>
            `;
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }

        // User Management
        async function loadUser() {
            const user = await api('user');
            if (user && user.username) {
                document.getElementById('username-display').textContent = user.username;
            }
        }

        async function changePassword() {
            const current = document.getElementById('current-password').value;
            const newPwd = document.getElementById('new-password').value;
            const confirm = document.getElementById('confirm-new-password').value;
            
            if (newPwd !== confirm) {
                showToast('Passwords do not match', 'error');
                return;
            }
            
            if (newPwd.length < 8) {
                showToast('Password must be at least 8 characters', 'error');
                return;
            }
            
            const result = await api('change_password', 'POST', {
                current_password: current,
                new_password: newPwd
            });
            
            if (result.status === 'ok') {
                showToast('Password changed successfully');
                closeModal('password-modal');
                document.getElementById('current-password').value = '';
                document.getElementById('new-password').value = '';
                document.getElementById('confirm-new-password').value = '';
            } else {
                showToast(result.message || 'Failed to change password', 'error');
            }
        }

        // Config Management
        async function loadConfig() {
            config = await api('config');
            updateServerSelect();
            updateSettingsForm();
            updateServerList();
            updateLocalServerInfo();
            updateMappingsList();
        }

        function updateServerSelect() {
            const select = document.getElementById('server-select');
            select.innerHTML = '<option value="">Select Server...</option>';
            
            (config.servers || []).forEach(server => {
                const opt = document.createElement('option');
                opt.value = server.id;
                opt.textContent = server.name;
                select.appendChild(opt);
            });
        }

        function updateServerList() {
            const container = document.getElementById('settings-server-list');
            if (!config.servers || config.servers.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="padding: 1.5rem;">
                        <p>No remote servers configured yet.</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = config.servers.map(server => `
                <div class="server-item">
                    <div class="server-icon">üì°</div>
                    <div class="server-info">
                        <div class="server-name">${escapeHtml(server.name)}</div>
                        <div class="server-url">${escapeHtml(server.url)}</div>
                    </div>
                    <button class="btn btn-icon btn-sm btn-danger" onclick="removeServer('${server.id}')" data-tooltip="Remove">üóëÔ∏è</button>
                </div>
            `).join('');
        }

        async function removeServer(id) {
            if (!confirm('Remove this server?')) return;
            config.servers = config.servers.filter(s => s.id !== id);
            await api('config', 'POST', config);
            loadConfig();
            showToast('Server removed');
        }

        function updateLocalServerInfo() {
            const container = document.getElementById('local-server-info');
            if (config.local_server_url) {
                container.innerHTML = `
                    <div class="server-item">
                        <div class="server-icon" style="background: var(--jf-success);">‚úì</div>
                        <div class="server-info">
                            <div class="server-name">Local Server</div>
                            <div class="server-url">${escapeHtml(config.local_server_url)}</div>
                        </div>
                        <button class="btn btn-icon btn-sm btn-danger" id="remove-local-btn" data-tooltip="Remove">üóëÔ∏è</button>
                    </div>
                `;
                document.getElementById('remove-local-btn').addEventListener('click', async () => {
                    if (confirm('Remove local server?')) {
                        await api('remove_local', 'POST');
                        loadConfig();
                        showToast('Local server removed');
                    }
                });
            } else {
                container.innerHTML = `
                    <div class="empty-state" style="padding: 1.5rem;">
                        <p>No local server configured.</p>
                        <button class="btn btn-secondary btn-sm" style="margin-top: 0.75rem;" id="add-local-btn">Configure Local Server</button>
                    </div>
                `;
                document.getElementById('add-local-btn').addEventListener('click', () => openModal('local-modal'));
            }
        }

        async function saveLocalServer() {
            const url = document.getElementById('local-server-url').value;
            const key = document.getElementById('local-server-key').value;

            if (!url || !key) {
                showToast('Please fill in all fields', 'error');
                return;
            }

            config.local_server_url = url;
            config.local_server_key = key;
            await api('config', 'POST', config);
            await api('rebuild_cache', 'POST');
            closeModal('local-modal');
            loadConfig();
            showToast('Local server configured, scanning...');
        }

        function updateSettingsForm() {
            document.getElementById('speed-limit').value = config.speed_limit_kbs || 0;
            document.getElementById('sync-time').value = config.sync_time || '04:00';
            document.getElementById('max-downloads').value = config.max_concurrent_downloads || 2;
            document.getElementById('auto-sync-toggle').checked = config.auto_sync_enabled !== false;
            document.getElementById('connection-timeout').value = config.connection_timeout || 30;
            document.getElementById('chunk-size').value = config.chunk_size_kb || 64;
            document.getElementById('confirm-downloads').checked = config.confirm_downloads || false;
            document.getElementById('show-notifications').checked = config.show_notifications !== false;
            document.getElementById('theme-toggle-settings').checked = (config.theme || 'dark') === 'dark';
        }

        async function saveSettings() {
            config.speed_limit_kbs = parseInt(document.getElementById('speed-limit').value) || 0;
            config.sync_time = document.getElementById('sync-time').value || '04:00';
            config.max_concurrent_downloads = parseInt(document.getElementById('max-downloads').value) || 2;
            config.connection_timeout = parseInt(document.getElementById('connection-timeout').value) || 30;
            config.chunk_size_kb = parseInt(document.getElementById('chunk-size').value) || 64;
            config.confirm_downloads = document.getElementById('confirm-downloads').checked;
            config.show_notifications = document.getElementById('show-notifications').checked;
            await api('config', 'POST', config);
            showToast('Settings saved');
        }

        // Mappings
        function updateMappingsList() {
            const container = document.getElementById('mappings-list');
            if (!config.mappings || config.mappings.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üó∫Ô∏è</div>
                        <div class="empty-state-title">No Mappings</div>
                        <p>Create a mapping to automatically sync content.</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = config.mappings.map(m => {
                const server = config.servers.find(s => s.id === m.server_id);
                return `
                    <div class="mapping-item">
                        <div class="mapping-info">
                            <div class="mapping-path">${escapeHtml(m.local_path)}</div>
                            <div class="mapping-source">${server ? escapeHtml(server.name) : 'Unknown'} ‚Üí ${m.lib_name || 'Library'}</div>
                        </div>
                        <button class="btn btn-icon btn-sm btn-danger" onclick="removeMapping('${m.id}')" data-tooltip="Remove">üóëÔ∏è</button>
                    </div>
                `;
            }).join('');
        }

        async function removeMapping(id) {
            if (!confirm('Remove this mapping?')) return;
            config.mappings = config.mappings.filter(m => m.id !== id);
            await api('config', 'POST', config);
            loadConfig();
            showToast('Mapping removed');
        }

        // Event Listeners
        function setupEventListeners() {
            // Theme toggle
            document.getElementById('theme-toggle').addEventListener('click', toggleTheme);
            document.getElementById('theme-toggle-settings').addEventListener('change', (e) => {
                setTheme(e.target.checked ? 'dark' : 'light');
                config.theme = e.target.checked ? 'dark' : 'light';
                api('config', 'POST', config);
            });

            // User dropdown
            document.getElementById('user-btn').addEventListener('click', () => {
                document.getElementById('user-dropdown').classList.toggle('active');
            });

            document.addEventListener('click', (e) => {
                if (!e.target.closest('.user-menu')) {
                    document.getElementById('user-dropdown').classList.remove('active');
                }
            });

            // Navigation tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    tab.classList.add('active');
                    document.getElementById(`tab-${tab.dataset.tab}`).classList.add('active');
                });
            });

            // Server select
            document.getElementById('server-select').addEventListener('change', (e) => {
                currentServerId = e.target.value;
                if (currentServerId) {
                    currentParentId = 'root';
                    currentPage = 1;
                    browserPath = [{ id: 'root', name: 'üè† Home' }];
                    browseRemote();
                }
            });

            // Refresh button
            document.getElementById('refresh-btn').addEventListener('click', browseRemote);
            
            // Pagination controls
            setupPaginationListeners();

            // Download controls
            document.getElementById('pause-btn').addEventListener('click', () => api('pause', 'POST'));
            document.getElementById('resume-btn').addEventListener('click', () => api('resume', 'POST'));
            document.getElementById('cancel-all-btn').addEventListener('click', () => {
                if (confirm('Cancel all downloads?')) api('cancel', 'POST', { all: true });
            });

            // Selection controls
            document.getElementById('download-selected-btn').addEventListener('click', () => {
                if (selectedItems.size > 0) {
                    openPathModal();
                }
            });
            document.getElementById('clear-selection-btn').addEventListener('click', clearSelection);

            // Add server button
            document.getElementById('add-server-btn').addEventListener('click', () => openModal('server-modal'));

            // Auth method toggle
            document.getElementById('auth-method').addEventListener('change', (e) => {
                document.getElementById('auth-key-fields').style.display = e.target.value === 'key' ? 'block' : 'none';
                document.getElementById('auth-creds-fields').style.display = e.target.value === 'creds' ? 'block' : 'none';
            });

            // Save settings
            document.getElementById('save-settings-btn').addEventListener('click', saveSettings);

            // Advanced toggle
            document.getElementById('advanced-toggle').addEventListener('click', () => {
                document.getElementById('advanced-toggle').classList.toggle('open');
                document.getElementById('advanced-content').classList.toggle('open');
            });

            // Sync controls
            document.getElementById('sync-now-btn').addEventListener('click', () => {
                api('sync', 'POST');
                showToast('Sync started');
            });

            document.getElementById('auto-sync-toggle').addEventListener('change', async (e) => {
                config.auto_sync_enabled = e.target.checked;
                await api('config', 'POST', config);
            });

            // Add mapping button
            document.getElementById('add-mapping-btn').addEventListener('click', openMappingModal);

            // Rebuild cache
            document.getElementById('rebuild-cache-btn').addEventListener('click', () => {
                api('rebuild_cache', 'POST');
                showToast('Cache rebuild started');
            });
        }

        // Remote Browser
        async function browseRemote() {
            if (!currentServerId) return;

            const grid = document.getElementById('browser-grid');
            grid.innerHTML = '<div class="empty-state"><div class="spin">üîÑ</div><p>Loading...</p></div>';

            const data = await api('browse_remote', 'POST', {
                server_id: currentServerId,
                parent_id: currentParentId,
                page: currentPage,
                items_per_page: itemsPerPage
            });

            baseUrl = data.base_url;
            totalItems = data.total || 0;
            totalPages = data.total_pages || 1;
            
            renderBrowserItems(data.items);
            renderBrowserPath();
            renderPagination();
        }
        
        function renderPagination() {
            const controls = document.getElementById('pagination-controls');
            const infoText = document.getElementById('pagination-info-text');
            const pageNumbers = document.getElementById('page-numbers');
            
            // Only show pagination if we have more than one page or if not at root
            if (totalPages <= 1 && currentParentId === 'root') {
                controls.style.display = 'none';
                return;
            }
            
            controls.style.display = 'flex';
            
            const startItem = (currentPage - 1) * itemsPerPage + 1;
            const endItem = Math.min(currentPage * itemsPerPage, totalItems);
            infoText.textContent = totalItems > 0 
                ? `Showing ${startItem}-${endItem} of ${totalItems} items (Page ${currentPage}/${totalPages})`
                : `Page ${currentPage} of ${totalPages}`;
            
            // Update button states
            document.getElementById('page-first').disabled = currentPage <= 1;
            document.getElementById('page-prev').disabled = currentPage <= 1;
            document.getElementById('page-next').disabled = currentPage >= totalPages;
            document.getElementById('page-last').disabled = currentPage >= totalPages;
            
            // Render page numbers
            let html = '';
            const maxPages = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxPages / 2));
            let endPage = Math.min(totalPages, startPage + maxPages - 1);
            
            if (endPage - startPage < maxPages - 1) {
                startPage = Math.max(1, endPage - maxPages + 1);
            }
            
            for (let i = startPage; i <= endPage; i++) {
                html += `<button class="page-number ${i === currentPage ? 'active' : ''}" onclick="goToPage(${i})">${i}</button>`;
            }
            pageNumbers.innerHTML = html;
        }
        
        function goToPage(page) {
            if (page < 1 || page > totalPages || page === currentPage) return;
            currentPage = page;
            browseRemote();
        }
        
        function setupPaginationListeners() {
            document.getElementById('page-first').onclick = () => goToPage(1);
            document.getElementById('page-prev').onclick = () => goToPage(currentPage - 1);
            document.getElementById('page-next').onclick = () => goToPage(currentPage + 1);
            document.getElementById('page-last').onclick = () => goToPage(totalPages);
            
            document.getElementById('items-per-page').onchange = (e) => {
                itemsPerPage = parseInt(e.target.value);
                currentPage = 1;
                browseRemote();
            };
        }

        function renderBrowserItems(items) {
            const grid = document.getElementById('browser-grid');
            
            if (!items || items.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìÇ</div>
                        <div class="empty-state-title">Empty Folder</div>
                        <p>No items found in this location.</p>
                    </div>
                `;
                return;
            }

            grid.innerHTML = items.map(item => {
                const icon = item.IsFolder ? 'üìÅ' : (item.Type === 'Movie' ? 'üé¨' : 'üì∫');
                // Use Primary image with proper width for poster aspect ratio
                const imgSrc = item.HasImage ? `${baseUrl}/Items/${item.Id}/Images/Primary?maxWidth=200&quality=90` : '';
                const classes = ['browser-item'];
                if (item.IsFolder) classes.push('folder');
                if (item.ExistsLocally) classes.push('exists');
                if (selectedItems.has(item.Id)) classes.push('selected');

                return `
                    <div class="${classes.join(' ')}" 
                         data-id="${item.Id}" 
                         data-name="${escapeHtml(item.Name)}"
                         data-folder="${item.IsFolder}"
                         onclick="handleItemClick(event, '${item.Id}', ${item.IsFolder}, '${escapeHtml(item.Name)}')"
                         oncontextmenu="handleItemContext(event, '${item.Id}')">
                        ${imgSrc ? 
                            `<img class="browser-item-poster" src="${imgSrc}" loading="lazy" alt="" onerror="this.parentElement.innerHTML='<div class=browser-item-placeholder>${icon}</div><div class=browser-item-title>${escapeHtml(item.Name)}</div>'">` :
                            `<div class="browser-item-placeholder">${icon}</div>`
                        }
                        <div class="browser-item-title">${escapeHtml(item.Name)}</div>
                    </div>
                `;
            }).join('');
        }

        function handleItemClick(e, id, isFolder, name) {
            if (e.ctrlKey || e.metaKey) {
                toggleSelection(id);
            } else if (isFolder) {
                navigateTo(id, name);
            } else {
                toggleSelection(id);
            }
        }

        function handleItemContext(e, id) {
            e.preventDefault();
            toggleSelection(id);
        }

        function toggleSelection(id) {
            if (selectedItems.has(id)) {
                selectedItems.delete(id);
            } else {
                selectedItems.add(id);
            }
            updateSelectionUI();
        }

        function updateSelectionUI() {
            document.querySelectorAll('.browser-item').forEach(el => {
                el.classList.toggle('selected', selectedItems.has(el.dataset.id));
            });

            const bar = document.getElementById('selection-bar');
            const count = document.getElementById('selection-count');
            
            if (selectedItems.size > 0) {
                bar.classList.add('active');
                count.textContent = selectedItems.size;
            } else {
                bar.classList.remove('active');
            }
        }

        function clearSelection() {
            selectedItems.clear();
            updateSelectionUI();
        }

        function navigateTo(id, name) {
            currentParentId = id;
            currentPage = 1;
            browserPath.push({ id, name });
            clearSelection();
            browseRemote();
        }

        function navigateToPath(index) {
            browserPath = browserPath.slice(0, index + 1);
            currentParentId = browserPath[browserPath.length - 1].id;
            currentPage = 1;
            clearSelection();
            browseRemote();
        }

        function renderBrowserPath() {
            const container = document.getElementById('browser-path');
            container.innerHTML = browserPath.map((item, i) => 
                `<span class="browser-path-item" onclick="navigateToPath(${i})">${escapeHtml(item.name)}</span>` +
                (i < browserPath.length - 1 ? '<span>/</span>' : '')
            ).join('');
        }

        // Download Path Selection
        async function openPathModal() {
            openModal('path-modal');
            pendingDownloadPath = '/storage';
            browseLocalPath('/storage');
        }

        async function browseLocalPath(path) {
            const data = await api('browse_local', 'POST', { path });
            pendingDownloadPath = data.current;
            document.getElementById('local-path-display').textContent = data.current;

            const list = document.getElementById('local-folder-list');
            let html = '';

            if (data.parent) {
                html += `<div class="server-item" onclick="browseLocalPath('${data.parent}')">
                    <div class="server-icon">‚¨ÜÔ∏è</div>
                    <div class="server-info"><div class="server-name">..</div></div>
                </div>`;
            }

            data.folders.forEach(folder => {
                html += `<div class="server-item" onclick="browseLocalPath('${data.current}/${folder}')">
                    <div class="server-icon">üìÅ</div>
                    <div class="server-info"><div class="server-name">${escapeHtml(folder)}</div></div>
                </div>`;
            });

            list.innerHTML = html || '<div class="empty-state" style="padding: 1rem;"><p>No subfolders</p></div>';
        }

        async function confirmDownloadPath() {
            if (config.confirm_downloads) {
                if (!confirm(`Download ${selectedItems.size} item(s) to ${pendingDownloadPath}?`)) {
                    return;
                }
            }

            await api('batch_download', 'POST', {
                server_id: currentServerId,
                item_ids: Array.from(selectedItems),
                path: pendingDownloadPath
            });

            closeModal('path-modal');
            clearSelection();
            showToast(`Queued ${selectedItems.size} item(s) for download`);
        }

        // Server Management
        async function testServerConnection() {
            const url = document.getElementById('server-url').value;
            const method = document.getElementById('auth-method').value;
            
            let payload = { url };
            if (method === 'key') {
                payload.key = document.getElementById('server-key').value;
            } else {
                payload.username = document.getElementById('server-username').value;
                payload.password = document.getElementById('server-password').value;
            }

            const result = await api('test_connection', 'POST', payload);
            if (result.status === 'ok') {
                showToast('Connection successful!');
                // Store the token and user_id
                document.getElementById('server-key').value = result.key;
                document.getElementById('server-key').dataset.tested = 'true';
                if (result.user_id) {
                    document.getElementById('server-key').dataset.userId = result.user_id;
                }
            } else {
                showToast(result.error || 'Connection failed', 'error');
            }
        }

        async function saveServer() {
            const name = document.getElementById('server-name').value;
            const url = document.getElementById('server-url').value;
            const key = document.getElementById('server-key').value;
            const userId = document.getElementById('server-key').dataset.userId || null;

            if (!name || !url) {
                showToast('Please fill in server name and URL', 'error');
                return;
            }
            
            if (!key) {
                showToast('Please test connection first to verify credentials', 'error');
                return;
            }

            const server = {
                id: Date.now().toString(36),
                name,
                url: url.replace(/\/$/, ''),
                key,
                user_id: userId  // Store user_id for username/password auth
            };

            if (!config.servers) config.servers = [];
            config.servers.push(server);
            await api('config', 'POST', config);
            closeModal('server-modal');
            loadConfig();
            showToast('Server added');
            
            // Clear form
            document.getElementById('server-name').value = '';
            document.getElementById('server-url').value = '';
            document.getElementById('server-key').value = '';
            document.getElementById('server-key').dataset.userId = '';
        }

        // Mapping Management
        async function openMappingModal() {
            const serverSelect = document.getElementById('mapping-server');
            serverSelect.innerHTML = '<option value="">Select Server...</option>' +
                (config.servers || []).map(s => `<option value="${s.id}">${escapeHtml(s.name)}</option>`).join('');

            serverSelect.onchange = async () => {
                const libs = await api('scan_libs');
                const serverLibs = libs.find(l => l.server_id === serverSelect.value);
                const libSelect = document.getElementById('mapping-library');
                
                if (serverLibs) {
                    libSelect.innerHTML = serverLibs.libs.map(l => 
                        `<option value="${l.Id}" data-name="${escapeHtml(l.Name)}">${escapeHtml(l.Name)}</option>`
                    ).join('');
                }
            };

            openModal('mapping-modal');
        }

        async function saveMapping() {
            const serverId = document.getElementById('mapping-server').value;
            const libSelect = document.getElementById('mapping-library');
            const libId = libSelect.value;
            const libName = libSelect.options[libSelect.selectedIndex]?.dataset.name;
            const path = document.getElementById('mapping-path').value;

            if (!serverId || !libId || !path) {
                showToast('Please fill in all fields', 'error');
                return;
            }

            const mapping = {
                id: Date.now().toString(36),
                server_id: serverId,
                lib_id: libId,
                lib_name: libName,
                local_path: path
            };

            if (!config.mappings) config.mappings = [];
            config.mappings.push(mapping);
            await api('config', 'POST', config);
            closeModal('mapping-modal');
            loadConfig();
            showToast('Mapping added');
        }

        // Status Polling
        function startStatusPolling() {
            async function poll() {
                try {
                    const status = await api('status');
                    updateDownloadQueue(status);
                    updateStats(status);
                    updateScanProgress(status.scan_progress);

                    document.getElementById('pause-btn').style.display = status.paused ? 'none' : 'flex';
                    document.getElementById('resume-btn').style.display = status.paused ? 'flex' : 'none';
                } catch (err) {
                    console.error('Status poll error:', err);
                }
            }
            poll();
            setInterval(poll, 1000);
        }

        function updateDownloadQueue(status) {
            const container = document.getElementById('download-queue');
            const active = Object.values(status.active || {});
            const pending = status.pending || [];

            if (active.length === 0 && pending.length === 0) {
                container.innerHTML = '<div class="queue-empty"><div class="queue-empty-icon">üì≠</div><p>No active downloads</p></div>';
                return;
            }

            container.innerHTML = [
                ...active.map(d => `
                    <div class="download-item">
                        <div class="download-header">
                            <span class="download-name" title="${escapeHtml(d.filename)}">${escapeHtml(d.filename)}</span>
                            <span class="download-status ${d.status === 'Paused' ? 'paused' : ''}">${d.status}</span>
                        </div>
                        <div class="download-progress">
                            <div class="download-progress-bar" style="width: ${d.percent}%"></div>
                        </div>
                        <div class="download-meta">
                            <span>${d.speed}</span>
                            <span>${d.percent}%</span>
                        </div>
                    </div>
                `),
                ...pending.map(p => `
                    <div class="download-item">
                        <div class="download-header">
                            <span class="download-name" title="${escapeHtml(p.name)}">${escapeHtml(p.name)}</span>
                            <span class="download-status pending">Pending</span>
                        </div>
                    </div>
                `)
            ].join('');
        }

        function updateStats(status) {
            document.getElementById('stat-active').textContent = Object.keys(status.active || {}).length;
            document.getElementById('stat-pending').textContent = (status.pending || []).length + (status.queue_size || 0);
            document.getElementById('stat-cached').textContent = status.cache_count || 0;
            document.getElementById('stat-cache-time').textContent = status.cache_time || 'Never';
        }

        function updateScanProgress(scan) {
            const container = document.getElementById('scan-progress');
            if (scan && scan.running) {
                container.style.display = 'block';
                document.getElementById('scan-percent').textContent = `${scan.percent}%`;
                document.getElementById('scan-fill').style.width = `${scan.percent}%`;
            } else {
                container.style.display = 'none';
            }
        }

        // Log Polling
        function startLogPolling() {
            async function poll() {
                try {
                    const res = await fetch('/api/logs');
                    const text = await res.text();
                    const container = document.getElementById('log-container');
                    
                    if (text.trim()) {
                        container.innerHTML = text.split('\n').map(line => {
                            let cls = '';
                            if (line.includes('‚úì') || line.includes('Complete')) cls = 'success';
                            if (line.includes('‚úó') || line.includes('Error') || line.includes('Failed')) cls = 'error';
                            return `<div class="log-line"><span class="${cls}">${escapeHtml(line)}</span></div>`;
                        }).join('');
                    }
                } catch (err) {
                    console.error('Log poll error:', err);
                }
            }
            poll();
            setInterval(poll, 2000);
        }

        // Modal Helpers
        function openModal(id) {
            document.getElementById(id).classList.add('active');
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }

        // Utility
        function escapeHtml(str) {
            if (!str) return '';
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }
    </script>
</body>
</html>
